# Milestone v1.1: Architecture Refactor

**Status:** SHIPPED 2026-01-21
**Phases:** 8-13
**Total Plans:** 13

## Overview

Solidify codebase foundation before adding new gameplay features. Fix memory leaks, split large files, centralize state management, expand test coverage.

**Success Criteria (all achieved):**
- No files over 400 lines
- All hard-coded values in constants.ts
- GameEngine.tick() under 50 lines (22 lines achieved)
- Test coverage for coordinate transforms and minigames
- Event-based communication replaces prop drilling

## Phases

### Phase 8: Quick Wins & Memory Fixes

**Goal**: Fix critical issues with minimal risk - memory leaks, hard-coded values, memoization
**Depends on**: v1.0 complete
**Plans**: 1 plan

Plans:
- [x] 08-01: Quick Wins & Memory Fixes (all tasks in single plan)

**Details:**
- Fixed rotationTimestamps memory leak (circular buffer)
- Created complicationConfig.ts (centralized configuration)
- Extracted coordinateTransform.ts (testable pure functions)
- Added 16 coordinate transform tests

### Phase 9: Art.tsx Decomposition

**Goal**: Split 1,478-line Art.tsx into focused minigame components
**Depends on**: Phase 8
**Plans**: 3 plans

Plans:
- [x] 09-01: Extract minigame type definitions and LASER hook
- [x] 09-02: Extract LIGHTS and CONTROLS hooks + panel components
- [x] 09-03: Integrate all hooks and panels into Art.tsx

**Details:**
- Art.tsx reduced from 1,478 to 581 lines (61% reduction)
- Created 3 minigame hooks (useLaserMinigame, useLightsMinigame, useControlsMinigame)
- Created 4 panel components (LaserPanel, LightsPanel, ControlsPanel, ArcadeButton)
- Created types/minigames.ts for shared type definitions

### Phase 10: GameBoard.tsx Decomposition

**Goal**: Split 1,031-line GameBoard.tsx into focused modules
**Depends on**: Phase 9
**Plans**: 3 plans

Plans:
- [x] 10-01: Extract useInputHandlers hook (~246 lines extracted)
- [x] 10-02: Extract goop rendering utilities (~131 lines extracted)
- [x] 10-03: Extract CSS, final cleanup + UAT bug fixes

**Details:**
- GameBoard.tsx reduced from 1,031 to 604 lines (41% reduction)
- Extracted useInputHandlers.ts for all input handling
- Extracted goopRenderer.ts for SVG path generation
- Created GameBoard.css for animation styles
- Fixed 3 UAT bugs found during verification

### Phase 11: GameEngine Refactor

**Goal**: Split GameEngine.tick() and extract focused managers
**Depends on**: Phase 10
**Plans**: 2 plans

Plans:
- [x] 11-01: Split tick() into focused methods (22 lines achieved)
- [x] 11-02: Extract ComplicationManager and GoalManager

**Details:**
- GameEngine.tick() reduced from 159 to 22 lines (86% reduction)
- Created ComplicationManager.ts (178 lines) for complication logic
- Created GoalManager.ts (96 lines) for goal handling
- GameEngine.ts reduced from 811 to 576 lines overall

### Phase 12: State Management & Events

**Goal**: Centralize state and expand event system to reduce prop drilling
**Depends on**: Phase 11
**Plans**: 2 plans

Plans:
- [x] 12-01: Input Events & Prop Drilling Reduction
- [x] 12-02: State Management Interface & Cleanup

**Details:**
- Added 6 input event types to EventBus
- Removed 6 callback props from GameBoard
- Created GameStateManager interface documenting state access
- Fixed R key swap to match touch behavior
- Synced version to 1.1.1 across all displays

### Phase 13: Testing & Documentation

**Goal**: Add test coverage for refactored code and update docs
**Depends on**: Phase 12
**Plans**: 2 plans

Plans:
- [x] 13-01: Test Coverage Expansion (29 tests added: 81 â†’ 110)
- [x] 13-02: Documentation Updates (TESTING.md, ARCHITECTURE.md, STRUCTURE.md)

**Details:**
- Added 27 coordinate transform edge case tests
- Added 18 minigame logic tests
- Updated TESTING.md, ARCHITECTURE.md, STRUCTURE.md for v1.1

---

## Milestone Summary

**Key Decisions:**
- Managers don't own state - they operate on state passed to them
- GameStateManager interface is documentation-first
- All input methods must behave identically (keyboard matches touch)
- CSS media queries for desktop-only effects (instead of JS conditionals)

**Issues Resolved:**
- Memory leak in rotationTimestamps (was ~6000 allocations/session)
- Hard-coded values scattered across files (now in complicationConfig.ts)
- Large files difficult to maintain (Art.tsx, GameBoard.tsx, GameEngine.ts)
- Prop drilling through 10+ callbacks (now uses events)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None - this milestone specifically addressed existing debt

---

*For current project status, see .planning/ROADMAP.md*
