---
phase: 20-expanding-cracks
plan: 20-01-FIX
type: fix
---

<objective>
Fix 1 critical UAT issue from plan 20-01.

Source: 20-01-ISSUES.md
Priority: 1 critical, 0 major, 0 minor

The expanding cracks feature is completely non-functional because `tickGoals()` still uses the old `trySpawnGoal()` method and populates `goalMarks` instead of using the new `trySpawnCrack()` and `crackCells`.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/plans/20-01-ISSUES.md

**Original plan for reference:**
@.planning/plans/20-01-PLAN.md

**Key files:**
@core/GameEngine.ts
@core/GoalManager.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Fix tickGoals to use trySpawnCrack</name>
  <files>core/GameEngine.ts</files>
  <action>
Update `tickGoals()` method (lines ~698-712) to use the new CrackCell system:

1. Change the method call from `trySpawnGoal()` to `trySpawnCrack()`
2. Update the destructuring from `{ goal, ...}` to `{ crack, ...}`
3. Change the push from `this.state.goalMarks.push(goal)` to `this.state.crackCells.push(crack)`
4. Update the null check from `if (goal)` to `if (crack)`

The signature change:
```typescript
// FROM:
const { goal, newLastSpawnTime } = goalManager.trySpawnGoal(...);
if (goal) {
    this.state.goalMarks.push(goal);
}

// TO:
const { crack, newLastSpawnTime } = goalManager.trySpawnCrack(...);
if (crack) {
    this.state.crackCells.push(crack);
}
```

Both methods have identical parameters so no other changes needed.
  </action>
  <verify>
1. Run `npm run test:run` - all tests pass
2. Build succeeds without errors
  </verify>
  <done>
`tickGoals()` uses `trySpawnCrack()` and pushes to `crackCells`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify crack system integration</name>
  <files>core/GameEngine.ts</files>
  <action>
Add temporary debug logging to verify the fix works:

1. In `tickGoals()`, add a console.log when a crack is spawned:
   `console.log('Spawned crack:', crack.id, 'at', crack.x, crack.y, 'crackCells count:', this.state.crackCells.length);`

2. In `tickCrackGrowth()`, add logging at the start:
   `console.log('tickCrackGrowth: processing', this.state.crackCells.length, 'cells');`

3. Also log when a spread attempt succeeds (in the spread success block)

These logs will be removed after verification.
  </action>
  <verify>
Start game at rank 39, observe console output showing:
1. "Spawned crack: [id]" messages when cracks appear
2. "tickCrackGrowth: processing N cells" with N > 0
3. Spread attempt logs when pressure builds
  </verify>
  <done>
Debug logs confirm cracks are being added to crackCells and processed by tickCrackGrowth.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed crack spawning to use new CrackCell system</what-built>
  <how-to-verify>
1. Run: `npm run dev -- --host`
2. Start game at rank 39 (or use debug to set rank)
3. Wait for cracks to spawn
4. Watch console for debug logs showing:
   - "Spawned crack" messages
   - "tickCrackGrowth: processing N cells" with N > 0
5. As timer runs down (pressure builds), observe:
   - Cracks spreading to adjacent cells
   - Connection lines appearing between parent/child cells
6. Verify visual: crack groups grow larger over time
  </how-to-verify>
  <resume-signal>Type "approved" if cracks expand with connection lines, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Remove debug logging</name>
  <files>core/GameEngine.ts</files>
  <action>
Remove all temporary debug console.log statements added in Task 2:
- Remove log in tickGoals() for crack spawning
- Remove log at start of tickCrackGrowth()
- Remove any spread success logs

Keep the code clean for production.
  </action>
  <verify>
1. Run `npm run test:run` - all tests pass
2. No console.log statements related to crack debugging remain
  </verify>
  <done>
Debug logging removed, code is production-ready.
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] `npm run build` succeeds without errors
- [ ] Cracks spawn into crackCells (not goalMarks)
- [ ] tickCrackGrowth() processes cells
- [ ] Cracks visually expand during gameplay
- [ ] Connection lines render between connected cells
</verification>

<success_criteria>
- UAT-001 resolved: cracks expand with connection lines at rank 30+
- All tests pass
- No debug code remains
- Ready for production use
</success_criteria>

<output>
After completion, create `.planning/plans/20-01-FIX-SUMMARY.md`
</output>
