# Plan 20-01: Expanding Cracks System Overhaul

## Overview

Rework the crack spreading system to support connected multi-cell cracks with organic growth, branching, and merging behavior. This replaces the current simple "spawn adjacent crack" system with a proper graph-based crack structure.

## Goals

1. Cracks are connected structures, not individual cells
2. Same-color cracks that touch merge into one crack
3. Max 8 cracks = 8 connected groups (not 8 cells)
4. Organic growth with per-cell timers and clustering behavior
5. Visual connections between crack cells (lines for now, fancy graphics later)

## Key Decisions (From Discussion)

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Crack identity | Connected same-color cells = 1 crack | Intuitive, allows growth |
| Data structure | `parentIds[]` plural | Supports merging (cell can have 2+ parents) |
| Spread directions | 8 (orthogonal + diagonal) | More organic, interesting graphics later |
| Timer per cell | Random 3-5 seconds | Organic feel, offset timing |
| Base spread chance | 10% + pressureRatio | Cracks spread earlier in game |
| Leaf cell penalty | 50% of calculated chance | Causes clustering, not sprawling |
| Merge behavior | Same-color cracks touching = 1 crack | Reduces crack count, allows more |

## Spread Chance Formula

```
pressureRatio = 1 - (timeLeft / maxTime)
baseChance = min(1.0, 0.10 + pressureRatio)
slowCracksOffset = slowCracksLevel * 0.05
effectiveChance = max(0, baseChance - slowCracksOffset)

// Leaf penalty (no children = 50% chance)
finalChance = hasChildren ? effectiveChance : effectiveChance * 0.5
```

| Pressure | Base Chance | With SLOW_CRACKS L3 |
|----------|-------------|---------------------|
| 0% | 10% | 0% (capped) |
| 30% | 40% | 25% |
| 60% | 70% | 55% |
| 90% | 100% | 85% |

## Data Structure Changes

### Current (types.ts)
```typescript
interface GoalMark {
  id: string;
  x: number;
  y: number;
  color: GoopColor;
  spawnTime: number;
}
```

### New
```typescript
interface CrackCell {
  id: string;
  x: number;
  y: number;
  color: GoopColor;
  parentIds: string[];      // Empty = root, can have multiple (merge)
  childIds: string[];       // Empty = leaf
  lastGrowthCheck: number;  // Per-cell timer
  growthInterval: number;   // Random 3000-5000ms, regenerates each check
  spawnTime: number;        // For compatibility/animation
}
```

### State Changes (GameState)
```typescript
// Remove
goalMarks: GoalMark[];
crackGrowthTimers: Record<string, number>;

// Add
crackCells: CrackCell[];
// No separate timers needed - stored per cell
```

## Implementation Steps

### Step 1: Data Structure Migration
**Files:** `types.ts`, `GameEngine.ts`

1. Add `CrackCell` interface to types.ts
2. Replace `goalMarks: GoalMark[]` with `crackCells: CrackCell[]` in GameState
3. Remove `crackGrowthTimers` from GameState (now per-cell)
4. Update initial state in GameEngine constructor and reset()

### Step 2: GoalManager Updates
**Files:** `core/GoalManager.ts`

1. Update `spawnGoal()` to create CrackCell with:
   - `parentIds: []` (it's a root)
   - `childIds: []` (no children yet)
   - `lastGrowthCheck: Date.now()`
   - `growthInterval: random(3000, 5000)`
2. Update `checkGoalCompletion()` to work with crackCells
3. Add helper: `countCracks()` - counts connected components
4. Add helper: `getCrackGroup(cellId)` - returns all cells in same crack

### Step 3: Crack Growth Rewrite
**Files:** `core/GameEngine.ts`

Replace `tickCrackGrowth()` with new logic:

1. Only active at rank 30+
2. Skip if in CONSOLE or COMPLICATION_MINIGAME phase
3. For each crack cell:
   - Check if timer elapsed (`now - lastGrowthCheck >= growthInterval`)
   - If elapsed, reset timer with new random interval
   - Calculate spread chance (with leaf penalty)
   - Roll for spread
   - If success, try to spread to adjacent cell

4. Spread logic:
   - Get all 8 adjacent positions
   - Filter to valid targets:
     - Empty cells (no goop, no stack) → create new cell
     - Same-color crack cells → merge (add parent/child link)
   - Pick random valid target
   - Create connection

5. After spread, check if crack count exceeds 8
   - Count = number of connected components
   - If over 8, don't spawn (but merges are always allowed)

### Step 4: Merge Logic
**Files:** `core/GameEngine.ts` (in spread logic)

When spreading to existing same-color crack cell:
```typescript
// sourceCell is spreading, targetCell already exists
targetCell.parentIds.push(sourceCell.id);
sourceCell.childIds.push(targetCell.id);
// That's it - they're now connected, crack count reduces automatically
```

### Step 5: Crack Counting Helper
**Files:** `core/GameEngine.ts` or `utils/crackUtils.ts`

```typescript
function countConnectedCracks(cells: CrackCell[]): number {
  // Group by color first
  // Within each color, find connected components using flood fill
  // Return total component count
}

function getConnectedComponent(cellId: string, cells: CrackCell[]): CrackCell[] {
  // BFS/DFS from cellId following parentIds and childIds
  // Return all connected cells
}
```

### Step 6: Update All References
**Files:** Multiple

Search for `goalMarks` and update to `crackCells`:
- `GameEngine.ts` - main game logic
- `GoalManager.ts` - spawning and completion
- `GameBoard.tsx` - rendering
- `core/commands/actions.ts` - if any crack-related actions
- `utils/gameLogic.ts` - if any crack helpers
- Tests - update test data structures

### Step 7: Rendering - Connection Lines
**Files:** `components/GameBoard.tsx`

Add crack connection rendering:
1. For each crack cell with parents:
   - Draw line from cell center to each parent's center
2. Line style: simple stroke for now (color matches crack)
3. Render in crack layer (below goop, above grid)

### Step 8: CRACK_DOWN Active Ability
**Files:** `core/GameEngine.ts`

Update to work with new system:
- When spawning new cracks (from GoalManager), check `crackDownRemaining`
- If > 0, force spawn in bottom 4 rows
- Decrement counter
- New cracks still start as single-cell roots

### Step 9: Tests
**Files:** `tests/`

1. Update existing crack tests for new data structure
2. Add tests for:
   - Connected component counting
   - Merge behavior
   - Spread chance calculation
   - Leaf vs interior spread penalty

## Rendering Note (Future)

Current plan: circles with connecting lines.

Future: Generate actual crack graphics. The parent/child data will let us:
- Draw continuous crack paths from roots to tips
- Branch at cells with multiple children
- Converge at cells with multiple parents (merge points)

## Migration Path

This is a breaking change to save data if users have active cracks. Options:
1. Reset crack state on load (simple, cracks are temporary anyway)
2. Migrate: convert each GoalMark to a single-cell CrackCell

Recommend option 1 - cracks don't persist between sessions anyway.

## Testing Checklist

- [ ] New crack spawns as single-cell root
- [ ] Crack spreads to empty adjacent cell (8 directions)
- [ ] Crack spreads with 10% base chance at 0 pressure
- [ ] Crack spreads with 100% chance at 90% pressure
- [ ] SLOW_CRACKS reduces spread chance
- [ ] Leaf cells have 50% penalty
- [ ] Same-color cracks merge when touching
- [ ] Merge reduces crack count
- [ ] Max 8 crack groups enforced
- [ ] Per-cell random 3-5s timers work
- [ ] Connection lines render between parent/child
- [ ] Sealing any cell of a crack completes the whole crack
- [ ] CRACK_DOWN forces bottom-4-row spawns
- [ ] CRACK_MATCHER biases toward lowest crack color

## Files Modified

| File | Changes |
|------|---------|
| `types.ts` | Add CrackCell, update GameState |
| `core/GameEngine.ts` | Rewrite tickCrackGrowth, update state |
| `core/GoalManager.ts` | Update spawn/completion for CrackCell |
| `components/GameBoard.tsx` | Add connection line rendering |
| `utils/crackUtils.ts` | New file for crack helpers (optional) |
| `tests/*.test.ts` | Update for new structure |

## Estimated Scope

- Types + State: Small
- GoalManager: Medium
- GameEngine tick: Medium-Large (main logic rewrite)
- Rendering: Small
- Tests: Medium

Total: Medium-Large feature
