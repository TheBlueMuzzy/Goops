---
phase: 16-junk-band
plan: 03
type: execute
---

<objective>
Implement GOOP_DUMP active ability effect and SEALING_BONUS passive effect.

Purpose: Complete the Junk Band's active ability and passive sealing mechanic.
Output: GOOP_DUMP drops matching junk on activation, SEALING_BONUS reduces active cooldowns when sealing cracks.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-onboarding-band/15-04-SUMMARY.md

**Key files:**
@core/GameEngine.ts (activateAbility, chargeActiveAbilities)
@core/ComplicationManager.ts (extendAllCooldowns - can adapt for reduction)
@core/commands/actions.ts (PopGroupCommand where infused bonus is calculated)
@constants.ts (UPGRADES.GOOP_DUMP, UPGRADES.SEALING_BONUS)

**GOOP_DUMP mechanic (from PRD):**
- Active ability unlocked at rank 15
- When activated: "Drops matching junk across the board"
- Interpretation: Spawn single-block goops of the current falling piece's color at random empty cells in bottom rows
- Should spawn ~5-10 blocks across the board to help clear similar-colored junk

**SEALING_BONUS mechanic (from STATE.md):**
- Passive upgrade unlocked at rank 18
- Base: 10% cooldown reduction per sealed crack
- Per level: +5% (10%, 15%, 20%, 25%, 30% at level 4)
- Affects complication cooldowns (LIGHTS, CONTROLS, LASER)
- Triggers when popping goop that covers a crack (infused goop)

**Implementation approach:**
- GOOP_DUMP: Add case in activateAbility, spawn 8 blocks of falling piece color at random bottom-row positions
- SEALING_BONUS: In PopGroupCommand where infused bonus is calculated, also reduce complication cooldowns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GOOP_DUMP active ability effect</name>
  <files>core/GameEngine.ts</files>
  <action>
Add GOOP_DUMP case to activateAbility method:

```typescript
case 'GOOP_DUMP': {
    // Drop same-color blocks across the board
    // Use the current falling piece's color if available, else random
    const palette = getPaletteForRank(calculateRankDetails(this.initialTotalScore).rank);
    const targetColor = this.state.activePiece?.definition.color
        || palette[Math.floor(Math.random() * palette.length)];

    // Find empty cells in bottom 3 rows for junk drop
    const candidates: { x: number; y: number }[] = [];
    for (let y = TOTAL_HEIGHT - 3; y < TOTAL_HEIGHT; y++) {
        for (let x = 0; x < TOTAL_WIDTH; x++) {
            if (!this.state.grid[y][x]) {
                candidates.push({ x, y });
            }
        }
    }

    // Shuffle and pick 8 spots (or fewer if not enough empty)
    const shuffled = candidates.sort(() => Math.random() - 0.5);
    const spots = shuffled.slice(0, 8);

    // Spawn single-block goops
    const newGrid = this.state.grid.map(row => [...row]);
    spots.forEach(({ x, y }) => {
        newGrid[y][x] = {
            id: Math.random().toString(36).substr(2, 9),
            groupId: Math.random().toString(36).substr(2, 9), // Unique group = single unit
            timestamp: Date.now(),
            color: targetColor,
            groupMinY: y,
            groupMaxY: y,
            groupSize: 1
        };
    });

    this.state.grid = updateGroups(newGrid);
    console.log(`GOOP_DUMP activated: spawned ${spots.length} ${targetColor} blocks`);
    break;
}
```

Import getPaletteForRank from '../utils/gameLogic' if not already imported.
Import updateGroups if not already imported.
  </action>
  <verify>Run `npm run test:run`. Manual test: equip GOOP_DUMP at rank 15+, charge to 100%, tap to activate - 8 same-color blocks should appear in bottom rows.</verify>
  <done>GOOP_DUMP active ability spawns 8 blocks of current piece color in bottom rows when activated</done>
</task>

<task type="auto">
  <name>Task 2: Implement SEALING_BONUS passive effect</name>
  <files>core/commands/actions.ts, core/ComplicationManager.ts</files>
  <action>
1. In ComplicationManager.ts, add method to reduce cooldowns (opposite of extend):
   ```typescript
   public reduceAllCooldowns(state: GameState, reductionPercent: number) {
       Object.keys(state.complicationCooldowns).forEach(type => {
           const current = state.complicationCooldowns[type as ComplicationType];
           // Reduce remaining cooldown by percentage
           state.complicationCooldowns[type as ComplicationType] =
               Math.max(0, current * (1 - reductionPercent));
       });
   }
   ```

2. In PopGroupCommand.execute() (actions.ts), after the infused bonus section (~line 285):
   ```typescript
   // SEALING_BONUS: Reduce complication cooldowns when sealing crack-goop
   if (infusedCount > 0) {
       const sealingLevel = engine.powerUps['SEALING_BONUS'] || 0;
       const baseReduction = 0.10; // 10% base
       const bonusReduction = sealingLevel * 0.05; // +5% per level
       const totalReduction = baseReduction + bonusReduction;

       // Apply reduction for each infused unit sealed
       for (let i = 0; i < infusedCount; i++) {
           complicationManager.reduceAllCooldowns(engine.state, totalReduction);
       }
   }
   ```

This applies cooldown reduction per sealed crack-goop unit, stacking if multiple are popped at once.
  </action>
  <verify>Run `npm run test:run`. Manual test: with SEALING_BONUS level 4, sealing a crack should reduce complication cooldowns by 30%.</verify>
  <done>SEALING_BONUS reduces complication cooldowns by 10-30% (based on level) when popping infused goop</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GOOP_DUMP and SEALING_BONUS upgrade effects</what-built>
  <how-to-verify>
    1. Run: `npm run dev -- --host`
    2. Set rank to 15+ (modify initialTotalScore in App.tsx if needed for testing)
    3. Purchase GOOP_DUMP upgrade in UpgradePanel
    4. Equip GOOP_DUMP as active ability
    5. Play until ability charges to 100%
    6. Tap ability circle - verify 8 same-color blocks appear in bottom rows
    7. Set rank to 18+ and purchase SEALING_BONUS
    8. Trigger a complication, wait for cooldown to start
    9. Seal a crack (pop goop covering matching-color crack)
    10. Verify complication cooldown was reduced (may need console.log to confirm)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] No TypeScript errors
- [ ] GOOP_DUMP spawns blocks on activation
- [ ] SEALING_BONUS reduces cooldowns when sealing cracks
- [ ] Both upgrades appear in UpgradePanel at correct unlock ranks
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification approved
- Phase 16 complete with all 4 Junk Band upgrades functional
</success_criteria>

<output>
After completion, create `.planning/phases/16-junk-band/16-03-SUMMARY.md` with:
- What was built
- Any deviations from plan
- Phase 16 completion status
</output>
