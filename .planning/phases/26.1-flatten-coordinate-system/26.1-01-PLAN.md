---
phase: 26.1-flatten-coordinate-system
plan: 01
type: execute
---

<objective>
Remove cylindrical projection from coordinate system, flatten to simple 2D grid rendering.

Purpose: Eliminate coordinate mismatches between game rendering and soft-body physics. The cylindrical projection (`visXToScreenX`) applies a `sin()` transform that makes X coordinates non-linear, causing constant integration friction.

Output: All rendering uses flat 2D coordinates. Soft-body physics and game rendering share the same coordinate space.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key source files:
@utils/coordinateTransform.ts
@components/GameBoard.tsx
@hooks/useInputHandlers.ts

**Problem:**
- `visXToScreenX(visX)` returns `CYL_RADIUS * Math.sin(angle)` - non-linear X mapping
- VIEWBOX is calculated from this projection: `{ x: -115, y: 0, w: 230, h: 480 }`
- Physics works in flat space: `PHYSICS_GRID_OFFSET (50,50) + cell * PHYSICS_CELL_SIZE (30)`
- Blobs at x=200+ are outside viewBox (-115 to +115)

**Solution:**
- `visXToScreenX(visX)` returns linear: `(visX - TANK_VIEWPORT_WIDTH/2) * BLOCK_SIZE`
- VIEWBOX becomes simple rectangle: `{ x: -180, y: 0, w: 360, h: 480 }` (12 cols * 30px = 360)
- All coordinate transforms become trivial multiplication
- Physics and rendering share same coordinate space
</context>

<tasks>

<task type="auto">
  <name>Task 1: Flatten visXToScreenX and VIEWBOX</name>
  <files>utils/coordinateTransform.ts</files>
  <action>
Modify the coordinate transform to use linear (flat) coordinates:

1. Change `visXToScreenX()` to return linear coordinates:
```ts
export function visXToScreenX(visX: number): number {
  // Flat 2D: center at 0, each column is BLOCK_SIZE wide
  return (visX - TANK_VIEWPORT_WIDTH / 2) * BLOCK_SIZE;
}
```

2. Change `VIEWBOX` to a simple rectangle:
```ts
export const VIEWBOX = {
  x: -(TANK_VIEWPORT_WIDTH / 2) * BLOCK_SIZE,  // -180
  y: 0,
  w: TANK_VIEWPORT_WIDTH * BLOCK_SIZE,          // 360
  h: TANK_VIEWPORT_HEIGHT * BLOCK_SIZE,         // 480
};
```

3. Update `screenXToVisX()` (inverse function):
```ts
export function screenXToVisX(screenX: number): number {
  return (screenX / BLOCK_SIZE) + (TANK_VIEWPORT_WIDTH / 2);
}
```

4. Remove or comment out the cylindrical constants (ANGLE_PER_COL, CYL_RADIUS) - they're no longer needed but keep them commented for reference.
  </action>
  <verify>
1. `npm run build` passes
2. `npm run test:run` - coordinate tests may need updates
  </verify>
  <done>
- visXToScreenX returns linear coordinates
- VIEWBOX is a simple rectangle
- screenXToVisX updated to match
  </done>
</task>

<task type="auto">
  <name>Task 2: Update coordinate tests</name>
  <files>tests/coordinateTransform.test.ts, tests/coordinates.test.ts</files>
  <action>
Update any tests that expect cylindrical projection values to expect linear values instead.

Key changes:
- visXToScreenX(6) should return 0 (center column)
- visXToScreenX(0) should return -180 (left edge)
- visXToScreenX(12) should return 180 (right edge)
- VIEWBOX.x should be -180, VIEWBOX.w should be 360

Run tests and fix any failures.
  </action>
  <verify>`npm run test:run` passes all tests</verify>
  <done>All coordinate tests updated and passing</done>
</task>

<task type="auto">
  <name>Task 3: Align physics constants with game coordinates</name>
  <files>core/softBody/blobFactory.ts</files>
  <action>
Now that the game uses flat coordinates, align physics constants:

1. Update `PHYSICS_GRID_OFFSET` to match the game's coordinate origin:
```ts
// Game VIEWBOX starts at x = -180, y = 0
// Visual grid (0,0) should map to SVG (-180, 0)
export const PHYSICS_GRID_OFFSET = {
  x: -(TANK_VIEWPORT_WIDTH / 2) * PHYSICS_CELL_SIZE,  // -180
  y: 0
};
```

2. Verify `PHYSICS_CELL_SIZE` matches `BLOCK_SIZE` (both should be 30)

3. Import constants if needed:
```ts
import { TANK_VIEWPORT_WIDTH } from '../../constants';
```

With this change, physics pixel coordinates will directly match SVG coordinates - no transform needed.
  </action>
  <verify>`npm run build` passes</verify>
  <done>Physics coordinates aligned with game SVG coordinates</done>
</task>

<task type="auto">
  <name>Task 4: Simplify soft-body blob rendering</name>
  <files>components/GameBoard.tsx</files>
  <action>
Now that coordinates match, simplify `getBlobVertexPath()`:

```ts
function getBlobVertexPath(blob: SoftBlob): string {
  const verts = blob.vertices;
  if (verts.length < 3) return '';

  // Coordinates now match directly - no transform needed
  let path = `M ${verts[0].pos.x} ${verts[0].pos.y}`;
  for (let i = 1; i < verts.length; i++) {
    path += ` L ${verts[i].pos.x} ${verts[i].pos.y}`;
  }
  path += ' Z';
  return path;
}
```

Remove the import of `PHYSICS_GRID_OFFSET` and `PHYSICS_CELL_SIZE` from blobFactory (no longer needed in GameBoard).
  </action>
  <verify>
1. `npm run build` passes
2. Start game, lock pieces - soft-body blobs should render in correct positions
  </verify>
  <done>Blob rendering simplified, no coordinate transforms</done>
</task>

<task type="auto">
  <name>Task 5: Clean up unused cylindrical code</name>
  <files>utils/coordinateTransform.ts, components/GameBoard.tsx</files>
  <action>
Remove or comment out cylindrical projection remnants:

1. In coordinateTransform.ts:
   - Comment out ANGLE_PER_COL and CYL_RADIUS (keep for historical reference)
   - Add comment explaining the change

2. In GameBoard.tsx:
   - Remove any remaining cylindrical-specific code
   - Remove blobRenderKey state if no longer needed (it was a bandaid)

3. Verify no other files reference the cylindrical constants
  </action>
  <verify>`npm run build` passes, no TypeScript errors</verify>
  <done>Cylindrical projection code removed/commented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Flat 2D coordinate system replacing cylindrical projection</what-built>
  <how-to-verify>
    1. Run: `npm run dev -- --host`
    2. Open on desktop browser: http://localhost:5173/GOOPS/
    3. Start a game (any rank)
    4. Verify: Game renders correctly (columns should be uniform width now - no perspective effect)
    5. Lock a piece - soft-body blob should appear in correct position
    6. Play for a bit - all rendering should work correctly
    7. Note: The visual will look "flatter" - columns are same width edge-to-edge
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run test:run` passes all tests
- [ ] Game renders correctly with flat coordinates
- [ ] Soft-body blobs appear in correct positions
- [ ] No console errors
</verification>

<success_criteria>
- Cylindrical projection removed from coordinate system
- VIEWBOX is simple rectangle (360x480)
- visXToScreenX returns linear coordinates
- Physics and game share same coordinate space
- Soft-body blobs render without coordinate transforms
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/26.1-flatten-coordinate-system/26.1-01-SUMMARY.md`

# Phase 26.1 Plan 01: Flatten Coordinate System Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready to resume 26-02-PLAN.md (soft-body blob rendering) with simplified coordinates
</output>
