---
phase: 26.1-flatten-coordinate-system
plan: FIX
subsystem: softBody
tags: [physics, proto-9, parity, droplets, sliders, loose-goop]

requires:
  - phase: 26.1-03
    provides: seam wrapping visual merge
provides:
  - Droplets only on pop (not merge)
  - All droplet sliders connected
  - Smooth loose goop fall animation
  - Attraction stiffness formula fix
affects: [27-active-piece-physics, 28-locked-goop-behavior]

tech-stack:
  added: []
  patterns:
    - "Loose goop sync: GameBoard syncs blob.isLoose and targetY from looseGoop state"

key-files:
  created: []
  modified:
    - core/softBody/physics.ts
    - hooks/useSoftBodyPhysics.ts
    - components/GameBoard.tsx
    - utils/gameLogic.ts
    - types.ts
    - core/GameEngine.ts
    - core/commands/actions.ts

key-decisions:
  - "Droplet params added to useEffect deps (were missing)"
  - "Attraction stiffness uses params directly (was double-multiplying)"
  - "Loose goop fall speed: 0.012 cells/ms (~15% faster than fast-drop)"

issues-created: []

duration: ~45min
completed: 2026-02-04
---

# Phase 26.1 FIX: Proto-9 Parity Fixes Summary

**Fixed damping/home-force formulas, droplet-on-pop logic, slider connections, and smooth loose goop fall animation**

## Performance

- **Duration:** ~45 min
- **Started:** 2026-02-04T23:00:00Z
- **Completed:** 2026-02-04T23:45:00Z
- **Tasks:** 3 planned + audit fixes
- **Files modified:** 7

## Accomplishments

- Damping now uses params.damping directly (not divided by viscosity)
- Home force uses direct distance (not cylindricalDistanceX)
- Droplets only spawn on actual pop events (not merge/consolidation)
- All droplet sliders now connected (were missing from useEffect deps)
- Attraction stiffness formula matches Proto-9 (no double-multiply)
- Loose goop has smooth fall animation (synced with soft-body blobs)
- Loose goop fall speed tuned (slightly faster than fast-drop)

## Task Commits

1. **Task 1: Fix damping/viscosity** - `3ea119c` (fix)
2. **Task 2: Fix home force distance** - `7a18181` (fix)
3. **Task 3: Fix droplets on pop only** - `2d1a499` (fix)
4. **Audit fixes: sliders, stiffness, loose goop** - `0b56b56` (fix)

## Files Created/Modified

- `core/softBody/physics.ts` - Damping, home force, attraction stiffness fixes
- `hooks/useSoftBodyPhysics.ts` - Added droplet params to useEffect deps
- `components/GameBoard.tsx` - Loose goop sync with soft-body blobs
- `utils/gameLogic.ts` - Tuned loose goop fall speed
- `types.ts` - Added poppedGoopGroupIds to GameState
- `core/GameEngine.ts` - Initialize poppedGoopGroupIds
- `core/commands/actions.ts` - Track popped goopGroupIds before clearing

## Decisions Made

- Used SBG system audit to identify all slider connections
- Loose goop fall speed set to 0.012 cells/ms (83ms/cell) - 15% faster than fast-drop (97.5ms/cell)

## Deviations from Plan

### Added Work (from audit)

**1. Droplet slider connection fix**
- **Found during:** UAT verification
- **Issue:** Droplet size/count/speed/lifetime sliders had no effect
- **Fix:** Added 4 missing params to useEffect dependency array
- **Files modified:** hooks/useSoftBodyPhysics.ts
- **Committed in:** 0b56b56

**2. Attraction stiffness formula fix**
- **Found during:** Audit
- **Issue:** Game was double-multiplying attractionStiffness
- **Fix:** MIN/MAX_STIFFNESS now use params, force calc uses stiffness directly
- **Files modified:** core/softBody/physics.ts
- **Committed in:** 0b56b56

**3. Loose goop smooth fall**
- **Found during:** UAT verification
- **Issue:** Loose goop appeared to teleport (no animation)
- **Fix:** GameBoard now syncs blob.isLoose and targetY from looseGoop state
- **Files modified:** components/GameBoard.tsx, utils/gameLogic.ts
- **Committed in:** 0b56b56

---

**Total deviations:** 3 added (audit-driven improvements)
**Impact on plan:** All additions necessary for proper Proto-9 parity

## Issues Encountered

- Original 3 planned fixes improved things but UAT revealed additional issues
- Comprehensive audit identified root causes (slider deps, formula differences)
- Stiffness issue (UAT-001, UAT-002) partially improved but not fully resolved - may require active piece SBG (Phase 27) to properly test

## Issues Remaining

Open in 26.1-ISSUES.md:
- UAT-001: Goop still feels too stiff (partial - needs Phase 27 active piece SBG)
- UAT-002: Blob collision hard to observe (depends on stiffness)
- UAT-004: Sliders don't fully match Proto-9 (most connected, stiffness issue remains)

## Next Phase Readiness

- Phase 26.1 FIX complete
- Remaining stiffness issues may resolve once active piece uses SBG (Phase 27)
- Ready to continue with Phase 26-02 or Phase 27

---
*Phase: 26.1-flatten-coordinate-system*
*Completed: 2026-02-04*
