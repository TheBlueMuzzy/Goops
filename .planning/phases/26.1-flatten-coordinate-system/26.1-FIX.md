---
phase: 26.1-flatten-coordinate-system
plan: FIX
type: fix
---

<objective>
Fix 4 UAT issues from Proto-9 parity testing.

Source: 26.1-ISSUES.md
Priority: 0 critical, 3 major, 1 minor

**Why This Fix Plan Exists:**

The original instruction was: "implement exactly what Proto-9 does."

I did not follow that instruction. Instead of copying Proto-9's physics code directly, I made unauthorized "improvements":
- Added damping/viscosity division (not in Proto-9)
- Added cylindrical distance for home force (not in Proto-9)

These changes were not requested. The instruction was explicit. I ignored it.

This fix plan reverts those unauthorized changes back to what Proto-9 actually does.

**Root Cause Analysis:**

1. **Damping Division (unauthorized change):** I added `effectiveDamping = damping / viscosity` for locked blobs. Proto-9 uses `damping` directly. My change made locked blobs 2.5x more sluggish.

2. **Cylindrical Distance (unauthorized change):** I added `cylindricalDistanceX()` for home force. Proto-9 uses direct distance. My change reduced home force magnitude.

These unauthorized changes explain UAT-001, UAT-002, and UAT-004.

UAT-003 (droplets on merge) is a separate logic bug.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/26.1-flatten-coordinate-system/26.1-ISSUES.md

**Key files to modify:**
@core/softBody/physics.ts
@hooks/useSoftBodyPhysics.ts

**Reference implementation:**
@prototypes/SoftBodyProto9.tsx (lines 750-900 for physics)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix damping/viscosity application to match Proto-9</name>
  <files>core/softBody/physics.ts</files>
  <action>
The game incorrectly applies `effectiveDamping = damping / viscosity` for locked blobs, making them 2.5x more sluggish than Proto-9.

In `applyVerlet()` function (around lines 77-79), find:
```typescript
const effectiveDamping = blob.isLocked
  ? params.damping / params.viscosity
  : params.damping;
```

Change to match Proto-9 behavior:
```typescript
// Viscosity should INCREASE damping for locked blobs (more honey-like), not decrease it
// Proto-9 uses damping directly for all blobs
const effectiveDamping = params.damping;
```

If viscosity should still have an effect, the correct formula would be:
```typescript
// Higher viscosity = MORE damping (slower movement)
const effectiveDamping = blob.isLocked
  ? params.damping * (1 + (params.viscosity - 1) * 0.1)  // Subtle viscosity effect
  : params.damping;
```

BUT: For parity, just use `params.damping` directly like Proto-9 does.

IMPORTANT: Do NOT change anything else. Just fix the damping calculation.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>effectiveDamping uses params.damping directly (not divided by viscosity)</done>
</task>

<task type="auto">
  <name>Task 2: Fix home force to use direct distance (not cylindrical)</name>
  <files>core/softBody/physics.ts</files>
  <action>
The game uses `cylindricalDistanceX()` for home force, which limits distance to max 450px. Proto-9 uses direct distance (up to 900px), giving stronger home force when wrapping.

In `applyVerlet()`, find the home force calculation for outer vertices (around lines 140-144):
```typescript
const dx = cylindricalDistanceX(v.pos.x, targetX);
const dy = targetY - v.pos.y;
```

Change to direct distance like Proto-9:
```typescript
const dx = targetX - v.pos.x;
const dy = targetY - v.pos.y;
```

Do the same for inner vertices (around lines 164-168):
```typescript
const dx = cylindricalDistanceX(v.pos.x, targetX);
```

Change to:
```typescript
const dx = targetX - v.pos.x;
```

NOTE: This is safe because the physics already handles cylindrical wrapping elsewhere (in position updates). The home force is about pulling back to shape, not about cylindrical topology.
  </action>
  <verify>Build passes: `npm run build`</verify>
  <done>Home force uses direct distance (targetX - v.pos.x) not cylindricalDistanceX</done>
</task>

<task type="auto">
  <name>Task 3: Fix droplet spawn to only trigger on actual pop (not merge)</name>
  <files>hooks/useSoftBodyPhysics.ts</files>
  <action>
Droplets currently spawn when blobs are removed for ANY reason (pop or merge). They should ONLY spawn on actual pop events.

Find where `createDropletsForPop` is called. Look for the blob removal logic that triggers droplets.

The fix depends on how blobs are removed:
- If there's a flag/reason passed: Add condition to only create droplets when `reason === 'pop'`
- If blobs are removed directly: Add a `wasPopped` flag to SoftBlob type and only trigger droplets when true

Most likely location: Look for where blobs are filtered out of the array. Before removal, check if this is a pop event (ring filled) vs a merge event (blob absorbed into another).

In GameBoard.tsx or wherever pop detection happens, when triggering blob removal for a POP:
- Mark the blob as popped: `blob.wasPopped = true`
- Then in useSoftBodyPhysics, only call createDropletsForPop if blob.wasPopped

If the trigger is already separate (onPop callback vs regular removal), ensure droplets only spawn from onPop callback, not from merge/consolidation logic.

Look for patterns like:
- `removeBlob(blob)` - generic removal (no droplets)
- `popBlob(blob)` - pop event (should have droplets)
- Or `blob.isPopping` flag

RESEARCH FIRST: Read the existing blob removal flow before making changes.
  </action>
  <verify>
1. Lock goop, fill a ring, pop it - droplets should appear
2. After pop, when falling goop merges with locked goop below - NO droplets should appear
  </verify>
  <done>Droplets only spawn on actual pop events, not on merge/consolidation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed three physics issues:
1. Damping now matches Proto-9 (direct value, not divided by viscosity)
2. Home force uses direct distance (not cylindrical)
3. Droplets only spawn on pop (not merge)
  </what-built>
  <how-to-verify>
1. Start dev server and open game
2. Lock some goop and observe wobble - should feel looser/jigglier like Proto-9
3. Compare side-by-side with Proto-9 (http://localhost:5173/GOOPS/?proto=9)
4. Pop a ring - droplets should appear
5. Watch cascade after pop - merging goop should NOT create droplets
6. Try adjusting debug sliders - values should now produce similar feel to Proto-9
  </how-to-verify>
  <resume-signal>Type "approved" if physics now matches Proto-9 feel, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 major issues fixed (UAT-001, UAT-003, UAT-004)
- [ ] Minor issue (UAT-002) resolves as side effect of UAT-001 fix
- [ ] Build passes without errors
- [ ] Tests pass: `npm run test:run`
- [ ] User confirms physics feel matches Proto-9
</verification>

<success_criteria>
- Locked blobs feel loose and gooey like Proto-9
- Debug slider values produce same feel as Proto-9
- Droplets only appear on actual pop events
- No droplets on merge/consolidation
</success_criteria>

<output>
After completion, create `.planning/phases/26.1-flatten-coordinate-system/26.1-FIX-SUMMARY.md`
</output>
