---
phase: 04-minigame-complication-integration
plan: 02
type: execute
---

<objective>
Rewrite LIGHTS complication with user-specified trigger and effect.

Purpose: Replace the incorrectly-guessed LIGHTS implementation with the actual user requirements.
Output: Working LIGHTS complication that dims/desaturates when pressure is far above goop level.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@core/GameEngine.ts
@Game.tsx
@components/GameBoard.tsx

**User-specified requirements:**

LIGHTS Complication (Rank 3+):
- Trigger: 50% chance when piece locks, IF pressure is 3-5 rows above highest goop
- Effect: Dims to 10%, desaturates to grayscale over 1.5s (periscope only, alert exempt)
- Chance resets to 0% while active, 50% after solved

**Current (wrong) implementation:**
- Trigger: Cumulative units added threshold (12-24 range)
- Effect: Dims to 80% opacity over 3 seconds
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite LIGHTS trigger logic</name>
  <files>core/GameEngine.ts</files>
  <action>
  Remove the current totalUnitsAdded threshold trigger for LIGHTS.

  Add new trigger logic in piece lock (after mergePiece in tick()):
  1. Check rank >= 3
  2. Check no LIGHTS complication currently active
  3. Calculate highest goop row (scan grid for topmost occupied cell)
  4. Calculate pressure line Y position (existing formula)
  5. Calculate gap = pressureLineY - highestGoopY
  6. Generate random gap threshold (3-5 rows)
  7. If gap >= threshold, 50% chance to spawn LIGHTS complication

  Remove totalUnitsAdded counter increment (no longer used).
  Remove complicationThresholds.lights (no longer needed).

  Keep the LIGHTS counter reset in resolveComplication() - it resets the 50% chance.
  </action>
  <verify>
  - Code compiles without errors
  - LIGHTS complication spawns when piece locks with pressure far above goop
  - Does NOT spawn when pressure is close to goop level
  - Does NOT spawn at rank 1-2
  </verify>
  <done>LIGHTS trigger fires based on pressure-vs-goop gap, not cumulative counter</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite LIGHTS effect</name>
  <files>Game.tsx</files>
  <action>
  Replace current dim overlay (80% opacity black) with new effect:

  1. Create CSS filter for desaturation + brightness reduction
  2. Target: 10% brightness (not opacity), 0% saturation
  3. Animation: 1.5 seconds ease-out (not 3 seconds)
  4. Only applies during PERISCOPE phase
  5. Alert message must be exempt from the effect (render above the filter layer)

  CSS approach: Apply `filter: grayscale(100%) brightness(0.1)` to game content
  with CSS animation from normal to filtered state over 1.5s.

  The GameBoard malfunction alert overlay (z-40) should remain visible and colored.
  </action>
  <verify>
  - Game dims AND desaturates when LIGHTS active
  - Takes 1.5 seconds to reach full effect
  - Alert message remains visible and colored
  - Effect clears instantly when complication resolved
  </verify>
  <done>LIGHTS effect is dim + grayscale over 1.5s, alert exempt</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] LIGHTS complication triggers based on pressure gap (not counter)
- [ ] Visual effect is dim (10%) + grayscale over 1.5s
- [ ] Malfunction alert remains visible and colored
- [ ] Effect clears instantly on resolution
</verification>

<success_criteria>
- Both tasks completed
- All verification checks pass
- No TypeScript errors
- LIGHTS complication matches user specification
</success_criteria>

<output>
After completion, create `.planning/phases/04-minigame-complication-integration/04-02-SUMMARY.md`
</output>
