---
phase: 04-minigame-complication-integration
plan: 03
type: execute
---

<objective>
Rewrite CONTROLS complication with user-specified trigger and effect.

Purpose: Replace the incorrectly-guessed CONTROLS implementation with the actual user requirements.
Output: Working CONTROLS complication that requires double inputs when player rotates too fast.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-minigame-complication-integration/04-02-SUMMARY.md
@core/GameEngine.ts
@Game.tsx

**User-specified requirements:**

CONTROLS Complication (Rank 2+):
- Trigger: 20 rotation inputs within 3 seconds
- Effect: 2 inputs per move, holding works at half speed

**Current (wrong) implementation:**
- Trigger: Cumulative rotations threshold (12-24 range)
- Effect: Left/right controls flip every 3 seconds
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite CONTROLS trigger logic</name>
  <files>core/GameEngine.ts, types.ts</files>
  <action>
  Remove the current totalRotations threshold trigger for CONTROLS.

  Add new trigger logic:
  1. Add `rotationTimestamps: number[]` to GameState (track last N rotation times)
  2. In MoveBoardCommand, record Date.now() to rotationTimestamps
  3. Prune timestamps older than 3 seconds
  4. If rotationTimestamps.length >= 20 AND rank >= 2 AND no CONTROLS active:
     - Spawn CONTROLS complication
     - Clear rotationTimestamps

  Remove totalRotations counter (no longer used).
  Remove complicationThresholds.controls (no longer needed).

  In resolveComplication for CONTROLS: clear rotationTimestamps.
  </action>
  <verify>
  - Code compiles without errors
  - CONTROLS spawns when rotating rapidly (20+ in 3s)
  - Does NOT spawn with slow, steady rotation
  - Does NOT spawn at rank 1
  </verify>
  <done>CONTROLS trigger fires based on rotation speed, not cumulative count</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite CONTROLS effect</name>
  <files>Game.tsx, core/commands/actions.ts</files>
  <action>
  Remove current flip effect (controlsFlipped state, 3-second toggle).

  Add new effect - "sluggish controls":
  1. Add state: `controlsInputCount: number` (tracks pending inputs)
  2. When CONTROLS active, each MoveBoardCommand increments inputCount
  3. Only execute actual move when inputCount >= 2, then reset to 0
  4. For held keys: reduce repeat rate by half (200ms instead of 100ms)

  Implementation in Game.tsx:
  - Track controlsInputCount ref
  - On movement input with CONTROLS active:
    - Increment count
    - If count < 2, reject move (return early)
    - If count >= 2, allow move and reset count

  For held input (startMovementLoop):
  - If CONTROLS active, use lastMoveTimeRef + 200 instead of + 100
  </action>
  <verify>
  - Tapping left/right twice moves tank once
  - Holding moves at half speed
  - Normal behavior when no CONTROLS complication
  - Effect clears instantly on resolution
  </verify>
  <done>CONTROLS effect requires double inputs, halves hold speed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] CONTROLS triggers on rapid rotation (20 in 3s)
- [ ] Movement requires 2 inputs per tank move
- [ ] Held movement is half speed
- [ ] Effect clears on resolution
</verification>

<success_criteria>
- Both tasks completed
- All verification checks pass
- No TypeScript errors
- CONTROLS complication matches user specification
</success_criteria>

<output>
After completion, create `.planning/phases/04-minigame-complication-integration/04-03-SUMMARY.md`
</output>
