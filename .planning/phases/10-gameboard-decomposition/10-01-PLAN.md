---
phase: 10-gameboard-decomposition
plan: 01
type: execute
---

<objective>
Extract unified input handling from GameBoard.tsx into a dedicated useInputHandlers hook.

Purpose: Isolate complex pointer/touch input logic (~240 lines) into a reusable, testable hook.
Output: `hooks/useInputHandlers.ts` containing all pointer event handling, hold-to-swap logic, and gesture recognition.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summary (dependency):
@.planning/phases/09-art-decomposition/09-03-SUMMARY.md

# Key source files:
@components/GameBoard.tsx
@utils/coordinateTransform.ts

**Constraints from prior phases:**
- All 81 tests must pass throughout refactor
- Follow Phase 9 pattern: extract hooks with clear interfaces
- No gameplay changes

**Pattern to follow:**
Phase 9 extracted minigame state machines into hooks (useLaserMinigame, useLightsMinigame, useControlsMinigame). This plan follows the same pattern for input handling.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useInputHandlers hook with types</name>
  <files>hooks/useInputHandlers.ts, types/input.ts</files>
  <action>
Create `types/input.ts` with:
- `InputHandlers` interface: { onPointerDown, onPointerMove, onPointerUp }
- `InputCallbacks` interface: { onBlockTap, onRotate, onDragInput, onSwipeUp, onSoftDrop, onSwap }
- `HoldState` interface: { progress: number, position: {x: number, y: number} | null }
- `HitData` type: { type: 'BLOCK', x: number, y: number, cell: GridCell } | { type: 'EMPTY' }

Create `hooks/useInputHandlers.ts` that:
1. Accepts `InputCallbacks`, `boardOffset: number`, `grid`, `pressureRatio: number` as parameters
2. Uses existing `clientToSvg`, `svgToVisual`, `visualToGrid` from coordinateTransform.ts for coordinate conversion (don't duplicate)
3. Manages internal state: pointerRef, holdIntervalRef, holdProgress, holdPosition
4. Implements getHitData() internally using the coordinate utils
5. Implements clearHold() for cleanup
6. Returns: { handlers: InputHandlers, holdState: HoldState, highlightedGroupId, shakingGroupId, setHighlightedGroupId, setShakingGroupId }

Key behaviors to preserve:
- Hold-to-swap: 250ms delay, then 1000ms fill, triggers onSwap at 100%
- Horizontal drag: deadzone ±20px, then continuous onDragInput
- Vertical drag: down = soft drop, up = swipe to console
- Tap on block = onBlockTap, tap on empty = rotate (left/right half)
- Shake animation for invalid taps (below pressure line or not filled)

Use VISIBLE_WIDTH, TOTAL_HEIGHT, TOTAL_WIDTH, BUFFER_HEIGHT from constants.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Hook created with all input handling logic, types defined, no TS errors</done>
</task>

<task type="auto">
  <name>Task 2: Wire useInputHandlers into GameBoard</name>
  <files>components/GameBoard.tsx</files>
  <action>
1. Import useInputHandlers and types from new files
2. Replace inline input handling with hook usage:
   - Remove pointerRef, holdIntervalRef, holdProgress, holdPosition, highlightedGroupId, shakingGroupId state
   - Remove getViewportCoords, getHitData, clearHold, handlePointerDown/Move/Up functions
   - Remove cleanup useEffect for holdIntervalRef
3. Call useInputHandlers with appropriate callbacks
4. Use returned handlers for onPointerDown/Move/Up
5. Use returned holdState for hold-to-swap visual
6. Use returned highlightedGroupId/shakingGroupId for group rendering

The div's pointer handlers become:
```tsx
onPointerDown={handlers.onPointerDown}
onPointerMove={handlers.onPointerMove}
onPointerUp={handlers.onPointerUp}
onPointerLeave={handlers.onPointerUp}
```

This should remove ~200 lines from GameBoard.tsx.
  </action>
  <verify>
1. `npm run test:run` — all 81 tests pass
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>GameBoard uses useInputHandlers hook, ~200 lines removed, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all 81 tests
- [ ] `npx tsc --noEmit` has no TypeScript errors
- [ ] GameBoard.tsx reduced by ~200 lines
- [ ] Input handling works identically (tap, drag, hold-to-swap)
</verification>

<success_criteria>

- useInputHandlers hook extracted and working
- Types defined in types/input.ts
- GameBoard.tsx reduced from 1,031 to ~830 lines
- All 81 tests pass
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-gameboard-decomposition/10-01-SUMMARY.md`
</output>
