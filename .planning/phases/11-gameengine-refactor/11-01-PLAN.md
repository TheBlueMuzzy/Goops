---
phase: 11-gameengine-refactor
plan: 01
type: execute
---

<objective>
Split GameEngine.tick() into focused sub-methods to improve readability and maintainability.

Purpose: Reduce tick() from 159 lines to under 50 lines by extracting logical sections into private methods.
Output: GameEngine.ts with clean, readable tick() that delegates to focused helper methods.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/10-gameboard-decomposition/10-03-SUMMARY.md

# Key source file:
@core/GameEngine.ts

**Constraints:**
- All 81 tests must pass
- No gameplay changes
- Mobile optimizations must be preserved

**Success Criteria from v1.1:**
- GameEngine.tick() under 50 lines
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract tick sub-methods</name>
  <files>core/GameEngine.ts</files>
  <action>
Create private helper methods within GameEngine class, extracting code from tick():

1. **tickTimer(dt: number): boolean** (lines 464-469)
   - Decrement timeLeft
   - Call finalizeGame() if time runs out
   - Return false if game should stop processing, true to continue

2. **tickGoals()** (lines 471-482)
   - Check if goals needed
   - Spawn new goal mark if interval elapsed
   - Update lastGoalSpawnTime

3. **tickHeat(dt: number)** (lines 486-501)
   - Check if CONTROLS unlocked
   - Calculate idle time from rotationTimestamps
   - Apply heat dissipation based on upgrade level

4. **tickFallingBlocks(dt: number)** (lines 506-531)
   - Update falling blocks positions
   - Handle landed blocks (merge into grid)
   - Update groups after landing

5. **tickActivePiece(dt: number)** (lines 533-617)
   - Calculate gravity speed (soft drop factor)
   - Move piece down
   - Handle collision detection
   - Lock piece when delay expires
   - Trigger LIGHTS complication check on lock
   - Spawn new piece after lock

Each method should:
- Be private (no `public` keyword)
- Take only the parameters it needs (dt if time-based)
- Access this.state directly (same pattern as existing methods)
- Emit events and call emitChange() as needed within the method

Keep the LIGHTS complication trigger logic inside tickActivePiece() for now - it's tightly coupled to piece locking.
  </action>
  <verify>
1. `npx tsc --noEmit` — no TypeScript errors
2. Methods are private and properly typed
  </verify>
  <done>5 private tick sub-methods created with extracted logic</done>
</task>

<task type="auto">
  <name>Task 2: Refactor tick() to use sub-methods</name>
  <files>core/GameEngine.ts</files>
  <action>
Replace the inline code in tick() with calls to the new sub-methods:

```typescript
public tick(dt: number) {
    if (!this.isSessionActive || this.state.gameOver || this.state.isPaused) return;

    // Timer - stop if game ended
    if (!this.tickTimer(dt)) return;

    // Goals
    this.tickGoals();

    // Complications check
    this.checkComplications(dt);

    // Heat dissipation
    this.tickHeat(dt);

    // Falling blocks
    this.tickFallingBlocks(dt);

    // Active piece gravity
    this.tickActivePiece(dt);

    this.emitChange();
}
```

Key changes:
- tick() becomes a coordinator (~15-20 lines)
- Each sub-method handles its own concerns
- Remove the final emitChange() from tickActivePiece() since tick() calls it at the end
- Ensure tickTimer() returns boolean for early exit on game over

Count lines in tick() after refactor - must be under 50 lines.
  </action>
  <verify>
1. `npm run test:run` — all 81 tests pass
2. `wc -l` on tick() method shows under 50 lines
3. Game plays correctly (timer, goals, heat, falling, piece movement all work)
  </verify>
  <done>tick() is under 50 lines, delegates to focused sub-methods</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all 81 tests
- [ ] `npx tsc --noEmit` has no TypeScript errors
- [ ] tick() method is under 50 lines
- [ ] All tick functionality preserved (timer, goals, heat, falling blocks, active piece)
</verification>

<success_criteria>

- tick() reduced from 159 lines to under 50 lines
- 5 focused sub-methods created
- All 81 tests pass
- No gameplay changes
</success_criteria>

<output>
After completion, create `.planning/phases/11-gameengine-refactor/11-01-SUMMARY.md` with:
- Line count before/after for tick()
- List of extracted methods
- Any deviations from plan
</output>
