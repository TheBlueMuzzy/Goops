---
phase: 12-state-management
plan: 01
type: execute
---

<objective>
Add input events to EventBus and refactor input handling to use event-based communication.

Purpose: Reduce prop drilling by having input handlers emit events instead of calling callbacks passed through multiple component layers.
Output: Input events defined, useInputHandlers emits events, Game.tsx subscribes to events.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase context:**
@.planning/phases/11-gameengine-refactor/11-02-SUMMARY.md

**Key files:**
@core/events/EventBus.ts
@core/events/GameEvents.ts
@hooks/useInputHandlers.ts
@Game.tsx
@components/GameBoard.tsx

**Established patterns:**
- EventBus uses `gameEventBus.emit(GameEventType.EVENT_NAME, payload)`
- Components subscribe via `gameEventBus.on(EventType, handler)` in useEffect
- See `hooks/useAudioSubscription.ts` for subscription pattern example

**Constraints:**
- All 81 tests must pass
- No gameplay changes
- Mobile performance must be preserved
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add input event types to GameEvents.ts</name>
  <files>core/events/GameEvents.ts</files>
  <action>
Add new event types for input actions that are currently passed as callbacks:

```typescript
// Input events (replaces callback prop drilling)
INPUT_ROTATE = 'INPUT_ROTATE',
INPUT_DRAG = 'INPUT_DRAG',
INPUT_SWIPE_UP = 'INPUT_SWIPE_UP',
INPUT_SOFT_DROP = 'INPUT_SOFT_DROP',
INPUT_SWAP = 'INPUT_SWAP',
INPUT_BLOCK_TAP = 'INPUT_BLOCK_TAP',
```

Add corresponding payload interfaces:

```typescript
export interface RotatePayload { clockwise: boolean; }
export interface DragPayload { direction: number; } // 0 = stop, 1 = left, -1 = right
export interface SoftDropPayload { active: boolean; }
export interface BlockTapPayload { x: number; y: number; }
```

INPUT_SWIPE_UP and INPUT_SWAP don't need payloads.
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>6 new event types defined, 4 payload interfaces added</done>
</task>

<task type="auto">
  <name>Task 2: Refactor useInputHandlers to emit events</name>
  <files>hooks/useInputHandlers.ts</files>
  <action>
Import the new event types and gameEventBus. Replace callback invocations with event emissions:

**Before:**
```typescript
callbacks.onRotate(dir);
callbacks.onDragInput(dir);
callbacks.onSwipeUp();
callbacks.onSoftDrop(true);
callbacks.onSwap();
callbacks.onBlockTap(tapX, tapY);
```

**After:**
```typescript
gameEventBus.emit(GameEventType.INPUT_ROTATE, { clockwise: dir === 1 });
gameEventBus.emit(GameEventType.INPUT_DRAG, { direction: dir });
gameEventBus.emit(GameEventType.INPUT_SWIPE_UP);
gameEventBus.emit(GameEventType.INPUT_SOFT_DROP, { active: true });
gameEventBus.emit(GameEventType.INPUT_SWAP);
gameEventBus.emit(GameEventType.INPUT_BLOCK_TAP, { x: tapX, y: tapY });
```

**Important:** Keep the callbacks interface for now - we'll remove it in the next task. Just emit events IN ADDITION to calling callbacks. This allows incremental testing.

Update the hook to NOT require callbacks in the interface - make them optional with `?:` syntax.
  </action>
  <verify>npm run test:run - all 81 tests pass</verify>
  <done>useInputHandlers emits events for all 6 input types, callbacks are optional</done>
</task>

<task type="auto">
  <name>Task 3: Subscribe to input events in Game.tsx</name>
  <files>Game.tsx, components/GameBoard.tsx</files>
  <action>
**In Game.tsx:**
1. Add imports for new event types and payload interfaces
2. Add useEffect that subscribes to input events and calls the appropriate commands:

```typescript
useEffect(() => {
    const unsubRotate = gameEventBus.on<RotatePayload>(GameEventType.INPUT_ROTATE, (p) => {
        engine.execute(new RotatePieceCommand(p?.clockwise ?? true));
    });
    const unsubDrag = gameEventBus.on<DragPayload>(GameEventType.INPUT_DRAG, (p) => {
        dragDirectionRef.current = p?.direction ?? 0;
        if (p?.direction !== 0) startMovementLoop();
        else { /* existing stop logic */ }
    });
    const unsubSwipeUp = gameEventBus.on(GameEventType.INPUT_SWIPE_UP, () => {
        engine.execute(new SetPhaseCommand(GamePhase.CONSOLE));
    });
    const unsubSoftDrop = gameEventBus.on<SoftDropPayload>(GameEventType.INPUT_SOFT_DROP, (p) => {
        engine.execute(new SetSoftDropCommand(p?.active ?? false));
    });
    const unsubSwap = gameEventBus.on(GameEventType.INPUT_SWAP, () => {
        engine.execute(new SwapPieceCommand());
    });
    const unsubBlockTap = gameEventBus.on<BlockTapPayload>(GameEventType.INPUT_BLOCK_TAP, (p) => {
        if (p) engine.execute(new BlockTapCommand(p.x, p.y));
    });

    return () => {
        unsubRotate(); unsubDrag(); unsubSwipeUp();
        unsubSoftDrop(); unsubSwap(); unsubBlockTap();
    };
}, [engine, startMovementLoop, stopMovementLoop]);
```

**In GameBoard.tsx:**
3. Remove callback props from GameBoardProps interface (onRotate, onDragInput, onSwipeUp, onSoftDrop, onSwap, onBlockTap)
4. Remove callback props from component destructuring
5. Update useInputHandlers call to not pass callbacks (or pass empty object)

**In Game.tsx:**
6. Remove callback props from GameBoard component usage (onRotate, etc.)

This completes the event-based refactor for input handling.
  </action>
  <verify>npm run test:run passes, manual test: rotate/drag/swap/tap all work correctly</verify>
  <done>6 callback props removed from GameBoard, Game.tsx subscribes to events, input handling works via events</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` - No TypeScript errors
- [ ] `npm run test:run` - All 81 tests pass
- [ ] GameBoard.tsx no longer has onRotate, onDragInput, onSwipeUp, onSoftDrop, onSwap, onBlockTap props
- [ ] Input events flow: useInputHandlers → EventBus → Game.tsx → Commands
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- 6 callback props removed from GameBoard (prop drilling reduced)
- Event-based input handling works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/12-state-management/12-01-SUMMARY.md`
</output>
