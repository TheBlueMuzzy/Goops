# Plan 07-04: Max-Level Minigame Effects

## Objective

Implement the special max-level bonuses that make minigames simpler when upgrades are maxed out.

Purpose: Reward players who fully invest in a system with easier repairs.
Output: Minigames use simpler modes when corresponding upgrade is at level 5.

## Execution Context

~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-system-upgrades/07-01-SUMMARY.md
@.planning/phases/07-system-upgrades/07-02-SUMMARY.md
@.planning/phases/07-system-upgrades/07-03-SUMMARY.md
@components/Art.tsx

**Max-Level Bonuses (from PRD):**
| Upgrade | Max-Level Effect | Minigame Impact |
|---------|------------------|-----------------|
| LASER | No center targets | Reset Laser puzzle: removes "both lights ON" positions, only edge targets |
| LIGHTS | 3-button sequence | Reset Lights puzzle: watch/repeat 3 buttons instead of 4 |
| CONTROLS | 3 alignments | Reset Controls puzzle: align to 3 corners instead of 4 |

**Minigame Locations in Art.tsx:**
- Reset Laser: Sliders with target lights
- Reset Lights: Button sequence memory puzzle
- Reset Controls: Dial alignment puzzle

## Tasks

<task type="auto">
  <name>Task 1: Pass upgrade levels to minigame components</name>
  <files>components/Art.tsx, Game.tsx</files>
  <action>
The minigame logic in Art.tsx needs to know the current upgrade levels.

Add props to ConsoleLayoutSVG:
```typescript
interface ConsoleLayoutProps {
  // ...existing props
  upgradeLevels?: Record<string, number>; // LASER, LIGHTS, CONTROLS levels
}
```

Pass from Game.tsx (which gets powerUps from App.tsx).

Inside Art.tsx, extract the relevant levels:
```typescript
const laserUpgradeLevel = upgradeLevels?.['LASER'] || 0;
const lightsUpgradeLevel = upgradeLevels?.['LIGHTS'] || 0;
const controlsUpgradeLevel = upgradeLevels?.['CONTROLS'] || 0;

const isLaserMaxed = laserUpgradeLevel >= 5;
const isLightsMaxed = lightsUpgradeLevel >= 5;
const isControlsMaxed = controlsUpgradeLevel >= 5;
```
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>Upgrade levels available in minigame components</done>
</task>

<task type="auto">
  <name>Task 2: Implement LASER max-level effect (no center targets)</name>
  <files>components/Art.tsx</files>
  <action>
Find the Reset Laser minigame target generation logic. Currently generates random targets for 4 sliders.

When LASER is maxed (level 5), modify target generation:
- Instead of random targets including center (both lights ON), only use edge positions
- This means each slider target is either left-light-only or right-light-only, never both

Look for where slider targets are randomized (likely in a useEffect or when complication spawns).

```typescript
// Normal: targets can be any position
// Max level: targets can only be edge positions (not center)
const generateLaserTargets = (isMaxed: boolean) => {
  if (isMaxed) {
    // Only edge positions (no center/both-on)
    return [0, 1, 2, 3].map(() => Math.random() < 0.5 ? 'left' : 'right');
  } else {
    // Any position including center
    return [0, 1, 2, 3].map(() => {
      const r = Math.random();
      if (r < 0.33) return 'left';
      if (r < 0.66) return 'right';
      return 'center';
    });
  }
};
```

The actual implementation depends on how targets are stored - might be numeric positions. Adjust accordingly.
  </action>
  <verify>At max LASER level, Reset Laser puzzle should never have center targets</verify>
  <done>LASER max-level removes center targets from puzzle</done>
</task>

<task type="auto">
  <name>Task 3: Implement LIGHTS max-level effect (3-button sequence)</name>
  <files>components/Art.tsx</files>
  <action>
Find the Reset Lights sequence memory puzzle logic. Currently generates and plays a 4-button sequence.

When LIGHTS is maxed (level 5), generate only 3 buttons in sequence instead of 4.

Look for where the sequence length is defined:
```typescript
// Normal: 4-button sequence
// Max level: 3-button sequence
const sequenceLength = isLightsMaxed ? 3 : 4;
const sequence = Array.from({ length: sequenceLength }, () =>
  Math.floor(Math.random() * 4) // 4 possible buttons
);
```

This makes the puzzle faster to complete and easier to memorize.
  </action>
  <verify>At max LIGHTS level, sequence should only show 3 buttons to remember</verify>
  <done>LIGHTS max-level uses 3-button sequence instead of 4</done>
</task>

<task type="auto">
  <name>Task 4: Implement CONTROLS max-level effect (3 alignments)</name>
  <files>components/Art.tsx</files>
  <action>
Find the Reset Controls dial alignment puzzle logic. Currently requires aligning to 4 corners in sequence.

When CONTROLS is maxed (level 5), only require 3 alignments instead of 4.

Look for where the sequence of corners is generated:
```typescript
// Normal: 4 random corners to align
// Max level: 3 random corners to align
const alignmentCount = isControlsMaxed ? 3 : 4;
const corners = [45, 135, 225, 315]; // TR, BR, BL, TL
const targetSequence = Array.from({ length: alignmentCount }, () =>
  corners[Math.floor(Math.random() * 4)]
);
```

This reduces the time to complete the puzzle.
  </action>
  <verify>At max CONTROLS level, dial puzzle should only require 3 alignments</verify>
  <done>CONTROLS max-level uses 3 alignments instead of 4</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Max-level upgrade effects on minigames</what-built>
  <how-to-verify>
    1. Run: npm run dev -- --host
    2. Use dev rank selector to set rank high enough to trigger complications
    3. Open upgrade panel and max out each upgrade (use rank selector to get points)
    4. Test LASER: Trigger LASER complication, verify no center targets in puzzle
    5. Test LIGHTS: Trigger LIGHTS complication, verify only 3 buttons in sequence
    6. Test CONTROLS: Trigger CONTROLS complication, verify only 3 dial alignments needed
    7. Compare with non-maxed behavior (reset save and test without upgrades)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

## Verification

Before declaring plan complete:
- [ ] `npm run test:run` passes
- [ ] LASER max-level effect working (no center targets)
- [ ] LIGHTS max-level effect working (3-button sequence)
- [ ] CONTROLS max-level effect working (3 alignments)
- [ ] Non-maxed behavior unchanged

## Success Criteria

- All tasks completed
- All verification checks pass
- Max-level upgrades make minigames noticeably easier
- Phase 7 complete

## Output

After completion, create `.planning/phases/07-system-upgrades/07-04-SUMMARY.md`

Final summary should also note:
- Phase 7: System Upgrades - COMPLETE
- Total tests: [X]
- Milestone reached: Final phase of current roadmap
