# Plan 07-02: Upgrade Effects Implementation

## Objective

Wire the system upgrade effects into the game mechanics: LASER drain rate, LIGHTS trigger probability, CONTROLS heat dissipation.

Purpose: Make purchased upgrades actually affect gameplay.
Output: GameEngine uses upgrade levels to modify complication behavior.

## Execution Context

~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-system-upgrades/07-01-SUMMARY.md
@core/GameEngine.ts
@constants.ts

**Upgrade Effects:**
| Upgrade | Base Value | Per-Level Effect | At Max (Level 5) |
|---------|------------|------------------|------------------|
| LASER | 4 drain per pop | -5% per level | 3 drain per pop (75% of 4) |
| LIGHTS | 50% trigger | -6% per level | 20% trigger |
| CONTROLS | 50/sec dissipation | +10% per level | 75/sec dissipation |

**Current Implementation Locations:**
- LASER drain: `core/GameEngine.ts` or wherever capacitor drain happens
- LIGHTS trigger: `core/GameEngine.ts` tick() method, piece lock section
- CONTROLS dissipation: `core/GameEngine.ts` tick() method, heat drain section

## Tasks

<task type="auto">
  <name>Task 1: Implement LASER upgrade effect (reduced drain rate)</name>
  <files>core/GameEngine.ts</files>
  <action>
Find where laserCapacitor drains when popping goop. Currently it drains 4 per unit.

Modify to apply upgrade:
```typescript
// Get LASER upgrade level (0-5)
const laserLevel = this.powerUps['LASER'] || 0;
// Base drain is 4, reduced by 5% per level: 4 * (1 - 0.05 * level)
const drainMultiplier = 1 - (0.05 * laserLevel);
const drainAmount = 4 * drainMultiplier;
this.state.laserCapacitor = Math.max(0, this.state.laserCapacitor - (unitsPopped * drainAmount));
```

Search for where `laserCapacitor` is modified when popping and apply the upgrade effect.
  </action>
  <verify>Manual test: At rank 1+ with LASER upgrade, drain rate should be visibly slower</verify>
  <done>LASER upgrade reduces capacitor drain rate</done>
</task>

<task type="auto">
  <name>Task 2: Implement LIGHTS upgrade effect (reduced trigger probability)</name>
  <files>core/GameEngine.ts</files>
  <action>
Find the LIGHTS trigger logic in tick() method. Currently uses `Math.random() < 0.5` (50% chance).

Modify to apply upgrade:
```typescript
// Get LIGHTS upgrade level (0-5)
const lightsLevel = this.powerUps['LIGHTS'] || 0;
// Base trigger is 50%, reduced by 6% per level: 0.50 - (0.06 * level)
const triggerChance = 0.50 - (0.06 * lightsLevel);
// Min trigger chance is 20% at max level (0.50 - 0.30 = 0.20)

// In the existing check:
if (gap >= gapThreshold && Math.random() < triggerChance) {
    this.spawnComplication(ComplicationType.LIGHTS);
}
```

The existing code has `Math.random() < 0.5` - replace 0.5 with the calculated triggerChance.
  </action>
  <verify>Manual test: At rank 2+ with LIGHTS upgrade, malfunction should trigger less often</verify>
  <done>LIGHTS upgrade reduces trigger probability</done>
</task>

<task type="auto">
  <name>Task 3: Implement CONTROLS upgrade effect (faster heat dissipation)</name>
  <files>core/GameEngine.ts</files>
  <action>
Find the heat dissipation logic in tick(). Currently drains at 50/sec.

Modify to apply upgrade:
```typescript
// Get CONTROLS upgrade level (0-5)
const controlsLevel = this.powerUps['CONTROLS'] || 0;
// Base dissipation is 50/sec, increased by 10% per level: 50 * (1 + 0.10 * level)
const baseDrainRate = 50;
const drainRate = baseDrainRate * (1 + 0.10 * controlsLevel);
// At max level: 50 * 1.5 = 75/sec

this.state.controlsHeat = Math.max(0, this.state.controlsHeat - (drainRate * dt / 1000));
```

Replace the hardcoded `50` drain rate with the upgraded value.
  </action>
  <verify>Manual test: At rank 3+ with CONTROLS upgrade, heat meter should drain faster when idle</verify>
  <done>CONTROLS upgrade increases heat dissipation rate</done>
</task>

## Verification

Before declaring plan complete:
- [ ] `npm run test:run` passes
- [ ] LASER upgrade effect working (reduced drain)
- [ ] LIGHTS upgrade effect working (reduced trigger chance)
- [ ] CONTROLS upgrade effect working (faster dissipation)

## Success Criteria

- All tasks completed
- All verification checks pass
- Upgrades visibly affect gameplay when purchased
- No regression in existing complication behavior

## Output

After completion, create `.planning/phases/07-system-upgrades/07-02-SUMMARY.md`
