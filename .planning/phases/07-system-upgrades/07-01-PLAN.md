# Plan 07-01: System Upgrade Definitions

## Objective

Define the three system upgrades (Laser, Lights, Controls) with their effect values, costs, and max-level indicators. Replace the existing generic upgrades.

Purpose: Establish the upgrade data model so effects and UI can be built in subsequent plans.
Output: Updated constants.ts with SYSTEM_UPGRADE_CONFIG, updated types.ts for upgrade state.

## Execution Context

~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md

## Context

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@constants.ts
@types.ts

**From ROADMAP Phase 7:**
- Per-system upgrades: Laser System, Lights System, Controls System
- Percentage-based effects per level
- Max level special effects (simpler minigames)

**From PRD:**
- Laser: -5% drain rate per level, max level removes center targets
- Lights: -3% trigger probability per level, max level 3-button sequence
- Controls: +10% heat dissipation per level, max level 3 alignments

**Decision:** Replace existing generic upgrades (TIME_BONUS, STABILITY, SCORE_BOOST) with system-specific upgrades only.

## Tasks

<task type="auto">
  <name>Task 1: Define SYSTEM_UPGRADE_CONFIG in constants.ts</name>
  <files>constants.ts</files>
  <action>
Replace the existing UPGRADE_CONFIG with SYSTEM_UPGRADE_CONFIG containing three upgrades:

```typescript
export const SYSTEM_UPGRADE_CONFIG = {
  LASER: {
    id: 'LASER',
    name: 'CAPACITOR EFFICIENCY',
    desc: 'Reduces laser capacitor drain rate when popping goop.',
    costPerLevel: 1,
    maxLevel: 5,
    effectPerLevel: 0.05, // -5% drain per level (0.95, 0.90, 0.85, 0.80, 0.75)
    formatEffect: (lvl: number) => `-${lvl * 5}% Drain Rate`,
    maxLevelBonus: 'No center targets in Reset Laser puzzle'
  },
  LIGHTS: {
    id: 'LIGHTS',
    name: 'CIRCUIT STABILIZER',
    desc: 'Reduces probability of lights malfunction triggering.',
    costPerLevel: 1,
    maxLevel: 5,
    effectPerLevel: 0.06, // -6% trigger chance per level (44%, 38%, 32%, 26%, 20%)
    formatEffect: (lvl: number) => `-${lvl * 6}% Trigger Chance`,
    maxLevelBonus: '3-button sequence instead of 4'
  },
  CONTROLS: {
    id: 'CONTROLS',
    name: 'HEAT SINK UPGRADE',
    desc: 'Increases heat dissipation rate when idle.',
    costPerLevel: 1,
    maxLevel: 5,
    effectPerLevel: 0.10, // +10% dissipation per level (55, 60, 65, 70, 75 per sec)
    formatEffect: (lvl: number) => `+${lvl * 10}% Heat Dissipation`,
    maxLevelBonus: '3 alignments instead of 4'
  }
};

// For backwards compatibility, keep as alias (will remove in later cleanup)
export const UPGRADE_CONFIG = SYSTEM_UPGRADE_CONFIG;
```

Note: Using 5 levels per upgrade (15 total levels across 3 systems). At 1 point per rank, player can max all 3 systems by rank 15.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>SYSTEM_UPGRADE_CONFIG exported with LASER, LIGHTS, CONTROLS definitions</done>
</task>

<task type="auto">
  <name>Task 2: Update SaveData type for system upgrades</name>
  <files>types.ts</files>
  <action>
The existing SaveData already has `powerUps: Record<string, number>` which works for storing upgrade levels by ID. No changes needed to the type itself.

However, update the SaveData interface comment to clarify usage:

```typescript
export interface SaveData {
  rank: number;            // Current Player Rank (1-100)
  totalScore: number;      // Cumulative score across all runs
  powerUpPoints: number;   // Currency to buy upgrades (1 per rank + 1 per milestone)
  powerUps: Record<string, number>; // System upgrade levels: LASER, LIGHTS, CONTROLS (0-5)
  firstRunComplete: boolean;
  milestonesReached: number[];  // Milestone ranks achieved [10, 20, 30...]
  settings: {
    // ...existing
  };
}
```
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>SaveData comments clarified for system upgrade usage</done>
</task>

<task type="auto">
  <name>Task 3: Remove usage of old upgrade effects from GameEngine</name>
  <files>core/GameEngine.ts</files>
  <action>
Find and remove references to the old TIME_BONUS, STABILITY, SCORE_BOOST upgrades:

1. In constructor and applyUpgrades(), remove TIME_BONUS and STABILITY logic
2. In updateScoreAndStats(), remove SCORE_BOOST logic
3. Keep the `this.powerUps` property but it will now store LASER/LIGHTS/CONTROLS levels

The new system upgrades will be wired in Plan 07-02.

Remove these specific sections:
- `const timeBonusLevel = this.powerUps[UPGRADE_CONFIG.TIME_BONUS.id] || 0;`
- `const stabilityLevel = this.powerUps[UPGRADE_CONFIG.STABILITY.id] || 0;`
- `this.maxTime = INITIAL_TIME_MS + (timeBonusLevel * UPGRADE_CONFIG.TIME_BONUS.effectPerLevel);`
- `const stabilityMod = stabilityLevel * UPGRADE_CONFIG.STABILITY.effectPerLevel;`
- `const scoreBoostLevel = this.powerUps[UPGRADE_CONFIG.SCORE_BOOST.id] || 0;`
- Score boost modifier calculations

After removal, maxTime should just be INITIAL_TIME_MS, and score should not have boost modifier.
  </action>
  <verify>npm run test:run passes (may need to adjust tests if any depended on old upgrade behavior)</verify>
  <done>Old upgrade effects removed, GameEngine uses base values</done>
</task>

## Verification

Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test:run` passes
- [ ] SYSTEM_UPGRADE_CONFIG is properly exported
- [ ] Old UPGRADE_CONFIG effects removed from GameEngine

## Success Criteria

- All tasks completed
- All verification checks pass
- System upgrade definitions in place
- Old upgrade effects removed (clean slate for new effects)

## Output

After completion, create `.planning/phases/07-system-upgrades/07-01-SUMMARY.md`
