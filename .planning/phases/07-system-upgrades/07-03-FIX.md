---
phase: 07-system-upgrades
plan: 07-03-FIX
type: fix
---

<objective>
Fix 4 UAT issues from plan 07-03 (Upgrade UI Panel).

Source: 07-03-ISSUES.md
Priority: 0 critical, 2 major, 2 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/07-system-upgrades/07-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/07-system-upgrades/07-03-PLAN.md

**Key files:**
@components/UpgradePanel.tsx
@App.tsx
@constants.ts (for UPGRADES with unlockRank)
@components/EndGameScreen.tsx (styling reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Filter upgrades by rank</name>
  <files>components/UpgradePanel.tsx</files>
  <action>
Add `rank` prop to UpgradePanelProps interface.
Filter SYSTEM_UPGRADES to only show upgrades where `UPGRADES[upgradeId].unlockRank <= rank`.

Steps:
1. Add `rank: number` to UpgradePanelProps
2. Replace the static `SYSTEM_UPGRADES` array with a filtered version:
   ```typescript
   const availableUpgrades = SYSTEM_UPGRADES.filter(
     id => UPGRADES[id].unlockRank <= rank
   );
   ```
3. Map over `availableUpgrades` instead of `SYSTEM_UPGRADES`

This ensures only upgrades the player has unlocked are visible.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>UpgradePanel only shows upgrades where player rank >= unlockRank</done>
</task>

<task type="auto">
  <name>Task 2: Fix UAT-002 - Handle empty upgrades state</name>
  <files>components/UpgradePanel.tsx</files>
  <action>
When no upgrades are available (rank 0), show a helpful message instead of an empty list.

After filtering availableUpgrades, check if array is empty:
```typescript
{availableUpgrades.length === 0 ? (
  <div className="text-center py-8">
    <p className="text-slate-400 font-mono">NO UPGRADES AVAILABLE</p>
    <p className="text-slate-500 text-sm mt-2">Reach Rank 1 to unlock your first upgrade</p>
  </div>
) : (
  // existing map over availableUpgrades
)}
```

This handles the edge case of rank 0 gracefully without hiding the button.
  </action>
  <verify>At rank 0, panel shows "NO UPGRADES AVAILABLE" message</verify>
  <done>Empty state message shown when no upgrades unlocked</done>
</task>

<task type="auto">
  <name>Task 3: Fix UAT-003 - Reset powerUps when changing rank via dev selector</name>
  <files>App.tsx</files>
  <action>
In handleSetRank, when setting a specific rank (not wiping), also reset powerUps to empty object.

Current code (lines 86-95):
```typescript
} else {
    // Set to specific rank
    const newTotalScore = getScoreForMidRank(rank);
    setSaveData(prev => ({
        ...prev,
        totalScore: newTotalScore,
        rank: rank,
        powerUpPoints: rank // Points = rank level
    }));
```

Change to:
```typescript
} else {
    // Set to specific rank - reset powerUps so player can test fresh
    const newTotalScore = getScoreForMidRank(rank);
    setSaveData(prev => ({
        ...prev,
        totalScore: newTotalScore,
        rank: rank,
        powerUpPoints: rank, // Points = rank level
        powerUps: {} // Reset all purchased upgrades
    }));
```

This ensures dev testing starts fresh at each rank level.
  </action>
  <verify>Change rank via dev selector, verify powerUps are reset to empty</verify>
  <done>Dev rank selector resets powerUps when changing rank</done>
</task>

<task type="auto">
  <name>Task 4: Fix UAT-004 - Match panel styling to end-game screen</name>
  <files>components/UpgradePanel.tsx</files>
  <action>
Update the panel styling to match EndGameScreen.tsx design language:
- Background: #1f1f38 (dark blue) instead of slate-900
- Bezel: #f2a743 (orange) accent border
- Text: #6acbda (cyan) for labels, #fff for values
- Font: font-['Amazon_Ember'] where applicable, font-['From_Where_You_Are'] for headers
- Card backgrounds: #0c0f19 (near black) with white border outline

Key changes:
1. Modal background: Keep backdrop blur, but inner panel uses game colors
2. Header: Orange top bar (#f2a743) like monitor body
3. Upgrade cards: Dark blue (#0c0f19) with white 1px border like stats grid
4. Labels: Cyan (#6acbda)
5. Values/buttons: Keep system-specific colors (red/yellow/blue) but use game's darker shades

Update the Tailwind classes to use these custom colors via inline styles or CSS variables.
The goal is visual consistency, not pixel-perfect matching.
  </action>
  <verify>Visual inspection: Panel uses game color palette (dark blue, cyan labels, orange accents)</verify>
  <done>Panel styling matches end-game screen aesthetic</done>
</task>

<task type="auto">
  <name>Task 5: Pass rank prop to UpgradePanel</name>
  <files>components/ConsoleView.tsx</files>
  <action>
Update the UpgradePanel usage to pass the current rank.

In ConsoleView, rank is already calculated as `rankInfo.rank` (line 30).

Update the UpgradePanel component call (around line 279):
```typescript
<UpgradePanel
    powerUpPoints={powerUpPoints}
    upgrades={powerUps}
    rank={rankInfo.rank}  // Add this prop
    onPurchase={(id) => onPurchaseUpgrade?.(id)}
    onClose={() => setShowSystemUpgrades(false)}
/>
```
  </action>
  <verify>TypeScript compiles, rank prop flows to UpgradePanel</verify>
  <done>Rank prop connected from ConsoleView to UpgradePanel</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes
- [ ] At rank 0: Panel shows "No upgrades available" message
- [ ] At rank 1: Only LASER upgrade visible
- [ ] At rank 2: LASER and LIGHTS visible
- [ ] At rank 3+: All 3 upgrades visible
- [ ] Dev rank selector resets powerUps when changing rank
- [ ] Panel styling uses game color palette (visual check)
</verification>

<success_criteria>
- All 4 UAT issues from 07-03-ISSUES.md addressed
- Tests pass
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/07-system-upgrades/07-03-FIX-SUMMARY.md`
</output>
