# Plan 06-02: Milestone Infrastructure

## Objective

Add infrastructure for milestone unlocks at ranks 10, 20, 30, etc. This plan prepares the data structures and UI hooks without implementing actual milestone content (that comes in Phase 7).

## Execution Context

- `types.ts` - Milestone type definitions
- `utils/progression.ts` - Milestone detection
- `core/GameEngine.ts` - Milestone tracking
- `components/Art.tsx` - Milestone display (optional)

## Context

### Milestone System Design
From PRD and DESIGN_VISION.md:
- Milestones occur at ranks 10, 20, 30... up to 100
- Each milestone unlocks upgrade points
- Upgrade points are spent on system upgrades (Phase 7)

### Infrastructure Only
This plan creates the framework. Actual upgrades (UI, effects, costs) are Phase 7.

### Milestone Ranks
- Rank 10: 1 upgrade point
- Rank 20: 1 upgrade point
- Rank 30: 1 upgrade point
- ... (every 10 ranks)
- Rank 100: 1 upgrade point (10 total possible)

## Tasks

### Task 1: Define Milestone Types
**File**: `types.ts`
**Changes**:
1. Add `MilestoneData` interface:
   ```typescript
   interface MilestoneData {
     rank: number;           // 10, 20, 30...
     unlockedAt?: number;    // timestamp when reached
     upgradePointsAwarded: number; // 1 per milestone
   }
   ```
2. Add to persistent state (stored in localStorage):
   ```typescript
   interface PersistentState {
     totalScore: number;
     milestonesReached: number[];  // [10, 20, 30...] ranks achieved
     upgradePoints: number;        // total unspent points
   }
   ```

### Task 2: Add Milestone Detection
**File**: `utils/progression.ts`
**Changes**:
1. Add `getMilestoneRanks()` - returns [10, 20, 30... 100]
2. Add `getNextMilestone(currentRank)` - returns next milestone rank or null if at max
3. Add `getMilestonesInRange(fromRank, toRank)` - returns milestones crossed

**Verification**:
- `getMilestoneRanks()` returns [10, 20, 30, 40, 50, 60, 70, 80, 90, 100]
- `getNextMilestone(5)` returns 10
- `getNextMilestone(10)` returns 20
- `getNextMilestone(100)` returns null
- `getMilestonesInRange(8, 12)` returns [10]
- `getMilestonesInRange(18, 32)` returns [20, 30]

### Task 3: Track Milestones in GameEngine
**File**: `core/GameEngine.ts`
**Changes**:
1. In `finalizeGame()`, check if new milestones were reached
2. Award upgrade points for new milestones
3. Emit event for milestone reached (for future UI celebration)

**Logic**:
```typescript
const previousRank = calculateRankDetails(this.initialTotalScore).rank;
const newRank = calculateRankDetails(newTotalScore).rank;
const newMilestones = getMilestonesInRange(previousRank, newRank);

if (newMilestones.length > 0) {
  // Award points and track
  persistentState.upgradePoints += newMilestones.length;
  persistentState.milestonesReached.push(...newMilestones);
  gameEventBus.emit(GameEventType.MILESTONE_REACHED, { milestones: newMilestones });
}
```

### Task 4: Add Milestone Event Type
**File**: `core/events/GameEvents.ts`
**Changes**:
1. Add `MILESTONE_REACHED` to `GameEventType` enum
2. Define payload type with milestones array

### Task 5: Persist Milestone Data
**File**: `hooks/useGameEngine.ts` (or wherever localStorage is managed)
**Changes**:
1. Load `milestonesReached` and `upgradePoints` from localStorage
2. Save when milestones are reached
3. Initialize empty arrays for new players

## Verification

- [ ] All existing tests pass
- [ ] Milestone detection functions work correctly
- [ ] Starting from rank 9 and reaching rank 11 triggers milestone 10
- [ ] Upgrade points persist across sessions

## Success Criteria

- Milestone infrastructure ready for Phase 7 upgrades
- Upgrade points tracked and persisted
- No visible UI changes yet (just data layer)

## Output

- Modified `types.ts` (MilestoneData, PersistentState)
- Modified `utils/progression.ts` (milestone helpers)
- Modified `core/GameEngine.ts` (milestone tracking)
- Modified `core/events/GameEvents.ts` (new event)
- Modified hooks for localStorage persistence
