# Plan 06-01: XP Floor & Curve Retuning

## Objective

Implement XP floor mechanic and retune the rank progression curve for better pacing. Current curve is too steep for tutorial phase (rank 2â†’3 requires 12,411 XP).

## Execution Context

- `utils/progression.ts` - XP curve calculations
- `core/GameEngine.ts` - Score finalization
- `types.ts` - RankDetails type

## Context

### Current Problem
The current exponential formula (`5000 * (rank-1)^1.8`) creates:
- Rank 2: 5,000 XP total
- Rank 3: 17,411 XP total (12,411 XP gap - too steep!)
- Rank 10: ~158,490 XP total

This makes early ranks too punishing. A new player can easily hit rank 2 in one good session, but rank 3 feels unreachable.

### Research Findings
Based on game design research, the "linear delta" approach works best:
- Each level requires more XP than the last
- But the INCREASE is linear, not exponential
- Formula: `XP to next rank = baseXP + (rank - 1) * incrementXP`

### New Curve Design
Using `baseXP = 1500` and `incrementXP = 500`:

| Rank | XP to Next | Total XP |
|------|------------|----------|
| 1    | 1,500      | 0        |
| 2    | 2,000      | 1,500    |
| 3    | 2,500      | 3,500    |
| 5    | 3,500      | 9,000    |
| 10   | 6,000      | 31,500   |
| 20   | 11,000     | 113,500  |
| 50   | 26,000     | 618,500  |
| 100  | 51,000     | 2,574,000|

This gives:
- Fast tutorial phase (ranks 1-5 achievable in first few sessions)
- Steady mid-game progression (ranks 6-20)
- Long-term goals (ranks 50+)

### XP Floor Mechanic
From PRD: `xpGained = max(100 * currentRank, finalScore)`

At rank 10, minimum XP gain is 1,000. This prevents high-rank players from feeling punished by bad runs.

## Tasks

### Task 1: Implement New XP Curve
**File**: `utils/progression.ts`
**Changes**:
1. Replace exponential formula with linear delta formula
2. `getScoreForRank(rank)` should return sum of all thresholds up to rank
3. Formula: `totalXP = (rank - 1) * (baseXP + (rank - 2) * increment / 2)`
   - Simplified: `totalXP = (rank - 1) * (1500 + (rank - 2) * 250)`
   - For rank 1: returns 0
   - For rank 2: returns 1,500
   - For rank 3: returns 3,500

**Verification**:
- `getScoreForRank(1)` = 0
- `getScoreForRank(2)` = 1,500
- `getScoreForRank(3)` = 3,500
- `getScoreForRank(5)` = 9,000
- `getScoreForRank(10)` = 31,500
- `getScoreForRank(100)` = 2,574,000

### Task 2: Add XP Floor Mechanic
**File**: `core/GameEngine.ts`
**Changes**:
1. In `finalizeGame()`, apply XP floor before adding to total score
2. Calculate floor: `100 * startingRank`
3. Final XP: `Math.max(floor, this.state.score)`

**Verification**:
- At rank 1, minimum XP gain is 100
- At rank 10, minimum XP gain is 1,000
- At rank 50, minimum XP gain is 5,000

### Task 3: Update Tests
**File**: `tests/progression.test.ts` (new file)
**Changes**:
1. Test `getScoreForRank()` returns expected values
2. Test `calculateRankDetails()` correctly calculates progress
3. Test edge cases (rank 1, max rank)

## Verification

- [ ] All existing tests pass
- [ ] New progression tests pass
- [ ] Manual test: Start at rank 1, check XP needed for rank 2 is 1,500
- [ ] Manual test: Dev tool can set rank to verify curve at higher ranks

## Success Criteria

- XP curve provides smooth progression through tutorial ranks (1-5)
- XP floor prevents zero-gain runs at higher ranks
- Tests verify curve calculations

## Output

- Modified `utils/progression.ts`
- Modified `core/GameEngine.ts`
- New `tests/progression.test.ts`
