---
phase: 15-onboarding-band
plan: 04
type: execute
---

<objective>
Implement AUTO_POPPER (end-game auto-pop mechanic) and COOLDOWN_BOOSTER (active ability that extends complication cooldowns).

Purpose: Complete the Onboarding Band with the final passive and the first active ability.
Output: AUTO_POPPER reduces end-game penalty, COOLDOWN_BOOSTER can be equipped and activated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-onboarding-band/15-03-SUMMARY.md (will exist after plan 03)

**Upgrade Effects from constants.ts:**
| Upgrade | Type | Rank | effectPerLevel | Description |
|---------|------|------|----------------|-------------|
| AUTO_POPPER | passive | 3 | 0.04 | Reduces decay penalty at end of game |
| COOLDOWN_BOOSTER | active | 5 | 0.25 | +25% cooldown extension when activated |

**AUTO_POPPER mechanic (from STATE.md):**
> At end of game, remaining goop has a chance to auto-pop before penalty.
> Base decay: -20% per unit. Each level reduces decay by 4%.
> Level 0: -20%, Level 1: -16%, Level 2: -12%, Level 3: -8%, Level 4: -4%

**COOLDOWN_BOOSTER mechanic:**
- Active ability (requires equipping)
- When activated, extends ALL active complication cooldowns by 25%
- Uses cooldown system (not chargeCost yet — that's for later phases)

**Active ability infrastructure:**
- SaveData.equippedActives: string[] — IDs of equipped actives
- Need UI to equip/activate (may be checkpoint for manual testing)
- Need activation trigger in gameplay

**Note:** The active ability system (equipping, activation UI, cooldown management) may not be fully built yet. This plan focuses on the AUTO_POPPER mechanic and basic COOLDOWN_BOOSTER effect logic. Full active UI can be a separate phase if needed.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement AUTO_POPPER end-game mechanic</name>
  <files>core/GameEngine.ts, utils/gameLogic.ts</files>
  <action>
Find the end-game scoring/penalty code. When time runs out, there should be logic that:
1. Counts remaining goop on the board
2. Applies a penalty (or reduces score)

Add AUTO_POPPER logic before penalty calculation:

```typescript
// In end-game processing (likely in handleGameOver or similar)
const autoPopperLevel = this.powerUps['AUTO_POPPER'] || 0;

// Count remaining goop
let remainingGoop = countRemainingGoop(this.state.grid);

// AUTO_POPPER: Each remaining unit has chance to auto-pop
if (autoPopperLevel > 0) {
  // Base decay is 20%, reduced by 4% per level
  const decayChance = 0.20 - (autoPopperLevel * 0.04);
  // decayChance = 0.20, 0.16, 0.12, 0.08, 0.04 for levels 0-4

  let autoPoppedCount = 0;
  for (let i = 0; i < remainingGoop; i++) {
    // Each unit has (1 - decayChance) chance to auto-pop
    if (Math.random() > decayChance) {
      autoPoppedCount++;
    }
  }
  remainingGoop -= autoPoppedCount;

  // Log for debugging
  console.log(`AUTO_POPPER: ${autoPoppedCount} of ${remainingGoop + autoPoppedCount} goop auto-popped`);
}

// Apply penalty based on remaining (non-auto-popped) goop
const penalty = remainingGoop * PENALTY_PER_GOOP; // or whatever the penalty formula is
```

If there's no penalty system yet, note in summary that AUTO_POPPER effect is ready but awaits penalty implementation.
  </action>
  <verify>npm run test:run — all tests pass</verify>
  <done>AUTO_POPPER reduces effective end-game penalty via probabilistic auto-pop</done>
</task>

<task type="auto">
  <name>Task 2: Add COOLDOWN_BOOSTER effect function</name>
  <files>core/ComplicationManager.ts</files>
  <action>
Add a function to extend all complication cooldowns:

```typescript
/**
 * Extend all active complication cooldowns by a percentage.
 * Used by COOLDOWN_BOOSTER active ability.
 */
extendAllCooldowns(
  state: GameState,
  extensionPercent: number // 0.25 = 25%
): void {
  const now = Date.now();

  for (const type of Object.values(ComplicationType)) {
    const cooldownEnd = state.complicationCooldowns[type];
    if (cooldownEnd > now) {
      // Cooldown is active, extend it
      const remainingMs = cooldownEnd - now;
      const extensionMs = remainingMs * extensionPercent;
      state.complicationCooldowns[type] = cooldownEnd + extensionMs;
    }
  }
}
```

This provides the effect. The activation UI/trigger will be added when the active ability system is built.
  </action>
  <verify>npm run test:run — all tests pass</verify>
  <done>COOLDOWN_BOOSTER effect function exists in ComplicationManager</done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>How to handle active ability UI for COOLDOWN_BOOSTER?</decision>
  <context>
COOLDOWN_BOOSTER is an active ability that needs:
1. UI to equip it (UpgradePanel or separate screen)
2. UI to activate during gameplay (button/tap)
3. Cooldown tracking for the ability itself

This infrastructure doesn't exist yet. Options for proceeding:
  </context>
  <options>
    <option id="defer-ui">
      <name>Defer active UI to Phase 16</name>
      <pros>Keep Phase 15 focused on passives. Active system can be designed properly when Junk Band adds GOOP_DUMP (another active).</pros>
      <cons>COOLDOWN_BOOSTER unlockable but not usable until Phase 16.</cons>
    </option>
    <option id="minimal-ui">
      <name>Add minimal activation button now</name>
      <pros>Players can use COOLDOWN_BOOSTER immediately. Tests active ability flow early.</pros>
      <cons>May need redesign when more actives are added. Extra work in this phase.</cons>
    </option>
  </options>
  <resume-signal>Select: defer-ui or minimal-ui</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] `npm run build` succeeds
- [ ] AUTO_POPPER: Verify end-game auto-pop logic (may need manual testing or unit test)
- [ ] COOLDOWN_BOOSTER: extendAllCooldowns function exists and compiles
- [ ] Decision made on active UI approach
</verification>

<success_criteria>
- AUTO_POPPER reduces end-game penalty via probabilistic auto-pop
- COOLDOWN_BOOSTER effect function ready for activation
- Clear decision on active ability UI timeline
- Phase 15: Onboarding Band complete (all 8 upgrades implemented or ready)
</success_criteria>

<output>
After completion, create `.planning/phases/15-onboarding-band/15-04-SUMMARY.md` including:
- AUTO_POPPER implementation details
- COOLDOWN_BOOSTER status (effect ready, UI decision)
- Phase 15 completion summary
</output>
