---
phase: 15-onboarding-band
plan: 01
type: execute
---

<objective>
Migrate upgrade system from old complication-based IDs (LASER/LIGHTS/CONTROLS) to new v1.2 upgrade IDs and update UpgradePanel to show all passive upgrades by rank.

Purpose: Foundation for all Phase 15 work — code must reference correct upgrade IDs before effects can be wired.
Output: All code uses new upgrade IDs. UpgradePanel shows 8 Onboarding Band passives.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-data-architecture/14-01-SUMMARY.md
@.planning/phases/14-data-architecture/14-02-SUMMARY.md

**Tech available:** v1.2 upgrade schema with 20 upgrades in constants.ts
**Established patterns:** `engine.powerUps['UPGRADE_ID'] || 0` for level lookup

**ID Migration Map:**
| Old ID | New ID | Effect |
|--------|--------|--------|
| LASER | CAPACITOR_EFFICIENCY | Reduces capacitor drain |
| LIGHTS | CIRCUIT_STABILIZER | Reduces trigger chance |
| CONTROLS | GEAR_LUBRICATION | Increases heat dissipation |

**Files to update:**
- `core/GameEngine.ts` - CONTROLS → GEAR_LUBRICATION
- `core/ComplicationManager.ts` - LIGHTS → CIRCUIT_STABILIZER
- `core/commands/actions.ts` - LASER → CAPACITOR_EFFICIENCY
- `components/Art.tsx` - Max-level checks use old IDs
- `components/UpgradePanel.tsx` - SYSTEM_UPGRADES list, UPGRADE_ACCENTS colors

**New UpgradePanel behavior:**
- Show all passive upgrades where unlockRank <= player rank
- Filter out actives and features (those need different UI)
- Use upgrade's own color scheme (not complication colors)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update upgrade ID references in game logic</name>
  <files>core/GameEngine.ts, core/ComplicationManager.ts, core/commands/actions.ts</files>
  <action>
Replace old complication-based upgrade IDs with new v1.2 upgrade IDs:

1. `core/GameEngine.ts` line ~435:
   - Change `this.powerUps['CONTROLS']` to `this.powerUps['GEAR_LUBRICATION']`

2. `core/ComplicationManager.ts` line ~171:
   - Change `powerUps['LIGHTS']` to `powerUps['CIRCUIT_STABILIZER']`

3. `core/commands/actions.ts` line ~255:
   - Change `engine.powerUps['LASER']` to `engine.powerUps['CAPACITOR_EFFICIENCY']`

Also update complicationConfig.ts to use new upgrade effect values:
- LASER drainUpgradeEffect: 0.05 → use CAPACITOR_EFFICIENCY.effectPerLevel (0.0625)
- LIGHTS triggerUpgradeEffect: 0.06 → use CIRCUIT_STABILIZER.effectPerLevel (0.075)
- CONTROLS dissipationUpgradeEffect: 0.10 → use GEAR_LUBRICATION.effectPerLevel (0.125)

Import UPGRADES from constants.ts where needed to access effectPerLevel values dynamically.
  </action>
  <verify>npm run test:run — all 112 tests pass</verify>
  <done>All game logic references new upgrade IDs, effect values match UPGRADES config</done>
</task>

<task type="auto">
  <name>Task 2: Update Art.tsx max-level upgrade checks</name>
  <files>components/Art.tsx</files>
  <action>
Update max-level flag checks (~line 98-100):

Before:
```typescript
const isLaserMaxed = (upgradeLevels['LASER'] || 0) >= 5;
const isLightsMaxed = (upgradeLevels['LIGHTS'] || 0) >= 5;
const isControlsMaxed = (upgradeLevels['CONTROLS'] || 0) >= 5;
```

After:
```typescript
const isLaserMaxed = (upgradeLevels['CAPACITOR_EFFICIENCY'] || 0) >= UPGRADES.CAPACITOR_EFFICIENCY.maxLevel;
const isLightsMaxed = (upgradeLevels['CIRCUIT_STABILIZER'] || 0) >= UPGRADES.CIRCUIT_STABILIZER.maxLevel;
const isControlsMaxed = (upgradeLevels['GEAR_LUBRICATION'] || 0) >= UPGRADES.GEAR_LUBRICATION.maxLevel;
```

Import UPGRADES from constants.ts at top of file.
  </action>
  <verify>npm run test:run — all tests pass</verify>
  <done>Art.tsx uses new upgrade IDs and dynamic maxLevel from config</done>
</task>

<task type="auto">
  <name>Task 3: Rewrite UpgradePanel for v1.2 passive upgrades</name>
  <files>components/UpgradePanel.tsx</files>
  <action>
Replace hardcoded SYSTEM_UPGRADES with dynamic passive filter:

1. Remove `const SYSTEM_UPGRADES = ['LASER', 'LIGHTS', 'CONTROLS']`

2. In component, filter upgrades dynamically:
```typescript
const availableUpgrades = Object.values(UPGRADES)
  .filter(u => u.type === 'passive' && u.unlockRank <= rank)
  .sort((a, b) => a.unlockRank - b.unlockRank);
```

3. Replace UPGRADE_ACCENTS with a simpler scheme — use complication type to determine color:
```typescript
const getUpgradeAccent = (upgradeId: string) => {
  // Complication-related upgrades get complication colors
  if (upgradeId === 'CAPACITOR_EFFICIENCY') return { accent: '#d82727', text: '#ff6b6b' }; // LASER red
  if (upgradeId === 'CIRCUIT_STABILIZER') return { accent: '#d36b28', text: '#ffa94d' }; // LIGHTS orange
  if (upgradeId === 'GEAR_LUBRICATION') return { accent: '#2d5a87', text: '#74c0fc' }; // CONTROLS blue
  // Default for other passives
  return { accent: '#2d7a4d', text: '#5bbc70' }; // Green
};
```

4. Update the map to use `upgrade.id` instead of string index:
```typescript
{availableUpgrades.map(upgrade => {
  const currentLevel = upgrades[upgrade.id] || 0;
  const accent = getUpgradeAccent(upgrade.id);
  // ... rest of render
})}
```

5. Update header text from "SYSTEM UPGRADES" to "PASSIVE UPGRADES"
  </action>
  <verify>npm run dev -- --host, open browser, verify upgrades panel shows correct upgrades for rank</verify>
  <done>UpgradePanel shows all passive upgrades unlocked at player's rank, sorted by unlockRank</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all 112 tests
- [ ] `npm run build` succeeds without TypeScript errors
- [ ] Dev server: rank 0-1 player sees no upgrades (first passive at rank 2)
- [ ] Dev server: rank 5 player sees 4 upgrades (CIRCUIT_STABILIZER, AUTO_POPPER, CAPACITOR_EFFICIENCY, COOLDOWN_BOOSTER... wait, COOLDOWN_BOOSTER is active, should not show)
- [ ] Verify only passives show, not actives
</verification>

<success_criteria>
- All game logic uses new v1.2 upgrade IDs
- UpgradePanel dynamically filters passive upgrades by rank
- No references to old IDs (LASER/LIGHTS/CONTROLS) in upgrade lookup code
- Tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/15-onboarding-band/15-01-SUMMARY.md`
</output>
