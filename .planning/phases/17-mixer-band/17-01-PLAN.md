---
phase: 17-mixer-band
plan: 01
type: execute
---

<objective>
Implement Purple color verification and ACTIVE_EXPANSION_SLOT for 2nd active ability slot.

Purpose: Enable rank 20+ players to equip two active abilities simultaneously.
Output: Purple color works at rank 20+, players can equip 2 actives when they own ACTIVE_EXPANSION_SLOT.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-onboarding-band/15-04-SUMMARY.md
@.planning/phases/16-junk-band/16-02-SUMMARY.md

**Key files:**
@constants.ts (COLORS.PURPLE already defined, UPGRADES.ACTIVE_EXPANSION_SLOT defined)
@utils/gameLogic.ts (getPaletteForRank - needs Purple at rank 20+)
@App.tsx (equippedActives state, handleToggleEquip)
@components/UpgradePanel.tsx (equip checkbox logic)

**Purple color:**
- Already defined in constants.ts as COLORS.PURPLE = '#a855f7'
- Need to add to palette at rank 20+ in getPaletteForRank

**ACTIVE_EXPANSION_SLOT mechanic:**
- Feature upgrade (type: 'feature'), unlocks at rank 20
- When owned (level 1), player can equip 2 actives instead of 1
- UI: UpgradePanel already has equip checkbox - just need slot limit check
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Purple to color palette at rank 20+</name>
  <files>utils/gameLogic.ts</files>
  <action>
In getPaletteForRank function, add COLORS.PURPLE to the palette when rank >= 20.

Currently the function adds Orange at rank 10+. Follow same pattern:
```typescript
if (rank >= 20) {
    palette.push(COLORS.PURPLE);
}
```

Ensure import of COLORS includes PURPLE (already should be there).
  </action>
  <verify>Run `npm run test:run`. Check getPaletteForRank(20) returns 6 colors including purple.</verify>
  <done>Purple color appears in palette at rank 20+, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Implement active slot limit based on ACTIVE_EXPANSION_SLOT</name>
  <files>App.tsx</files>
  <action>
In App.tsx, find handleToggleEquip function. Currently it should allow only 1 equipped active.

Update the slot limit calculation:
```typescript
// Calculate max active slots based on upgrades
const baseSlots = 1;
const expansionSlot1 = (saveData.powerUps['ACTIVE_EXPANSION_SLOT'] || 0) >= 1 ? 1 : 0;
// Future: const expansionSlot2 = (saveData.powerUps['ACTIVE_EXPANSION_SLOT_2'] || 0) >= 1 ? 1 : 0;
const maxSlots = baseSlots + expansionSlot1;
```

When toggling equip on:
- If already at maxSlots, don't add (or optionally unequip oldest)
- For simplicity: just reject equip if at max

Note: The equip checkbox should be disabled in UpgradePanel when at max slots.
  </action>
  <verify>Run `npm run test:run`. Manual test: at rank 20+ with ACTIVE_EXPANSION_SLOT purchased, verify can equip 2 actives.</verify>
  <done>Players with ACTIVE_EXPANSION_SLOT can equip 2 active abilities</done>
</task>

<task type="auto">
  <name>Task 3: Update UpgradePanel to show slot count and disable at max</name>
  <files>components/UpgradePanel.tsx</files>
  <action>
In UpgradePanel:

1. Accept maxActiveSlots prop (calculated in App.tsx and passed down)
2. Show equipped count: "Active Abilities (X/Y equipped)" where X = current, Y = max
3. Disable equip checkbox for unequipped actives when at max slots

Props addition:
```typescript
interface UpgradePanelProps {
  // ... existing props
  maxActiveSlots?: number;  // Max actives player can equip
}
```

In the active abilities section header:
```tsx
<h4>Active Abilities ({equippedActives.length}/{maxActiveSlots} equipped)</h4>
```

For each active's equip checkbox:
```tsx
disabled={!isEquipped && equippedActives.length >= maxActiveSlots}
```
  </action>
  <verify>Run `npm run test:run`. Visual check: UpgradePanel shows slot count, checkboxes disabled when at limit.</verify>
  <done>UpgradePanel shows active slot usage and prevents over-equipping</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] No TypeScript errors
- [ ] Purple color appears in palette at rank 20+
- [ ] ACTIVE_EXPANSION_SLOT allows 2 equipped actives
- [ ] UpgradePanel prevents equipping more than max slots
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Purple color unlocks at rank 20
- 2nd active slot works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/17-mixer-band/17-01-SUMMARY.md` with:
- What was built
- Any deviations from plan
- Files modified
</output>
