---
phase: 17-mixer-band
plan: 03
type: execute
---

<objective>
Implement GOOP_COLORIZER active ability.

Purpose: When activated, next 5 goop pieces match the current falling piece's color.
Output: GOOP_COLORIZER active ability works - charges, activates, and affects next 5 pieces.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-mixer-band/17-02-PLAN.md
@.planning/phases/15-onboarding-band/15-04-SUMMARY.md

**Key files:**
@constants.ts (UPGRADES.GOOP_COLORIZER at rank 25)
@types.ts (GameState - needs colorizerRemaining counter)
@core/GameEngine.ts (activateAbility, spawnNewPiece)

**GOOP_COLORIZER mechanic (from PRD):**
- Active ability unlocked at rank 25
- When activated: "Next 5 goop are same color as current falling goop"
- Needs to track remaining colorized pieces in state
- On piece spawn, if colorizerRemaining > 0, force color to match

**Implementation approach:**
- Add colorizerColor and colorizerRemaining to GameState
- In activateAbility('GOOP_COLORIZER'): set colorizerRemaining = 5, colorizerColor = activePiece.color
- In spawnNewPiece: if colorizerRemaining > 0, override piece color, decrement counter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add colorizer state tracking</name>
  <files>types.ts, core/GameEngine.ts</files>
  <action>
1. In types.ts GameState interface, add:
```typescript
// GOOP_COLORIZER tracking
colorizerColor: string | null;    // Locked color for next N pieces
colorizerRemaining: number;       // Pieces left with forced color
```

2. In GameEngine constructor state initialization:
```typescript
colorizerColor: null,
colorizerRemaining: 0,
```

3. In GameEngine.startRun() state reset:
```typescript
colorizerColor: null,
colorizerRemaining: 0,
```
  </action>
  <verify>Run `npm run test:run`. TypeScript compiles without errors.</verify>
  <done>GameState tracks colorizer effect</done>
</task>

<task type="auto">
  <name>Task 2: Implement GOOP_COLORIZER activation</name>
  <files>core/GameEngine.ts</files>
  <action>
In activateAbility method, add case for GOOP_COLORIZER:

```typescript
case 'GOOP_COLORIZER': {
    // Lock next 5 pieces to current falling piece's color
    const targetColor = this.state.activePiece?.definition.color;
    if (!targetColor) {
        console.log('GOOP_COLORIZER: No active piece to match color');
        break;
    }

    this.state.colorizerColor = targetColor;
    this.state.colorizerRemaining = 5;
    console.log(`GOOP_COLORIZER activated: next 5 pieces will be ${targetColor}`);
    break;
}
```
  </action>
  <verify>Run `npm run test:run`. Activating GOOP_COLORIZER sets colorizerRemaining to 5.</verify>
  <done>GOOP_COLORIZER activation sets up 5-piece color lock</done>
</task>

<task type="auto">
  <name>Task 3: Apply colorizer effect in spawnNewPiece</name>
  <files>core/GameEngine.ts</files>
  <action>
In spawnNewPiece method, after determining the piece to spawn but before finalizing:

```typescript
// Apply GOOP_COLORIZER effect if active
if (this.state.colorizerRemaining > 0 && this.state.colorizerColor) {
    // Override the piece color
    piece.definition = {
        ...piece.definition,
        color: this.state.colorizerColor
    };
    this.state.colorizerRemaining--;

    // Also update nextPiece if it exists (so preview shows correct color)
    if (this.state.nextPiece && this.state.colorizerRemaining > 0) {
        this.state.nextPiece = {
            ...this.state.nextPiece,
            color: this.state.colorizerColor
        };
    }

    console.log(`GOOP_COLORIZER: Spawned ${this.state.colorizerColor} piece (${this.state.colorizerRemaining} remaining)`);

    // Clear colorizer when done
    if (this.state.colorizerRemaining === 0) {
        this.state.colorizerColor = null;
    }
}
```

Place this after `const piece = spawnPiece(...)` but before setting `this.state.activePiece = piece`.
  </action>
  <verify>Run `npm run test:run`. Manual test: activate GOOP_COLORIZER, verify next 5 pieces are same color.</verify>
  <done>GOOP_COLORIZER forces next 5 pieces to match locked color</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] No TypeScript errors
- [ ] GOOP_COLORIZER can be equipped and charged
- [ ] Activating sets colorizerRemaining = 5
- [ ] Next 5 spawned pieces have forced color
- [ ] Effect clears after 5 pieces
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- GOOP_COLORIZER active ability fully functional
- Phase 17 complete
</success_criteria>

<output>
After completion, create `.planning/phases/17-mixer-band/17-03-SUMMARY.md` with:
- What was built
- Any deviations from plan
- Phase 17 completion status
</output>
