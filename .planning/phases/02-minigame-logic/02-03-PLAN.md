# Plan 02-03: Reset Controls Logic

## Goal

Implement dial alignment puzzle for Reset Controls: align to 4 corners in sequence, pressing to confirm each.

## Prerequisites

- Plan 02-01 complete (shake animation)
- Phase 1 complete (dial rotation working)

## Implementation Steps

### Step 1: Add complication state structure

```tsx
interface ControlsComplication {
    active: boolean;
    solved: boolean;
    targetCorner: 0 | 1 | 2 | 3 | null; // Which corner is lit (45°, 135°, 225°, 315°)
    completedCorners: number; // 0-4 count of completed alignments
    lastCorner: 0 | 1 | 2 | 3 | null; // Prevent repeat
}

const CORNER_ANGLES = [45, 135, 225, 315];

const [controlsComplication, setControlsComplication] = useState<ControlsComplication>({
    active: false,
    solved: false,
    targetCorner: null,
    completedCorners: 0,
    lastCorner: null
});
```

### Step 2: Control corner indicator lights

4 corner lights around the dial:
- Complication inactive: all black
- Complication active: orange for targetCorner, black for others

### Step 3: Check dial alignment

Dial is aligned when current rotation (normalized to 0-360) is within threshold of target angle.

```tsx
const isDialAligned = () => {
    if (controlsComplication.targetCorner === null) return false;

    const targetAngle = CORNER_ANGLES[controlsComplication.targetCorner];
    const currentAngle = ((localDialRotation % 360) + 360) % 360;
    const diff = Math.abs(currentAngle - targetAngle);
    const normalizedDiff = Math.min(diff, 360 - diff);

    return normalizedDiff < 15; // 15° tolerance
};
```

### Step 4: Show "PRESS" text conditionally

Only show "PRESS" text when dial is aligned:
- Find/add "PRESS" text element in SVG
- Visibility: `isDialAligned() ? 'visible' : 'hidden'`

### Step 5: Handle dial press

Add click/tap handler to dial:
```tsx
const handleDialPress = () => {
    if (!controlsComplication.active || controlsComplication.solved) return;

    if (isDialAligned()) {
        // Success - advance to next corner
        const newCompleted = controlsComplication.completedCorners + 1;

        if (newCompleted >= 4) {
            // Solved!
            setControlsComplication(prev => ({
                ...prev,
                solved: true,
                targetCorner: null,
                completedCorners: 4
            }));
        } else {
            // Pick next random corner (not same as current)
            const availableCorners = [0, 1, 2, 3].filter(
                c => c !== controlsComplication.targetCorner
            );
            const nextCorner = availableCorners[
                Math.floor(Math.random() * availableCorners.length)
            ];

            setControlsComplication(prev => ({
                ...prev,
                targetCorner: nextCorner as 0 | 1 | 2 | 3,
                completedCorners: newCompleted,
                lastCorner: prev.targetCorner
            }));
        }
    } else {
        // Wrong - shake the dial
        triggerDialShake();
    }
};
```

### Step 6: Shake the dial

Add shake state for dial:
```tsx
const [dialShaking, setDialShaking] = useState(false);

const triggerDialShake = () => {
    setDialShaking(true);
    setTimeout(() => setDialShaking(false), 300);
};
```

Apply `shake-anim` class to dial group when shaking.

### Step 7: Activation

```tsx
const activateControlsComplication = () => {
    const firstCorner = Math.floor(Math.random() * 4) as 0 | 1 | 2 | 3;

    setControlsComplication({
        active: true,
        solved: false,
        targetCorner: firstCorner,
        completedCorners: 0,
        lastCorner: null
    });
};
```

### Step 8: Text color

Reset Controls label text color:
- TEAL when `!active`
- RED when `active && !solved`
- GREEN when `active && solved`

## SVG Element Details

**Reset Controls corner lights** (Art.tsx lines 622-638):
- Top-left: x=103.94, y≈1508, currently `fill="#231f20"` (off) — corresponds to dial angle 135°
- Top-right: x=288.3, y≈1508, currently `fill="#231f20"` (off) — corresponds to dial angle 45°
- Bottom-left: x=103.94, y≈1696, currently `fill="#231f20"` (off) — corresponds to dial angle 225°
- Bottom-right: x=288.3, y≈1696, currently `fill="#d8672b"` (on) — corresponds to dial angle 315°

**Color values**:
- Orange on: `fill="#d8672b"`
- Black off: `fill="#231f20"`

**Dial center**: x=194.32, y=1604.12 (from shadow circle)

**"PRESS" text**: Add dynamically, position near dial center or below it.

**Dial press handling**: Should ignore press if currently dragging (drag end should not trigger press).

## Testing

- Activate → one corner light on
- Rotate dial to that corner → "PRESS" appears
- Click dial → light moves to different corner, counter increases
- 4 successful presses → solved (green)
- Press when not aligned → dial shakes

## Files to Modify

- `components/Art.tsx` — complication state, alignment check, press handler, PRESS text, shake
