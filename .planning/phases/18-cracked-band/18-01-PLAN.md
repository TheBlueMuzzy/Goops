---
phase: 18-cracked-band
plan: 01
type: execute
---

<objective>
Implement the Expanding Cracks mechanic and SLOW_CRACKS passive upgrade.

Purpose: Add the core mechanic that defines the Cracked Band â€” cracks that grow over time if not sealed, creating urgency. SLOW_CRACKS provides player mitigation.
Output: Cracks grow based on pressure, SLOW_CRACKS reduces growth chance per level.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-mixer-band/17-03-SUMMARY.md

# Key files:
@core/GameEngine.ts
@core/GoalManager.ts
@types.ts
@constants.ts
@utils/gameLogic.ts

# PRD Definition:
**Expanding Cracks mechanic:** Cracks grow every 5s from inception. Growth chance = current pressure percentage.
**SLOW_CRACKS:** -5% growth chance offset per level (max 4 levels = -20%)

# Note: White color already implemented in getPaletteForRank (rank >= 30)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add expanding cracks state tracking and growth mechanic</name>
  <files>types.ts, core/GameEngine.ts, core/GoalManager.ts</files>
  <action>
1. Add `crackSpawnTimes` tracking to GoalMark or track crack age separately in GameState (e.g., `crackGrowthTimers: Record<string, number>` mapping goal ID to last growth check time)
2. Add `tickCrackGrowth()` method to GameEngine that runs every tick:
   - For each existing goalMark, check if 5 seconds have passed since last growth check
   - If so, calculate growth chance = pressureRatio (timeElapsed / maxTime as decimal 0-1)
   - Roll random, if <= growthChance, the crack "grows" - spawn an additional crack nearby (adjacent cell if empty)
   - Apply SLOW_CRACKS reduction: growthChance = max(0, pressureRatio - (slowCracksLevel * 0.05))
   - Update crack growth timer
3. Call tickCrackGrowth() from the tick() method (after tickGoals)
4. Growth only happens at rank 30+ (check startRank at session start, store as class property)

AVOID: Don't make cracks grow unbounded - cap at reasonable limit (e.g., max 8 active cracks). Don't grow cracks when game is paused (check phase === CONSOLE or COMPLICATION_MINIGAME).
  </action>
  <verify>
- npm run test:run passes
- At rank 30+, observe cracks growing when not sealed quickly (debug log growth events)
- Growth rate correlates with pressure (higher pressure = more growth)
  </verify>
  <done>Cracks grow every 5s based on pressure percentage. Growth tracked per-crack. Cap prevents runaway growth.</done>
</task>

<task type="auto">
  <name>Task 2: Implement SLOW_CRACKS passive effect</name>
  <files>core/GameEngine.ts</files>
  <action>
1. In tickCrackGrowth(), read SLOW_CRACKS level from powerUps
2. Apply reduction: effectiveGrowthChance = max(0, pressureRatio - (slowCracksLevel * 0.05))
   - Level 1: -5% offset
   - Level 2: -10% offset
   - Level 3: -15% offset
   - Level 4: -20% offset (at 20% pressure, cracks never grow)
3. Ensure the formula matches PRD: -5% per level

Note: SLOW_CRACKS config already exists in constants.ts with effectPerLevel: 0.05
  </action>
  <verify>
- npm run test:run passes
- With SLOW_CRACKS at level 4, cracks should not grow until pressure exceeds 20%
- Debug log shows growth chance calculations including SLOW_CRACKS offset
  </verify>
  <done>SLOW_CRACKS reduces crack growth chance by 5% per level. At max level (4), no growth until 20% pressure.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes (all 112+ tests)
- [ ] Cracks grow at rank 30+ based on pressure
- [ ] SLOW_CRACKS reduces growth chance appropriately
- [ ] No growth when paused/in minigame
- [ ] Version bumped in Art.tsx
</verification>

<success_criteria>

- All tasks completed
- Expanding cracks mechanic works as specified
- SLOW_CRACKS passive reduces growth chance
- No TypeScript errors
- Tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/18-cracked-band/18-01-SUMMARY.md`
</output>
