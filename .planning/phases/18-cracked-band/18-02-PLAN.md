---
phase: 18-cracked-band
plan: 02
type: execute
---

<objective>
Implement CRACK_MATCHER passive and CRACK_DOWN active ability.

Purpose: Complete the Cracked Band upgrades — CRACK_MATCHER helps players match colors to seal cracks, CRACK_DOWN gives active control over where new cracks spawn.
Output: Falling pieces biased toward lowest crack color. CRACK_DOWN makes next N cracks spawn in bottom 4 rows.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-cracked-band/18-01-SUMMARY.md

# Key files:
@core/GameEngine.ts
@types.ts
@constants.ts
@utils/gameLogic.ts

# PRD Definition:
**CRACK_MATCHER:** +25% color bias toward lowest crack per level (max 4 levels = 100%)
**CRACK_DOWN:** When activated, next N cracks spawn in bottom 4 rows. Scaling: 3/5/7 cracks for level 1/2/3.

# Note: ACTIVE_EXPANSION_SLOT_2 already implemented (maxActiveSlots calculation includes it)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CRACK_MATCHER passive (color bias toward lowest crack)</name>
  <files>core/GameEngine.ts, utils/gameLogic.ts</files>
  <action>
1. Modify spawnNewPiece() or the piece color selection logic:
   - Find the lowest (highest Y value) crack from goalMarks
   - If CRACK_MATCHER level > 0 and lowest crack exists:
     - Calculate bias chance = crackMatcherLevel * 0.25 (25% per level)
     - Roll random, if <= bias chance, force piece color to match lowest crack's color
   - Otherwise, use normal random color selection
2. "Lowest crack" = goalMark with highest Y value (closer to bottom of tank)
3. Only apply if goalMarks.length > 0

Note: CRACK_MATCHER config in constants.ts has effectPerLevel: 0.25
  </action>
  <verify>
- npm run test:run passes
- With CRACK_MATCHER at level 4 and a crack present, pieces should strongly favor that crack's color
- Debug log shows bias calculation and color selection
  </verify>
  <done>Piece color selection biased toward lowest crack's color. Bias = 25% per CRACK_MATCHER level.</done>
</task>

<task type="auto">
  <name>Task 2: Implement CRACK_DOWN active ability</name>
  <files>core/GameEngine.ts, types.ts</files>
  <action>
1. Add state tracking for CRACK_DOWN:
   - `crackDownRemaining: number` in GameState (cracks left to spawn low)
2. Initialize crackDownRemaining to 0 in resetState()
3. In activateAbility() for CRACK_DOWN:
   - Read level from powerUps
   - Set crackDownRemaining = 1 + level * 2 (so 3/5/7 for levels 1/2/3)
   - Log activation
4. Modify goal spawning logic (in GoalManager.trySpawnGoal or spawnGoalMark):
   - If crackDownRemaining > 0:
     - Restrict spawn Y to bottom 4 rows (TOTAL_HEIGHT - 4 to TOTAL_HEIGHT - 1)
     - Decrement crackDownRemaining after successful spawn
   - Pass crackDownRemaining as parameter or check state
5. CRACK_DOWN charge rate already configured in GameEngine (30s to full)

AVOID: Don't spawn cracks in occupied cells - use existing spawn logic, just restrict Y range.
  </action>
  <verify>
- npm run test:run passes
- At rank 35+ with CRACK_DOWN equipped and activated, observe next 3/5/7 cracks spawn in bottom 4 rows
- After crackDownRemaining depletes, normal crack spawning resumes
  </verify>
  <done>CRACK_DOWN active makes next N cracks spawn in bottom 4 rows. Scaling: 3/5/7 for levels 1/2/3.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes (all 112+ tests)
- [ ] CRACK_MATCHER biases piece color toward lowest crack
- [ ] CRACK_DOWN activation restricts crack spawning to bottom rows
- [ ] CRACK_DOWN count depletes correctly
- [ ] Version bumped in Art.tsx
</verification>

<success_criteria>

- All tasks completed
- CRACK_MATCHER works with 25% bias per level
- CRACK_DOWN spawns 3/5/7 cracks low for levels 1/2/3
- Phase 18 complete — all Cracked Band features implemented
- Tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/18-cracked-band/18-02-SUMMARY.md`

Phase 18 complete. Update ROADMAP.md and STATE.md to reflect completion.
</output>
