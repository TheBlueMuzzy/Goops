---
phase: 05-hud-balance
plan: 03
type: execute
---

<objective>
Implement CONTROLS heat meter logic — builds while rotating, drains when idle, triggers at 100%.

Purpose: Replace the 20-rotations-in-3-seconds trigger with a visible heat meter that rewards calm, deliberate play.
Output: Heat meter builds during rotation, drains when stopped, CONTROLS triggers at 100%, cools on resolution.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/DESIGN_VISION.md
@.planning/phases/05-hud-balance/05-01-SUMMARY.md
@.planning/phases/05-hud-balance/05-02-SUMMARY.md
@types.ts
@core/GameEngine.ts
@core/commands/actions.ts
@Game.tsx

**Current CONTROLS Trigger (to be replaced):**
- 20+ entries in `rotationTimestamps` array (20 rotations in 3s window)
- Checked every 1 second in checkComplications()
- Timestamps cleared on trigger and resolution

**New CONTROLS Trigger:**
- `controlsHeat >= 100` triggers CONTROLS complication
- Heat builds by X per rotation input (start with ~5 per rotation)
- Heat drains by Y per second when NOT rotating (drain to 0 in ~2 seconds = ~50/sec)
- Heat resets to 0 on CONTROLS resolution
- Only active at rank 3+ (rank unlock shifted: CONTROLS now rank 3)

**Key Files:**
- `core/commands/actions.ts`: MoveBoardCommand — where rotation happens
- `Game.tsx`: Movement loop, tracks last rotation time
- `core/GameEngine.ts`: tick() for passive drain, checkComplications() for trigger
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement heat buildup on rotation</name>
  <files>core/commands/actions.ts, types.ts</files>
  <action>
In MoveBoardCommand.execute():
- After recording rotation timestamp (existing logic), add heat buildup
- `engine.state.controlsHeat = Math.min(100, engine.state.controlsHeat + 5)` (5 per rotation, tunable)
- Only add heat if rank >= 3 (CONTROLS unlock rank)

The rotation timestamp tracking can remain for now but won't be used for triggering.
  </action>
  <verify>Start game at rank 3+, rotate several times — heat meter should rise</verify>
  <done>Heat meter increases with each rotation at rank 3+</done>
</task>

<task type="auto">
  <name>Task 2: Implement heat dissipation and trigger</name>
  <files>core/GameEngine.ts</files>
  <action>
In tick():
- Add passive heat drain when NOT actively rotating
- Use timestamps to detect "idle": if no rotation in last 200ms, start draining
- `const drainRate = 50` (per second, so heat drains to 0 in 2 seconds)
- `this.state.controlsHeat = Math.max(0, this.state.controlsHeat - (drainRate * dt / 1000))`
- Only drain if rank >= 3 (CONTROLS unlock rank)

In checkComplications():
- Remove the old CONTROLS trigger check (`rotationTimestamps.length >= 20`)
- Add new check: `if (this.state.controlsHeat >= 100 && rank >= 3)`
- Spawn CONTROLS complication when heat hits 100

In resolveComplication():
- For CONTROLS case: set `this.state.controlsHeat = 0` (cool down)
- Keep the rotationTimestamps clear (or remove it if no longer needed)
  </action>
  <verify>Start game at rank 3+, rotate rapidly — heat builds to 100, CONTROLS triggers. Fix minigame — heat resets to 0. Stop rotating — heat drains passively.</verify>
  <done>Heat builds on rotation, drains when idle, triggers at 100, resets on resolution</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] Heat meter increases when rotating (visual meter rises)
- [ ] Heat meter decreases when NOT rotating (~2 seconds to zero)
- [ ] CONTROLS triggers when heat reaches 100
- [ ] Completing CONTROLS minigame resets heat to 0
- [ ] CONTROLS does NOT trigger if rank < 3
</verification>

<success_criteria>
- All tasks completed
- Heat buildup per rotation is ~5 (tunable)
- Heat drain rate is ~50/sec (2 seconds to zero)
- CONTROLS triggers at 100, not at 20 rotations
- Resolution cools heat to 0
- No TypeScript errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-hud-balance/05-03-SUMMARY.md`
</output>
