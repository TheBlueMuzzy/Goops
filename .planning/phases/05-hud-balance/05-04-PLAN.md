---
phase: 05-hud-balance
plan: 04
type: execute
---

<objective>
Implement complication cooldowns and shift rank unlocks to match design spec.

Purpose: Prevent rapid-fire complication triggers and give players breathing room, especially at lower ranks.
Output: Cooldown system prevents same-type complication re-triggering for X seconds. Rank unlocks shifted as designed.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/DESIGN_VISION.md
@.planning/phases/05-hud-balance/05-01-SUMMARY.md
@.planning/phases/05-hud-balance/05-02-SUMMARY.md
@.planning/phases/05-hud-balance/05-03-SUMMARY.md
@types.ts
@core/GameEngine.ts

**Cooldown Design (from DESIGN_VISION.md):**
- After resolving a complication, same type cannot trigger for a cooldown period
- Formula: `cooldown = max(8, 20 - (rank - unlockRank))` seconds
  - At unlock rank: 20s cooldown
  - At rank 10+: 8s minimum cooldown
- Gives breathing room at low ranks, tightens as player improves

**Rank Unlock Shifts:**
- Current: LASER@1, CONTROLS@2, LIGHTS@3
- Target: LASER@1, LIGHTS@2, CONTROLS@3 (swap LIGHTS and CONTROLS)

**Key Files:**
- `types.ts`: Add cooldown tracking to GameState
- `core/GameEngine.ts`: checkComplications() and resolveComplication()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cooldown state and tracking</name>
  <files>types.ts, core/GameEngine.ts</files>
  <action>
In types.ts, add to GameState:
- `complicationCooldowns: Record<ComplicationType, number>` — timestamp when each type becomes available again (0 = no cooldown)

In GameEngine.ts constructor and startRun():
- Initialize `complicationCooldowns: { LIGHTS: 0, CONTROLS: 0, LASER: 0 }`

In resolveComplication():
- Calculate cooldown: `const unlockRank = { LASER: 1, LIGHTS: 2, CONTROLS: 3 }[type]`
- `const cooldownSeconds = Math.max(8, 20 - (rank - unlockRank))`
- `this.state.complicationCooldowns[type] = Date.now() + (cooldownSeconds * 1000)`

In checkComplications():
- Before triggering any complication, check: `if (Date.now() < this.state.complicationCooldowns[type]) return` (still on cooldown)
  </action>
  <verify>Start game, trigger LASER, fix it — try to trigger LASER again immediately (shouldn't trigger until cooldown expires)</verify>
  <done>Cooldowns tracked per complication type, prevents rapid re-triggering</done>
</task>

<task type="auto">
  <name>Task 2: Shift rank unlocks (LIGHTS@2, CONTROLS@3)</name>
  <files>core/GameEngine.ts</files>
  <action>
Update rank checks in checkComplications() and tick():
- LASER: rank >= 1 (unchanged)
- LIGHTS: change from `rank >= 3` to `rank >= 2`
- CONTROLS: change from `rank >= 2` to `rank >= 3`

This swaps when LIGHTS and CONTROLS unlock.

Also update any rank check in the heat buildup/drain logic (Task 1 of 05-03 should already have this as rank >= 3).
  </action>
  <verify>Start game at rank 2 — LIGHTS can trigger, CONTROLS cannot. Start game at rank 3 — both can trigger.</verify>
  <done>LIGHTS unlocks at rank 2, CONTROLS unlocks at rank 3</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete HUD meter system with cooldowns and rank unlocks</what-built>
  <how-to-verify>
    1. Run: `npm run dev -- --host`
    2. Open browser to localhost (or phone to local IP)
    3. Use dev tool rank selector (in console footer) to test different ranks:

    **Rank 0 (no complications):**
    - Pop groups, rotate rapidly — neither meter should cause triggers
    - Meters may still move but no complications spawn

    **Rank 1 (LASER only):**
    - Pop groups — capacitor drains, LASER triggers at 0
    - Fix LASER — capacitor refills to 100
    - Try to trigger LASER again immediately — should be on cooldown (~20s)

    **Rank 2 (LASER + LIGHTS):**
    - LIGHTS can now trigger (50% on piece lock when pressure gap)
    - CONTROLS still cannot trigger (heat builds but doesn't spawn)

    **Rank 3+ (all three):**
    - Rotate rapidly — heat builds to 100, CONTROLS triggers
    - Fix CONTROLS — heat resets to 0
    - Cooldown prevents immediate re-trigger

    4. Confirm visual meters:
    - Left meter (capacitor): blue when full, drains toward red
    - Right meter (heat): green when cool, builds toward red
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] Cooldowns prevent same-type re-trigger for expected duration
- [ ] LASER unlocks at rank 1
- [ ] LIGHTS unlocks at rank 2
- [ ] CONTROLS unlocks at rank 3
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- Cooldown formula: max(8, 20 - (rank - unlockRank)) seconds
- Rank unlocks: LASER@1, LIGHTS@2, CONTROLS@3
- No TypeScript errors
- All existing tests pass
- Human verified gameplay feels right
</success_criteria>

<output>
After completion, create `.planning/phases/05-hud-balance/05-04-SUMMARY.md` with:
- What was built
- Final tuning values (drain rate, heat rate, cooldown formula)
- Any issues found during human verification
- Phase 5 complete status
</output>
