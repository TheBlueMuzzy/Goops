---
phase: 27.1-physics-controlled-active-piece
plan: 01
type: execute
---

<objective>
Port Proto-9's visualOffsetY falling pattern to the soft-body physics system.

Purpose: Physics owns falling motion directly, eliminating the timing mismatch that causes flickering in 27-02 rendering.
Output: Physics system can smoothly fall active piece blobs with grid collision detection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27.1-physics-controlled-active-piece/27.1-RESEARCH.md
@.planning/phases/27-active-piece-physics/27-01-SUMMARY.md

**Key source files:**
@core/softBody/types.ts
@core/softBody/physics.ts
@hooks/useSoftBodyPhysics.ts
@prototypes/SoftBodyProto9.tsx (reference for visualOffsetY pattern, lines 1598-1635)

**Tech available:** Verlet physics engine, blob factory, coordinate transforms
**Established patterns:** Blob ID convention (active-{timestamp}), blob lifecycle hooks in GameBoard

**Constraining decisions:**
- Phase 27-01: Blobs already created for active pieces with `active-{timestamp}` ID
- Phase 27-01: Blob removed on lock (not converted) - standard sync handles locked state

**From RESEARCH.md - Don't hand-roll:**
- Smooth falling: Use visualOffsetY + Verlet (Proto-9 pattern)
- Collision detection: Use grid cell lookup (O(1))
- Lock timing: Use canFallMore + visualOffsetY threshold
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SoftBlob type with falling properties</name>
  <files>core/softBody/types.ts</files>
  <action>
Add properties to SoftBlob interface for physics-controlled falling:

```typescript
// Add to SoftBlob interface
gridCells: Vec2[];           // Grid cells this blob occupies (for collision detection)
visualOffsetY: number;       // Sub-cell falling offset (0 to CELL_SIZE, wraps)
isColliding: boolean;        // True when blob can't fall more (for GameEngine to read)
```

These enable the Proto-9 pattern where:
- `gridCells` tracks which grid positions the blob occupies
- `visualOffsetY` accumulates smooth sub-cell motion
- `isColliding` signals GameEngine to start lock timer

Do NOT add a separate `canFallMore` - use `isColliding` (same meaning, clearer name for consumers).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>SoftBlob interface has gridCells, visualOffsetY, and isColliding properties</done>
</task>

<task type="auto">
  <name>Task 2: Update blob creation to initialize falling properties</name>
  <files>core/softBody/blobFactory.ts</files>
  <action>
Update `createBlobFromCells` to initialize the new properties:

```typescript
// In createBlobFromCells, add to returned blob:
gridCells: cells.map(c => ({ x: c.x, y: c.y })),  // Copy of input cells
visualOffsetY: 0,
isColliding: false,
```

The `gridCells` should be a copy (not reference) so physics can mutate them during falling without affecting the input.

For locked blobs (`isLocked: true`), these properties won't be used but should still be initialized to avoid undefined access.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>createBlobFromCells initializes gridCells, visualOffsetY, isColliding for all blobs</done>
</task>

<task type="auto">
  <name>Task 3: Implement stepActivePieceFalling in physics</name>
  <files>core/softBody/physics.ts</files>
  <action>
Add a new function to handle active piece falling (ported from Proto-9 lines 1598-1635):

```typescript
export function stepActivePieceFalling(
  blob: SoftBlob,
  dt: number,
  fallSpeed: number,  // pixels/second (passed in, so GameEngine controls fast-fall)
  grid: TankCell[][],
  gridRows: number
): void {
  // Skip if not a falling blob
  if (blob.isLocked || blob.isLoose) return;

  // Check collision BEFORE moving
  let canFallMore = true;
  for (const cell of blob.gridCells) {
    const nextY = cell.y + 1;
    if (nextY >= gridRows) {
      canFallMore = false;
      break;
    }
    // Check if cell below is occupied (by different blob)
    const targetCell = grid[nextY]?.[cell.x];
    if (targetCell && targetCell.goopGroupId !== undefined) {
      canFallMore = false;
      break;
    }
  }

  blob.isColliding = !canFallMore;

  if (canFallMore) {
    // Accumulate visual offset
    const fallAmount = fallSpeed * dt;
    blob.visualOffsetY += fallAmount;

    // Move grid cells when offset exceeds cell size
    const CELL_SIZE = 30;  // PHYSICS_CELL_SIZE from blobFactory
    while (blob.visualOffsetY >= CELL_SIZE) {
      for (const cell of blob.gridCells) {
        cell.y += 1;
      }
      blob.visualOffsetY -= CELL_SIZE;
    }
  }

  // Update physics target position from grid cells + offset
  // Centroid calculation
  let sumX = 0, sumY = 0;
  for (const cell of blob.gridCells) {
    sumX += cell.x;
    sumY += cell.y;
  }
  const centroidX = sumX / blob.gridCells.length;
  const centroidY = sumY / blob.gridCells.length;

  // Convert to pixels (using same transform as blobFactory)
  const PHYSICS_GRID_OFFSET_X = -180;
  const PHYSICS_GRID_OFFSET_Y = 0;
  blob.targetX = PHYSICS_GRID_OFFSET_X + (centroidX + 0.5) * CELL_SIZE;
  blob.targetY = PHYSICS_GRID_OFFSET_Y + (centroidY + 0.5) * CELL_SIZE + blob.visualOffsetY;
}
```

Import TankCell type from types.ts if not already imported.

Key differences from Proto-9:
- Uses `goopGroupId !== undefined` to check for occupied cells (Goops grid structure)
- `fallSpeed` passed in rather than hardcoded (GameEngine controls fast-fall)
- Constants imported/matched from blobFactory

Do NOT call this from stepPhysics yet - Plan 02 will wire up the integration.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` and `npm run test:run`</verify>
  <done>stepActivePieceFalling function exists, handles visualOffsetY accumulation, grid collision, and target position updates</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test:run` passes (no regressions)
- [ ] SoftBlob type has gridCells, visualOffsetY, isColliding
- [ ] createBlobFromCells initializes new properties
- [ ] stepActivePieceFalling function exists with Proto-9 pattern
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Physics system has the falling logic ready (not yet wired up)
</success_criteria>

<output>
After completion, create `.planning/phases/27.1-physics-controlled-active-piece/27.1-01-SUMMARY.md`
</output>
