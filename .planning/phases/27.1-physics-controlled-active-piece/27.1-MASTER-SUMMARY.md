# Phase 27.1 Master Summary: Physics-Controlled Active Piece

**Executed:** 2026-02-05
**Status:** Complete
**Branch:** soft-body-experiment

---

## Performance

- **Start Time:** ~22:47
- **End Time:** ~22:57
- **Duration:** ~10 minutes
- **Tasks Completed:** 9/9

---

## Accomplishments

### Task 1: Update Scaling Parameters
- Scaled physics parameters by 0.6 (30px/50px proto cell size)
- Updated: attractionRadius (20->12), wallThickness (8->4.8), tendrilEndRadius (10->6), goopiness (25->15), dropletSize (25->9), dropletSpeed (167->60)
- Added new `dropletGravity: 180` parameter
- Updated PULSE_AMPLITUDE to 2.4

### Task 2: Export stepActivePieceFalling
- Already exported from previous work (verified)

### Task 3: Update useSoftBodyPhysics.step()
- Added `PhysicsStepContext` interface
- Updated `step()` to accept optional context parameter
- Added call to `stepActivePieceFalling` for falling blobs before core physics

### Task 4: Add getActivePieceState()
- Added method returning `{ gridY, isColliding }` from active falling blob
- Adds BUFFER_HEIGHT to convert visual Y back to full grid Y

### Task 5: Update Game.tsx handlePhysicsStep
- Created `handlePhysicsStep` callback that builds context and syncs state
- Passes grid, tankRotation, fallSpeed to physics.step()
- Calls `getActivePieceState()` and passes results to engine

### Task 6: Update GameEngine
- Added `getFallSpeed()` returning px/sec for physics
- Added `syncActivePieceFromPhysics(isColliding, gridY)` for physics-controlled falling
- Added `usePhysicsForFalling` flag to prevent double Y movement
- Modified old `tickActivePiece(dt)` to skip when physics controls falling

### Task 7: Remove GameBoard Y Sync
- Updated blob sync effect to only update X (for tank rotation centering)
- Removed Y sync from game -> physics (was going wrong direction)

### Task 8: Handle Rotation Sync
- Added effect to update `blob.gridCells` when piece rotates
- Preserves accumulated Y offset from physics
- Ensures collision detection uses correct shape

### Task 9: Handle Piece Swap (Verify)
- Verified existing blob lifecycle handles swap correctly
- Old blob removed when spawnTimestamp changes
- New blob created for swapped-in piece

---

## Task Commits

| Task | Commit Hash | Description |
|------|-------------|-------------|
| 1 | c053204 | Update scaling parameters for 30px cells |
| 2 | (no commit) | Already exported |
| 3-4 | 043e8c0 | Add physics step context and getActivePieceState |
| 5-6 | 74404bb | Wire physics to Game.tsx and GameEngine |
| 7 | 7cb7839 | Remove Y sync from GameBoard to physics |
| 8 | 200cc95 | Sync blob shape on piece rotation |
| 9 | (no commit) | Verified existing code handles swap |

---

## Files Modified

| File | Changes |
|------|---------|
| `core/softBody/types.ts` | Added dropletGravity param, updated defaults to scaled values |
| `core/softBody/physics.ts` | (Already had stepActivePieceFalling exported) |
| `hooks/useSoftBodyPhysics.ts` | Added PhysicsStepContext, updated step(), added getActivePieceState() |
| `hooks/useGameEngine.ts` | Updated callback type to pass engine |
| `Game.tsx` | Added handlePhysicsStep, set usePhysicsForFalling |
| `core/GameEngine.ts` | Added getFallSpeed(), syncActivePieceFromPhysics(), usePhysicsForFalling flag |
| `components/GameBoard.tsx` | Updated blob sync to only update X, handle rotation |
| `tests/softBody.test.ts` | Updated DEFAULT_PHYSICS test to expect scaled values |

---

## Deviations from Plan

1. **Task 2 already complete**: `stepActivePieceFalling` was already exported in previous work
2. **Tasks 3-4 combined**: Both in same file, committed together
3. **Tasks 5-6 combined**: Tightly coupled changes, committed together
4. **Task 9 no changes**: Verified existing lifecycle handles swap correctly

---

## Issues Encountered

None - all tasks completed successfully.

---

## Verification Results

- `npx tsc --noEmit`: PASS
- `npm run test:run`: PASS (198 tests)

---

## Next Steps

Manual testing needed to verify:
1. Piece falls smoothly with soft-body wobble
2. Fall speed matches expected (2 cells/sec base, 8x when fast-dropping)
3. Piece stops at floor and on top of other goop
4. Rotation updates blob shape without Y reset
5. Swap removes old blob, creates new blob
6. Tank rotation keeps piece visually centered

---

## Architecture Summary

**Data Flow (Desktop):**
```
GameEngine.tick(dt)
    ↓
useGameEngine calls onPhysicsStep(dt, engine)
    ↓
handlePhysicsStep in Game.tsx:
    1. Builds context { grid, tankRotation, fallSpeed }
    2. Calls softBodyPhysics.step(dt, context)
       → stepActivePieceFalling updates blob.gridCells.y and blob.isColliding
    3. Gets { gridY, isColliding } from getActivePieceState()
    4. Calls engine.syncActivePieceFromPhysics(isColliding, gridY)
       → Syncs activeGoop.y FROM physics
       → Manages lock timer based on isColliding
```

**Key Principle:** Physics OWNS the Y position during falling. GameEngine READS it.
