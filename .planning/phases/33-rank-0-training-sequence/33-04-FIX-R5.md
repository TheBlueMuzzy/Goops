---
phase: 33-rank-0-training-sequence
plan: 04-FIX-R5
type: fix
---

<objective>
Fix 3 UAT round-5 issues from plan 33-04 (UAT-010, UAT-011, UAT-012).

Source: 33-04-ISSUES.md (round 5 entries)
Priority: 1 blocker, 1 major, 1 minor

Root cause: C2 uses event-based advance (`goop-merged`), but the merge fires during the 1s pauseDelay before C2 is listening. This blocks C2 advance, which cascades — C3 never triggers, and D/E/F are unreachable.

Note: Implementation already exists as uncommitted changes in working directory. This plan reviews, commits, and verifies those changes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/33-rank-0-training-sequence/33-04-ISSUES.md

**Original plan for reference:**
@.planning/phases/33-rank-0-training-sequence/33-04-PLAN.md

**Prior fix plan (rounds 1-4):**
@.planning/phases/33-rank-0-training-sequence/33-04-FIX.md

**Key source files:**
@hooks/useTrainingFlow.ts
@data/trainingScenarios.ts
@data/tutorialSteps.ts
@types/training.ts
@Game.tsx
@components/TrainingHUD.tsx
@hooks/useSoftBodyPhysics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Review and commit C2/C3 advance fix + pressure tuning (UAT-011, UAT-010, UAT-012)</name>
  <files>hooks/useTrainingFlow.ts, data/trainingScenarios.ts, data/tutorialSteps.ts, types/training.ts, Game.tsx, components/TrainingHUD.tsx, hooks/useSoftBodyPhysics.ts</files>
  <action>
**Review the existing uncommitted changes across all 8 modified files.** These changes were developed to fix the round 5 issues. Verify the following fixes are correct before committing:

**A) UAT-011 fix — C2 advance mechanism (trainingScenarios.ts):**
C2_MERGE step should now use `advance: { type: 'tap' }` instead of the original event-based `{ type: 'event', event: 'goop-merged' }`. The merge already happens during pauseDelay — user just acknowledges it.

Verify: C2 config has `advance: { type: 'tap' }` and the `pauseDelay: 1000` is still present so the merge happens during the delay.

**B) UAT-010 fix — C3 solidify flow (trainingScenarios.ts, tutorialSteps.ts):**
A new C3B_POP_HINT step should exist between C3_FILL_TIMING and D1_CRACK_APPEARS. This bridges the gap: C3 teaches solidify timing (tap to continue), then C3B prompts the player to pop goop (pauseGame: false, game running, advance on pop-goop action).

Verify:
- C3_FILL_TIMING exists with `advance: { type: 'tap' }`
- C3B_POP_HINT exists with `advance: { type: 'action', action: 'pop-goop' }`, `pauseGame: false`, and `messageDelay: 2000`
- tutorialSteps.ts has a TRAINING_MESSAGES entry for C3B
- The step array order is: ...C1C → C2 → C3 → C3B → D1...

**C) UAT-012 fix — pressure rate tuning (trainingScenarios.ts):**
C2 and C3 pressure rates should be bumped from 0.2 to 0.3125 (1.5x faster). Check that the values feel reasonable — 0.3125 is half of normal gameplay speed (0.625).

Verify: C2_MERGE and C3_FILL_TIMING both have `pressureRate: 0.3125`.

**D) Bonus improvements (useTrainingFlow.ts):**
Review these additional enhancements in the uncommitted changes:
- Fill timestamp adjustment on pause/unpause (adjustFillTimestampsForPause) — prevents solidify appearing instant after pause
- 150ms advance arm delay after dismiss — prevents dismiss-tap from triggering event listeners on same frame
- showOnInput feature for C1B — message only shows when player tries input (patient player optimization)
- messageDelay support for delayed message display

Verify each is implemented correctly and doesn't break existing step behavior.

**E) Other file changes:**
- Game.tsx: Check for any training-related prop changes
- TrainingHUD.tsx: Check for any rendering changes
- useSoftBodyPhysics.ts: Check for any training-mode physics adjustments
- types/training.ts: Verify new type fields (messageDelay, showOnInput) are properly optional

**After review:** Run `npm run test:run` to verify all tests pass. If everything looks correct, commit all changes with a descriptive message. Stage specific files (not git add .).
  </action>
  <verify>`npm run test:run` passes. `git diff --stat` shows 0 uncommitted changes after commit.</verify>
  <done>All round 5 fixes committed. C2 uses tap advance, C3B step exists, pressure rates at 0.3125, bonus improvements included.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed C2/C3 training flow: C2 now tap-based (merge happens during pauseDelay), added C3B pop hint step, bumped pressure rates to 0.3125, plus fill timestamp adjustment and showOnInput improvements</what-built>
  <how-to-verify>
    1. Clear localStorage, reload at rank 0
    2. Play through A-phase and B-phase (these are already approved — just get to C)
    3. **C1/C1B/C1C:** Should still work as before (already approved). Pop yellow goop when instructed.
    4. **C2 (merge message):** After popping yellow, blue merges during 1s delay. Merge message appears. Tap to dismiss — should advance to C3. NOT stuck.
    5. **C3 (solidify timing):** Message about fill timing appears immediately after C2 dismiss. Tap to continue.
    6. **C3B (pop prompt):** Game unpauses. After ~2s, a hint appears prompting you to pop goop. Pop it to advance.
    7. **Pressure meter:** During C-phase, PSI should rise at a noticeable rate (not sluggish like before).
    8. **D1 (crack):** After C3B, D-phase should start. Crack appears in the tank.
    9. **D2 (tank rotation):** Tank rotation control enabled. Message teaches how to rotate.
    10. **D3 (offscreen):** Teaches about offscreen goop.
    11. **E1 (scaffolding):** Pressure demonstration.
    12. **F1 (cleanup):** Final teaching messages.
    13. **F2 (practice):** Free play until game over.
    14. Verify no step gets stuck — full training playthrough completes.
  </how-to-verify>
  <resume-signal>Type "approved" for full pass, or list specific steps that have issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-011: C2 advances on tap (not stuck waiting for missed merge event)
- [ ] UAT-010: C3 message appears after C2 dismiss, C3B bridges to D-phase
- [ ] UAT-012: Pressure rate 0.3125 feels appropriate (not sluggish)
- [ ] All existing tests pass
- [ ] Full training sequence is playable from A through F
- [ ] No steps get stuck
</verification>

<success_criteria>
- C2 → C3 → C3B → D1 flow works without getting stuck
- Pressure rises at perceptible rate during C-phase
- Full training playthrough completes (A through F)
- All changes committed and tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/33-rank-0-training-sequence/33-04-FIX-SUMMARY.md` covering BOTH the original FIX (rounds 1-4) and this R5 fix plan.
</output>
