---
phase: 33-rank-0-training-sequence
plan: 05
type: execute
---

<objective>
Fix two engine-level prerequisites that the Tutorial v3 rewrite depends on.

Purpose: The tutorial teaches "pop to seal a crack" but the engine currently removes cracks on piece lock (wrong). Also, the D3 discovery step needs a clean event when offscreen arrows appear instead of polling crack positions. Both fixes affect core gameplay, not just the tutorial.

Output: Two engine changes — two-step crack sealing mechanic and CRACK_OFFSCREEN event — with existing tests still passing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/Tutorial3.md (Section 3: Engine Prerequisites)
@.planning/PROJECT.md
@.planning/ROADMAP.md
@core/GameEngine.ts
@core/events.ts
@core/commands/actions.ts
@components/GameBoard.tsx (lines 698-717: offscreen arrow rendering)
@types.ts (GoalMark, Crack interfaces)

**Key constraint from Tutorial3.md:**
Crack sealing is a two-step process:
1. PLUG: Matching goop covers crack. Crack visible through goop. Goop over crack glows/outlines.
2. SEAL: Player pops the goop. Crack hardens and disappears. GOAL_CAPTURED fires on POP, not on lock.

If plugged goop falls away (stack collapse), crack reverts to unplugged.

**CRACK_OFFSCREEN event:**
Currently arrows are rendered per-frame in GameBoard.tsx from goalMarks positions (lines 698-717). No event fires when an arrow first appears. D3 discovery needs a single event when any goalMark transitions from onscreen to offscreen.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Two-step crack sealing mechanic (plug on lock, seal on pop)</name>
  <files>core/GameEngine.ts, core/commands/actions.ts, types.ts, components/GameBoard.tsx</files>
  <action>
  **Changes to lockActivePiece (GameEngine.ts):**
  - When a piece locks and its cells overlap matching-color goalMarks, do NOT remove the goalMarks (do NOT "consume" them)
  - Instead, mark those goalMarks as "plugged" — add a `plugged: boolean` field to GoalMark interface in types.ts
  - GOAL_CAPTURED should NOT fire on piece lock anymore for crack-matching cells
  - The existing `consumedGoals` logic that removes goalMarks needs to change: instead of removing, set `plugged = true`
  - PIECE_DROPPED still fires normally

  **Changes to pop logic (actions.ts — PopGoopCommand):**
  - When goop is popped, check if any of the popped cells overlap with plugged goalMarks
  - If yes: remove those goalMarks (crack is now sealed), fire GOAL_CAPTURED event
  - This means GOAL_CAPTURED now fires during pop, not during lock

  **Changes to gravity/falling (GameEngine.ts):**
  - When goop falls away from a plugged crack (loose goop gravity, row clearing, etc.), the goalMark should revert to `plugged = false`
  - Check: after any grid change that moves goop (gravity, pop cascade), scan plugged goalMarks and verify they still have matching-color goop on top. If not, set `plugged = false`.

  **Visual indicator (GameBoard.tsx):**
  - Plugged cracks should be visually distinct — the goop over them should glow or have an outline
  - Add a CSS class or SVG attribute to goop cells that sit on top of a plugged goalMark
  - Use the goalMark color to match — only matching-color goop triggers the visual
  - Keep it simple: a subtle outline or brightness boost on the goop cell. Don't overdesign.

  **What to avoid:**
  - Do NOT change how cracks spawn or grow (CrackManager is unaffected)
  - Do NOT change how goalMarks are created — only how they're consumed
  - Do NOT break normal (non-training) gameplay — this fix applies to ALL modes
  - Do NOT change the crack arrow rendering (that's Task 2's concern)
  </action>
  <verify>
  - `npm run test:run` passes (no regressions)
  - In normal gameplay: drop matching goop on a crack → crack stays visible, goop glows → pop the goop → crack disappears
  - If goop falls off a crack (pop below it), crack reappears as unplugged
  </verify>
  <done>
  - GoalMark has `plugged` field
  - Cracks persist through piece lock (not consumed)
  - GOAL_CAPTURED fires on pop (not lock) when popping over plugged crack
  - Plugged goop has visual indicator
  - Unplugged reversion works when goop falls away
  - All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CRACK_OFFSCREEN event to event bus</name>
  <files>core/events.ts, components/GameBoard.tsx</files>
  <action>
  **Add event type (events.ts):**
  - Add `CRACK_OFFSCREEN` to GameEventType enum
  - This event fires ONCE when any goalMark transitions from onscreen to offscreen (arrow appears)

  **Detect transition (GameBoard.tsx):**
  - The arrow rendering code (lines 698-717) already calculates which goalMarks are offscreen
  - Add a ref to track the previous frame's offscreen set: `prevOffscreenIdsRef`
  - Each frame, compare current offscreen goalMark IDs to previous frame's set
  - If any NEW ID appears in the offscreen set (was onscreen, now offscreen): emit `CRACK_OFFSCREEN` via gameEventBus
  - Update the ref with current set
  - This fires once per transition, not every frame

  **What to avoid:**
  - Do NOT fire the event every frame — only on transition (onscreen → offscreen)
  - Do NOT fire when a crack is REMOVED while offscreen (that's not a new arrow appearing)
  - Do NOT change how arrows are rendered — only add the detection/event emission alongside existing rendering
  - Keep the ref cleanup simple — clear on component unmount
  </action>
  <verify>
  - `npm run test:run` passes
  - In dev tools console: rotate tank to push a crack offscreen → CRACK_OFFSCREEN event fires once
  - Rotate back (crack onscreen) then offscreen again → fires again
  - If crack stays offscreen between frames → does NOT fire repeatedly
  </verify>
  <done>
  - CRACK_OFFSCREEN in GameEventType enum
  - Event fires once when any goalMark transitions onscreen → offscreen
  - Does not fire repeatedly while offscreen
  - All existing tests pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Two-step crack sealing and CRACK_OFFSCREEN event</what-built>
  <how-to-verify>
    1. Start a normal game (not training)
    2. Wait for a crack to spawn
    3. Drop matching-color goop on the crack — crack should stay visible, goop should glow/outline
    4. Pop the goop — crack should disappear (sealed)
    5. Rotate tank to push a crack offscreen — arrow appears on edge
    6. Check console for CRACK_OFFSCREEN event log
    7. Rotate back and forth — event should fire once per transition, not continuously
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] `npm run build` succeeds (if applicable)
- [ ] Crack sealing works in normal gameplay (plug on lock, seal on pop)
- [ ] CRACK_OFFSCREEN fires correctly on arrow appearance
- [ ] No regressions in existing gameplay
</verification>

<success_criteria>
- GoalMark.plugged field exists and functions correctly
- GOAL_CAPTURED fires on pop (not lock) for crack sealing
- Goop over plugged crack has visual indicator
- Unplugged reversion works when goop falls away
- CRACK_OFFSCREEN event fires on onscreen→offscreen transition
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/33-rank-0-training-sequence/33-05-SUMMARY.md`
</output>
