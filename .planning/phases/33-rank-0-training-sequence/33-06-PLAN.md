---
phase: 33-rank-0-training-sequence
plan: 06
type: execute
---

<objective>
Build the Tutorial v3 framework (state machine, timeout pool, handler registry) and all 15 step configs with standard handler implementations.

Purpose: Replace the fragile 1400-line useTrainingFlow.ts with a modular, state-machine-driven architecture where step configs are the single source of truth and standard patterns are reusable.

Output: New tutorial framework with state machine, all step configs, messages, and standard handler implementations for phases A-C and simple D/E steps.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/Tutorial3.md (Sections 4-6: Architecture, Step Spec, Patterns)
@.planning/PROJECT.md
@.planning/ROADMAP.md
@types/training.ts (current v2 types — to be replaced)
@data/trainingScenarios.ts (current v2 configs — to be replaced)
@data/tutorialSteps.ts (current v2 messages — to be replaced)
@hooks/useTrainingFlow.ts (current v2 logic — to be replaced)

**Architecture from Tutorial3.md:**

State machine lifecycle per step:
```
ENTERING → WAITING_FOR_TRIGGER → MESSAGE_VISIBLE → ARMED → ADVANCING
```

Timeout pool: One central manager. Named timeouts. `pool.clearAll()` on step change.

Handler registry: Steps with custom behavior register handlers.
```
standardHandler    → most steps
retryHandler       → D2
discoveryHandler   → D3
continuousHandler  → E1
freePlayHandler    → F1
```

**15 Steps (from Tutorial3.md Section 5):**
A1, B1, B2, B3, B4, C1, C2, C3, C4, D1, D2, D3, E1, E2, F1

**Reusable Patterns (from Tutorial3.md Section 6):**
1. Pause-Show-Dismiss-Unpause
2. Run-Act-Advance
3. Hint Safety Net (wait N seconds, show if no action, pause pressure)
4. Position-Gated
5. Pressure-Gated
6. Continuous Spawn
7. Retry with Accumulating Cracks
8. Discovery Interrupt
</context>

<tasks>

<task type="auto">
  <name>Task 1: State machine framework, timeout pool, handler registry, and types</name>
  <files>types/training.ts, hooks/useTrainingFlow.ts (new), hooks/tutorial/stateMachine.ts (new), hooks/tutorial/timeoutPool.ts (new), hooks/tutorial/handlers.ts (new)</files>
  <action>
  **New file structure:** Instead of one 1400-line file, split into focused modules:
  - `types/training.ts` — Updated types (TrainingStepId, StepSetup, TrainingStep, state machine types)
  - `hooks/tutorial/stateMachine.ts` — Step lifecycle state machine
  - `hooks/tutorial/timeoutPool.ts` — Centralized timeout/interval manager
  - `hooks/tutorial/handlers.ts` — Handler registry (standard + custom handler interfaces)
  - `hooks/useTrainingFlow.ts` — Main hook (thin orchestrator that wires everything together)

  **types/training.ts updates:**
  - Keep existing types that work: TrainingStepId, TrainingPhase, PieceSpawn, CrackSpawn, AllowedControls
  - Update TrainingStepId to 15 values (remove E2_POP_SEALED, rename E3_SCAFFOLDING → E2_SCAFFOLDING)
  - Add `hintDelay` field to StepSetup (standardizes the "wait then remind" pattern — replaces reshowAfterMs + custom E1 handler)
  - Add `handlerType` field to TrainingStep: 'standard' | 'retry' | 'discovery' | 'continuous' | 'freeplay' (tells registry which handler to use)
  - Keep StepAdvance union type as-is
  - Remove fields that are no longer needed: reshowAfterMs, reshowNonDismissible, reshowAtRow, reshowUntilAction, showOnInput (these are replaced by hintDelay or removed)

  **hooks/tutorial/stateMachine.ts:**
  - Define step lifecycle states: ENTERING, WAITING_FOR_TRIGGER, MESSAGE_VISIBLE, ARMED, ADVANCING
  - Each state knows: isPaused (boolean), isFrozen (boolean), messageShown (boolean)
  - Transitions are explicit functions: `enter()`, `showMessage()`, `armAdvance()`, `advance()`
  - Pause/unpause is a PROPERTY of the state, not a scattered action
  - Export a `useStepStateMachine()` hook that tracks current state and provides transition functions

  **hooks/tutorial/timeoutPool.ts:**
  - Export a `useTimeoutPool()` hook
  - Methods: `set(name, callback, delayMs)`, `setInterval(name, callback, intervalMs)`, `clear(name)`, `clearAll()`
  - All timeouts/intervals tracked by name
  - `clearAll()` called on every step change — guaranteed cleanup
  - No generation counters needed — named timeouts replace the pattern
  - Returns cleanup function for React effect teardown

  **hooks/tutorial/handlers.ts:**
  - Define `StepHandler` interface: `{ setup(step, engine, pool): void; cleanup(): void }`
  - `standardHandler` — implements patterns 1-5 from Tutorial3.md:
    - Pause-Show-Dismiss-Unpause (for pauseGame:true steps)
    - Run-Act-Advance (for pauseGame:false steps)
    - Hint Safety Net (hintDelay: wait N ms, show if no action, pause pressure)
    - Position-Gated (advanceAtRow, showWhenPieceBelow)
    - Pressure-Gated (advanceWhenPressureAbovePieces, advanceAtPressure)
  - Handler registry: `getHandler(step.handlerType)` returns the right handler
  - Custom handler stubs for plan 33-07: retryHandler, discoveryHandler, continuousHandler, freePlayHandler (just interfaces, implementation in next plan)

  **hooks/useTrainingFlow.ts (rewrite):**
  - Thin orchestrator: reads current step config, selects handler, delegates
  - Uses `useStepStateMachine()` for lifecycle
  - Uses `useTimeoutPool()` for all timers
  - On step change: `pool.clearAll()` → handler.cleanup() → new handler.setup()
  - Exposes same interface to Game.tsx as v2 (isInTraining, trainingStep, etc.)
  - Engine property management: sets trainingConfig on step change based on step.setup
  - Advance logic: handler calls stateMachine.advance() → hook calls advanceStep()

  **What to avoid:**
  - Do NOT implement custom handlers yet (D2 retry, D3 discovery, E1, F1) — those are plan 33-07
  - Do NOT wire into Game.tsx yet — keep the old integration working if possible, or stub the connection
  - Do NOT add more fields than needed — keep StepSetup lean
  - Do NOT create abstractions for hypothetical future needs — build for the 15 steps we have
  </action>
  <verify>
  - `npm run test:run` passes (existing tests shouldn't break if hook interface is preserved)
  - TypeScript compiles without errors
  - State machine has all 5 states with clear transitions
  - Timeout pool tracks and clears correctly
  - Handler registry returns standardHandler for most steps
  </verify>
  <done>
  - types/training.ts updated with 15 step IDs, hintDelay, handlerType
  - stateMachine.ts implements step lifecycle with explicit states
  - timeoutPool.ts implements named timeout/interval management
  - handlers.ts implements standardHandler + handler registry with custom stubs
  - useTrainingFlow.ts rewritten as thin orchestrator
  - All existing tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Step configs (15 steps), messages, and standard handler wiring</name>
  <files>data/trainingScenarios.ts, data/tutorialSteps.ts</files>
  <action>
  **data/trainingScenarios.ts (full rewrite):**
  Write all 15 step configs exactly as specified in Tutorial3.md Section 5. Each step must include:
  - id, phase, name, teaches, pauseGame, advance, markComplete (journal unlock)
  - setup: all fields from Tutorial3.md (spawnPiece, spawnCrack, pressureRate, allowedControls, etc.)
  - handlerType: 'standard' for most, 'retry' for D2, 'discovery' for D3, 'continuous' for E1, 'freeplay' for F1

  **Exact step configs (from Tutorial3.md):**

  A1_WELCOME: view:console, pauseGame:true, advance:drag-periscope, highlightElement:periscope, pressureRate:0
  B1_GOOP_FALLS: pauseGame:false, spawnPiece:blue T_I rot:1 autoFall, advanceAtRow:8, advance:piece-landed, all controls disabled, pressureRate:0
  B2_FAST_DROP: pauseGame:false, advance:piece-landed, fastDrop only, pressureRate:0 (no spawn — continues B1 piece)
  B3_ROTATION: pauseGame:true, pauseDelay:1200, spawnPiece:yellow T_T, advance:piece-landed, fastDrop+rotate, pressureRate:0
  B4_PRACTICE: pauseGame:true, spawnPiece:blue T_O, advance:piece-landed, fastDrop+rotate, pressureRate:0
  C1_PRESSURE: pauseGame:true, pressureRate:2.5, advanceWhenPressureAbovePieces:true, advancePressureAboveColor:yellow, autoSkipMs:10000, all controls disabled
  C2_POP: pauseGame:false, pressureRate:0, highlightGoopColor:yellow, advance:pop-goop, hintDelay:3000, pop only, popLowersPressure:true
  C3_MERGE_SOLIDIFY: pauseGame:true, pauseDelay:1500, advance:tap, pressureRate:0.3125
  C4_PRACTICE_POP: pauseGame:false, pressureRate:0, highlightGoopColor:blue, messageDelay:2000, hintDelay:3000, advance:pop-goop, popLowersPressure:true, all controls except tankRotate
  D1_CRACK: pauseGame:true, pauseDelay:2500, spawnCrack:green near-stack row:22, advance:tap, pressureRate:0
  D2_TANK_ROTATION: pauseGame:true (delayed via showWhenPieceBelow:8), spawnPiece:green T_O, pressureRate:0.46875, advance:crack-sealed, all controls, retryOnPieceLand with accumulating cracks, handlerType:'retry'
  D3_OFFSCREEN: handlerType:'discovery' — persistent listener for CRACK_OFFSCREEN event, advance:tap, autoSkipMs:15000
  E1_SEAL_CRACK: pauseGame:false, continuousSpawn:true, spawnPiece:green T_O, spawnCrack:green at-pressure-line, pressureRate:0.46875, advance:pop-goop (after GOAL_CAPTURED), hintDelay:3000, autoSkipMs:90000, handlerType:'continuous'
  E2_SCAFFOLDING: pauseGame:true, pauseDelay:1500, advance:tap, pressureRate:0.46875
  F1_GRADUATION: pauseGame:true, pauseDelay:2000, continuousSpawn:true, pressureCap:0.95, periodicCrackIntervalMs:10000, pressureRate:0.5, advance:swipe-up (gated), handlerType:'freeplay'

  **data/tutorialSteps.ts (full rewrite):**
  All 15 messages with garble brackets and keywords, exactly as in Tutorial3.md:

  A1: "[Your] Operator training [begins now]. Drag [the] periscope down [to] start." — keywords: Operator, training, periscope
  B1: "[The] extruder drops goop into [the] tank." — keywords: goop, tank
  B2: "[Yeah.] It's slow. Swipe down or [press] S [to] fast-drop." — keywords: slow, Swipe, S, fast-drop
  B3: "Rotate [with] Q/E or tap [the] left/right [side of the] tank." — keywords: Rotate, Q/E, tap, left/right, tank
  B4: "[Do it] again." — keywords: (none)
  C1: "Pressure [builds] over time." — keywords: Pressure
  C2: "Tap goop below [the] pressure [line] to pop [it]." — keywords: Tap, goop, pressure, pop
  C3: "Same-color goop merges. Bigger [blobs] vent more. [Fresh goop] needs a moment to set." — keywords: goop, merges, Bigger, vent, set
  C4: "Pop [it]." — keywords: Pop
  D1: "Cracks [form in the] tank [wall]. Drop matching [color] goop [on them] to seal." — keywords: Cracks, tank, goop, seal
  D2: "Swipe left/right [or] A/D [to] spin [the] tank." — keywords: Swipe, left/right, A/D, spin, tank
  D3: "[You] only see 1/3 [of the] tank. Cracks [can] spawn anywhere." — keywords: tank, Cracks
  E1: "Pop [the] goop [to] seal the crack." — keywords: Pop, goop, seal, crack
  E2: "Cracks [spawn] higher as [the] pressure builds. Stack goop [to] reach [them]." — keywords: Cracks, pressure, goop, reach
  F1: "[That] covers [the] basics. Don't [let the] goop [pile] too high." — keywords: basics, goop, high

  **F1 ending messages (same as v2):**
  PRESSURE_CAP: "[I've] stopped [the] pressure [so you can] practice. Swipe up [to] leave training."
  OVERFLOW: "[You] overflowed [the] tank! Training [is] over. Swipe up [to] end."

  **D2 retry message:**
  D2_RETRY: "Try again! Spin [the] tank [to] align [the] goop with [the] crack."

  **Helper functions:** Keep getNextTrainingStep, isTrainingComplete, getPhaseSteps, getTrainingStep.

  **What to avoid:**
  - Do NOT change message text unless Tutorial3.md specifies different text
  - Do NOT add extra steps beyond the 15 specified
  - Do NOT add config fields that aren't used by any step
  </action>
  <verify>
  - `npm run test:run` passes
  - TypeScript compiles without errors
  - 15 steps in TRAINING_SEQUENCE array
  - getNextTrainingStep returns steps in correct order
  - All messages have correct garble brackets and keywords
  </verify>
  <done>
  - trainingScenarios.ts has 15 step configs matching Tutorial3.md exactly
  - tutorialSteps.ts has all messages, keywords, retry messages, F1 endings
  - Helper functions work correctly
  - All steps have correct handlerType assigned
  - TypeScript compiles, tests pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] TypeScript compiles without errors
- [ ] 15 step configs match Tutorial3.md specification
- [ ] State machine has 5 lifecycle states
- [ ] Timeout pool tracks/clears named timeouts
- [ ] Handler registry returns correct handler per step
- [ ] Standard handler covers patterns 1-5
</verification>

<success_criteria>
- Tutorial framework architecture is in place (state machine, timeout pool, handler registry)
- All 15 step configs written and type-safe
- Standard handler implements reusable patterns
- Custom handler stubs exist for plan 33-07
- Module split is clean (no 1400-line files)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/33-rank-0-training-sequence/33-06-SUMMARY.md`
</output>
