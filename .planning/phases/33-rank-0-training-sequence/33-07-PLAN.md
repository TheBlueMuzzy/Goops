---
phase: 33-rank-0-training-sequence
plan: 07
type: execute
---

<objective>
Implement the four custom step handlers (D2 retry, D3 discovery, E1 continuous+seal, F1 freeplay), wire the new tutorial system into Game.tsx and UI components, remove old v2 code, and verify with a full playthrough.

Purpose: Complete the Tutorial v3 rewrite by adding the complex step behaviors and connecting everything to the game UI.

Output: Fully functional tutorial from A1 to F1, verified by manual playthrough.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/Tutorial3.md (Sections 5-7: Step Spec, Patterns, D3 Discovery)
@.planning/PROJECT.md
@.planning/ROADMAP.md
@hooks/tutorial/handlers.ts (from plan 33-06 — custom handler stubs)
@hooks/tutorial/stateMachine.ts (from plan 33-06)
@hooks/tutorial/timeoutPool.ts (from plan 33-06)
@hooks/useTrainingFlow.ts (from plan 33-06 — orchestrator)
@Game.tsx
@components/GameBoard.tsx
@components/TutorialOverlay.tsx
@hooks/useInputHandlers.ts
@core/events.ts (CRACK_OFFSCREEN from plan 33-05)

**Custom handlers needed (from Tutorial3.md):**

**D2 Retry Handler (Pattern 7):**
- On piece land without crack sealed → keep old cracks, add new green crack near bottom (row 1-2), spawn new green 2x2, show retry message
- Accumulating cracks make success inevitable
- On GOAL_CAPTURED (crack plugged) → standard hint pattern (wait 3s, show pop message if needed)
- On crack sealed (popped) → advance

**D3 Discovery Handler (Pattern 8):**
- Persistent listener across steps D2, E1, E2, F1
- Listens for CRACK_OFFSCREEN event (from plan 33-05)
- Fires ONCE: pause, show D3 message, player acknowledges, mark complete permanently
- Doesn't affect current step progression (interrupt-and-resume)

**E1 Continuous Handler:**
- Continuous spawn active, pieces keep coming
- On GOAL_CAPTURED (crack plugged): suppress spawn, freeze falling
- Standard hint pattern: wait 3s, if no pop → show "Pop to seal" (non-dismissible), pause pressure, green highlight
- If player pops before 3s → skip message
- On pop → crack sealed → advance to E2

**F1 Freeplay Handler:**
- After graduation message dismiss → free play (continuous spawn + periodic cracks)
- Pressure cap at 95%: freeze pressure, show non-dismissible ending message, enable swipe-up
- Re-cap cycle: if player pops below 95% → resume pressure → re-cap when 95% hit again
- Overflow: GAME_OVER → freeze everything, show overflow message, enable swipe-up
- On swipe-up → exit training → console, set rank 0→1 (only if rank is 0)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement four custom step handlers</name>
  <files>hooks/tutorial/handlers.ts, hooks/tutorial/retryHandler.ts (new), hooks/tutorial/discoveryHandler.ts (new), hooks/tutorial/continuousHandler.ts (new), hooks/tutorial/freeplayHandler.ts (new)</files>
  <action>
  Each custom handler implements the `StepHandler` interface from plan 33-06 and uses the shared timeout pool and state machine.

  **retryHandler.ts (D2_TANK_ROTATION):**
  - Listen for GOAL_CAPTURED → set flag `crackPluggedThisCycle = true`
  - Listen for PIECE_DROPPED → deferred check (next tick):
    - If crackPluggedThisCycle: crack was plugged. Use standard hint pattern (hintDelay from config). Wait 3s, if no pop → show hint, pause pressure. Pop → advance.
    - If NOT plugged (piece missed): RETRY sequence:
      a. Keep all existing cracks (do NOT remove)
      b. Spawn new green crack near bottom (row 1 or 2, visible area)
      c. Spawn new green 2x2 piece
      d. Show retry message (D2_RETRY from tutorialSteps.ts)
      e. Retry sequence uses timeout pool (named: 'retry-spawn', 'retry-message')
  - Reset crackPluggedThisCycle flag on each new piece spawn
  - All timeouts via pool — automatic cleanup on step change

  **discoveryHandler.ts (D3_OFFSCREEN):**
  - Does NOT manage a step directly — it's a cross-step listener
  - Activated during steps: D2, E1, E2, F1 (any step after D1 with cracks)
  - Listens for CRACK_OFFSCREEN event (from plan 33-05)
  - On event fire, check if D3 already completed (in completedSteps). If completed, ignore.
  - If not completed: interrupt current step → pause → show D3 message → player acknowledges → mark D3 + WRAP_INTRO complete → resume current step
  - The interrupt does NOT advance the current step — it just shows a message and returns
  - After firing once, remove listener permanently (never fires again this session)
  - Must be wired into the main orchestrator (useTrainingFlow) as a parallel listener, not as a step handler

  **continuousHandler.ts (E1_SEAL_CRACK):**
  - Start continuous spawn cycle: PIECE_DROPPED → deferred → spawn next after 300ms
  - Uses timeout pool ('spawn-delay', 'spawn-next') — automatic cleanup
  - On GOAL_CAPTURED (crack plugged):
    - Suppress continuous spawn (stop the cycle)
    - Freeze falling pieces
    - Start hint timer (hintDelay: 3000ms from config):
      - If player pops within 3s → skip message, advance to E2
      - If 3s passes → show "Pop to seal" message (non-dismissible), pause pressure, green highlight
      - If player pops after message → close message, advance to E2
  - Safety: autoSkipMs: 90000
  - All timeouts via pool

  **freeplayHandler.ts (F1_GRADUATION):**
  - After graduation message dismiss → start free play:
    - Start continuous spawn cycle
    - Start periodic crack spawner (periodicCrackIntervalMs: 10000)
    - Resume pressure at normal rate (0.5)
  - Pressure cap watcher (pressureCap: 0.95):
    - Poll pressure every 250ms via pool.setInterval('pressure-cap-poll')
    - When PSI >= 0.95: freeze pressure, show non-dismissible PRESSURE_CAP message, enable swipe-up
    - On player pop (drops below 0.95): resume pressure, hide message, disable swipe-up
    - On re-cap (hits 0.95 again): repeat cycle
  - Overflow watcher:
    - Listen for GAME_OVER event
    - Freeze everything (pause, freeze falling, freeze pressure)
    - Show non-dismissible OVERFLOW message, enable swipe-up
  - Swipe-up handler:
    - Listen for INPUT_SWIPE_UP, gated on ending state ('pressure-cap' or 'overflow')
    - On swipe-up: exit training → return to console screen
    - If current rank is 0 → set rank to 1
    - If current rank > 0 (replay) → do NOT change rank
  - All timers/intervals via pool

  **What to avoid:**
  - Do NOT embed custom logic in the main useTrainingFlow effect — keep handlers self-contained
  - Do NOT use generation counters — timeout pool handles cleanup
  - Do NOT hardcode delays — read from step config (hintDelay, autoSkipMs, etc.)
  - Do NOT modify the state machine — handlers call its transition functions
  </action>
  <verify>
  - `npm run test:run` passes
  - TypeScript compiles without errors
  - Each handler file is under 150 lines (keep focused)
  - All handlers use timeout pool (no raw setTimeout/setInterval)
  - Discovery handler is a parallel listener, not a step handler
  </verify>
  <done>
  - retryHandler: D2 retry with accumulating cracks, hint after plug
  - discoveryHandler: cross-step CRACK_OFFSCREEN listener, fires once
  - continuousHandler: E1 continuous spawn + GOAL_CAPTURED + hint pattern
  - freeplayHandler: F1 free play + pressure cap cycle + overflow + swipe-up exit
  - All handlers use shared timeout pool and state machine
  - Each handler is self-contained with setup() and cleanup()
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire into Game.tsx, UI components, and remove old v2 code</name>
  <files>Game.tsx, components/GameBoard.tsx, components/TutorialOverlay.tsx, hooks/useInputHandlers.ts, core/GameEngine.ts</files>
  <action>
  **Game.tsx integration:**
  - Import new useTrainingFlow (should expose same interface as v2)
  - Verify all training props flow correctly: isInTraining, trainingStep, completedStepIds, trainingDisplayStep, trainingAdvance, trainingDismiss, trainingMessagePosition, trainingHighlightColor, trainingCanDismiss, advanceType
  - Remove any v2-specific workarounds or conditional logic
  - Dev jump buttons: update step IDs to match v3 (15 steps, new E2_SCAFFOLDING ID)

  **GameBoard.tsx:**
  - Training highlight pulse should work unchanged (CSS class on color group)
  - Verify disableSwap and disablePop props still flow correctly
  - No changes needed if prop interface is preserved

  **TutorialOverlay.tsx:**
  - Should work unchanged — receives activeStep, callbacks, position, buttons
  - Verify fade in/out transitions still work with new state machine timing

  **useInputHandlers.ts:**
  - Should work unchanged — receives trainingHighlightColor, disablePop, disableSwap
  - Verify shake animation on wrong-color pop still works

  **GameEngine.ts cleanup:**
  - Remove [LOCK] and [E1] debug logging from v2 round 11
  - Verify trainingConfig properties are set correctly by new useTrainingFlow
  - If plan 33-05 added trainingConfig bundle: verify new hook sets it properly
  - If not bundled yet: keep individual properties, ensure new hook sets them all

  **Remove old v2 artifacts:**
  - Delete any v2-only refs, helpers, or workarounds that are no longer used
  - Clean up imports
  - Verify no dead code remains

  **What to avoid:**
  - Do NOT change GameBoard rendering logic — only verify props flow
  - Do NOT change TutorialOverlay — only verify it receives correct data
  - Do NOT change useInputHandlers — only verify training props work
  - Do NOT remove TrainingHUD.tsx even if unused — leave for potential future use
  </action>
  <verify>
  - `npm run test:run` passes all tests
  - `npm run dev -- --host` starts without errors
  - TypeScript compiles clean (no unused imports, no type errors)
  - No console errors on page load
  - Training mode activates when rank is 0
  </verify>
  <done>
  - Game.tsx wired to new useTrainingFlow
  - All UI components receive correct training props
  - Debug logging removed from GameEngine
  - Old v2 workarounds removed
  - Dev server runs cleanly
  - No dead code or unused imports
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Tutorial v3 — 15 steps across 6 phases with new architecture</what-built>
  <how-to-verify>
    **Setup:** Set rank to 0 in save data (or clear localStorage). Start dev server.

    **Phase A — Enter the Tank:**
    1. A1: Console screen, message about training. Drag periscope down → enters tank.

    **Phase B — Goop Basics:**
    2. B1: Blue I-piece falls automatically. Message about goop. Piece reaches ~25% → advances to B2.
    3. B2: Same piece still falling. "It's slow" message. Fast-drop enabled. Swipe down → piece lands → advance.
    4. B3: Yellow T-piece spawns. Falls 1.2s then pauses. Rotation message. Dismiss → rotate + drop → lands → advance.
    5. B4: Blue 2x2 spawns. Immediate pause. "Do it again." Dismiss → drop → lands → advance.

    **Phase C — Pressure & Popping:**
    6. C1: Pressure message. Dismiss → pressure rises fast (2.5x). Water covers yellow goop → auto-advance.
    7. C2: Yellow pulses. "Tap goop to pop." Pop yellow → advance. If dismiss without popping, hint reshows after 3s (non-dismissible), pressure pauses.
    8. C3: Wait 1.5s (pop animation). Pause + merge/solidify message. Tap → advance.
    9. C4: Wait 2s, then "Pop it." Blue pulses. Pop blue → advance. Same hint reshow as C2.

    **Phase D — Cracks & Tank Rotation:**
    10. D1: Green crack spawns at bottom. Wait 2.5s, pause + crack message. Tap → advance.
    11. D2: Green 2x2 spawns. At row 8 → pause + rotation message. Dismiss → rotate tank + seal crack (cover + pop). If miss: old cracks stay, new crack near bottom, new piece, retry message. Cracks accumulate.
    12. D3: May trigger during D2 or later. When offscreen arrow appears → pause + "only see 1/3" message. Tap → D3 complete. Fires ONCE.

    **Phase E — Scaffolding:**
    13. E1: Green crack at pressure line (high). Continuous spawn. Stack up, cover crack. After crack plugged: wait 3s. If pop before 3s → skip message → E2. If 3s passes → "Pop to seal" (non-dismissible), pressure pauses, green highlight. Pop → advance.
    14. E2: Wait 1.5s. Pause + scaffolding strategy message. Tap → advance.

    **Phase F — Graduation:**
    15. F1: Wait 2s. Graduation message. Dismiss → free play (continuous pieces, cracks every 10s, pressure at normal). At 95% pressure → "I've stopped the pressure. Swipe up to leave." Swipe up → console, rank set to 1.
    16. Verify: If you pop during pressure cap → pressure drops → resumes → re-caps at 95% → same message.
    17. Verify: If you overflow → "Training is over. Swipe up to end." → console, rank set to 1.

    **Edge cases:**
    - Wrong-color pop attempts should shake the blob
    - D3 should fire only once ever (even across multiple steps)
    - F1 exit should NOT show game-over screen
    - Rank should be 1 after training (check console/settings)
  </how-to-verify>
  <resume-signal>Type "approved" to complete the plan, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test:run` passes all tests
- [ ] Full A1→F1 playthrough completes without bugs
- [ ] All 15 steps work as specified in Tutorial3.md
- [ ] D3 discovery fires exactly once
- [ ] F1 pressure cap cycle works (cap → pop → resume → re-cap)
- [ ] F1 overflow ending works
- [ ] F1 exit returns to console with rank 1
- [ ] No console errors during playthrough
</verification>

<success_criteria>
- All 4 custom handlers implemented and working
- Game.tsx integration complete
- Old v2 code removed
- Full playthrough verified by user
- Tutorial v3 is complete
</success_criteria>

<output>
After completion, create `.planning/phases/33-rank-0-training-sequence/33-07-SUMMARY.md`

If all plans (05-07) are complete and verified:
- Phase 33 is DONE
- Update ROADMAP.md: Phase 33 status → Complete
- Update STATE.md: Move to Phase 34
</output>
