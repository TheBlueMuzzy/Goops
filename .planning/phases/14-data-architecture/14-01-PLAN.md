---
phase: 14-data-architecture
plan: 01
type: execute
---

<objective>
Restructure the upgrade system data to support v1.2 progression with 17 upgrades across 4 bands.

Purpose: The current upgrade system has 8 upgrades with 5 levels each. V1.2 needs 17 upgrades with varying level counts (mostly 4, some 1, one has 8) and a new 'feature' type.
Output: Updated types.ts and constants.ts with v1.2 upgrade schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@types.ts (UpgradeType, UpgradeConfig interfaces)
@constants.ts (UPGRADES object)

**Design source:**
The v1.2 upgrade design comes from discuss-milestone session. Key changes:
- 17 total upgrades (was 8)
- Three types: passive, active, feature (was: passive, active)
- Most passives are 4 levels (was 5)
- All actives are 1 level (was varying)
- Features are 1 level (new type)
- Pressure Control is 8 levels (special case)

**Level effects defined in planning session:**
| Upgrade | Levels | Effect |
|---------|--------|--------|
| Circuit Stabilizer | 4 | -7.5% trigger chance per level |
| Auto-Popper | 4 | -4% decay rate per level (from -20% base) |
| Capacitor Efficiency | 4 | -6.25% drain per level |
| Gear Lubrication | 4 | +12.5% dissipation per level |
| Focus Mode | 4 | -10% time speed per level |
| Dense Goop | 4 | +12.5% fall speed per level |
| Pressure Control | 8 | +5 seconds per level |
| Junk Uniformer | 4 | +10% same-color chance per level |
| Goop Swap | 4 | -0.25s swap time per level (1.5s base, 0.5s min) |
| Sealing Bonus | 4 | +5% crack-seal bonus per level (10% base) |
| Slow Cracks | 4 | -5% growth chance offset per level |
| Crack Matcher | 4 | +25% color bias per level |

**Mechanic note for Sealing Bonus:**
V1.2 redesigns active charging: Actives have cooldowns. Sealing a crack = 10% base reduction to all active cooldowns. This upgrade adds +5% per level. Config sets up values; mechanic implementation is in later phases.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update UpgradeType to include 'feature'</name>
  <files>types.ts</files>
  <action>
In types.ts, find the UpgradeType definition (around line 190):
```typescript
export type UpgradeType = 'passive' | 'active';
```

Update to:
```typescript
export type UpgradeType = 'passive' | 'active' | 'feature';
```

No other changes needed to UpgradeConfig interface - it already supports all needed fields.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>UpgradeType includes 'passive', 'active', and 'feature'</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite UPGRADES with v1.2 schema</name>
  <files>constants.ts</files>
  <action>
Replace the entire UPGRADES object (lines ~39-161) with the v1.2 upgrade definitions.

**Important changes from v1.0:**
- LASER renamed to CAPACITOR_EFFICIENCY, unlock rank 4 (was 1)
- LIGHTS renamed to CIRCUIT_STABILIZER, unlock rank 2 (unchanged)
- CONTROLS renamed to GEAR_LUBRICATION, unlock rank 6 (was 3)
- AUTO_POPPER unlock rank 3 (was 4), new decay formula
- COOLDOWN_BOOSTER unlock rank 5 (unchanged), now 1 level
- JUNK_UNIFORMITY renamed to JUNK_UNIFORMER, unlock rank 10 (unchanged)
- GOOPER renamed to GOOP_DUMP, unlock rank 15 (unchanged), now 1 level
- ACTIVE_SLOT_2 renamed to ACTIVE_EXPANSION_SLOT, unlock rank 20 (unchanged)

**New upgrades to add:**
- FOCUS_MODE: rank 7, passive, 4 levels
- DENSE_GOOP: rank 8, passive, 4 levels
- PRESSURE_CONTROL: rank 9, passive, 8 levels
- GOOP_SWAP: rank 12, passive, 4 levels
- SEALING_BONUS: rank 18, passive, 4 levels
- GOOP_HOLD_VIEWER: rank 22, feature, 1 level
- GOOP_COLORIZER: rank 25, active, 1 level
- GOOP_WINDOW: rank 28, feature, 1 level
- SLOW_CRACKS: rank 30, passive, 4 levels
- CRACK_MATCHER: rank 32, passive, 4 levels
- CRACK_DOWN: rank 35, active, 1 level
- ACTIVE_EXPANSION_SLOT_2: rank 38, feature, 1 level

**Full UPGRADES object to write:**

```typescript
export const UPGRADES = {
  // === ONBOARDING BAND (Ranks 0-9) ===

  CIRCUIT_STABILIZER: {
    id: 'CIRCUIT_STABILIZER',
    name: 'Circuit Stabilizer',
    desc: 'Reduces probability of lights malfunction triggering.',
    type: 'passive' as const,
    unlockRank: 2,
    costPerLevel: 1,
    maxLevel: 4,
    effectPerLevel: 0.075, // -7.5% trigger chance per level
    formatEffect: (lvl: number) => `-${(lvl * 7.5).toFixed(1)}% Trigger Chance`,
    maxLevelBonus: '3-button sequence instead of 4'
  },

  AUTO_POPPER: {
    id: 'AUTO_POPPER',
    name: 'Auto-Popper',
    desc: 'At end of game, remaining goop has a chance to auto-pop before penalty.',
    type: 'passive' as const,
    unlockRank: 3,
    costPerLevel: 1,
    maxLevel: 4,
    // Base decay: -20% per unit. Each level reduces decay by 4% (20, 16, 12, 8, 4)
    effectPerLevel: 0.04,
    formatEffect: (lvl: number) => `-${20 - lvl * 4}% decay per unit`,
    maxLevelBonus: undefined
  },

  CAPACITOR_EFFICIENCY: {
    id: 'CAPACITOR_EFFICIENCY',
    name: 'Capacitor Efficiency',
    desc: 'Reduces laser capacitor drain rate when popping goop.',
    type: 'passive' as const,
    unlockRank: 4,
    costPerLevel: 1,
    maxLevel: 4,
    effectPerLevel: 0.0625, // -6.25% drain per level
    formatEffect: (lvl: number) => `-${(lvl * 6.25).toFixed(2)}% Drain Rate`,
    maxLevelBonus: 'No center targets in Reset Laser puzzle'
  },

  COOLDOWN_BOOSTER: {
    id: 'COOLDOWN_BOOSTER',
    name: 'Cooldown Booster',
    desc: 'When activated, extends all active malfunction cooldowns.',
    type: 'active' as const,
    unlockRank: 5,
    costPerLevel: 1,
    maxLevel: 1,
    chargeCost: 8, // Legacy - will be replaced by cooldown system
    effectPerLevel: 0.25, // +25% cooldown extension when activated
    formatEffect: () => '+25% Cooldown Extension',
    maxLevelBonus: undefined
  },

  GEAR_LUBRICATION: {
    id: 'GEAR_LUBRICATION',
    name: 'Gear Lubrication',
    desc: 'Increases heat dissipation rate when idle.',
    type: 'passive' as const,
    unlockRank: 6,
    costPerLevel: 1,
    maxLevel: 4,
    effectPerLevel: 0.125, // +12.5% dissipation per level
    formatEffect: (lvl: number) => `+${(lvl * 12.5).toFixed(1)}% Heat Dissipation`,
    maxLevelBonus: '3 alignments instead of 4'
  },

  FOCUS_MODE: {
    id: 'FOCUS_MODE',
    name: 'Focus Mode',
    desc: 'Time slows while at the console viewing minigames.',
    type: 'passive' as const,
    unlockRank: 7,
    costPerLevel: 1,
    maxLevel: 4,
    effectPerLevel: 0.10, // -10% time speed per level
    formatEffect: (lvl: number) => `-${lvl * 10}% Time Speed`,
    maxLevelBonus: undefined
  },

  DENSE_GOOP: {
    id: 'DENSE_GOOP',
    name: 'Dense Goop',
    desc: 'Goop falls faster. Can add or remove points via respec.',
    type: 'passive' as const,
    unlockRank: 8,
    costPerLevel: 1,
    maxLevel: 4,
    effectPerLevel: 0.125, // +12.5% fall speed per level
    formatEffect: (lvl: number) => `+${(lvl * 12.5).toFixed(1)}% Fall Speed`,
    maxLevelBonus: undefined
  },

  PRESSURE_CONTROL: {
    id: 'PRESSURE_CONTROL',
    name: 'Pressure Control',
    desc: 'Extends time before pressure reaches 100%.',
    type: 'passive' as const,
    unlockRank: 9,
    costPerLevel: 1,
    maxLevel: 8,
    effectPerLevel: 5, // +5 seconds per level
    formatEffect: (lvl: number) => `+${lvl * 5}s Game Time`,
    maxLevelBonus: undefined
  },

  // === JUNK BAND (Ranks 10-19) ===

  JUNK_UNIFORMER: {
    id: 'JUNK_UNIFORMER',
    name: 'Junk Uniformer',
    desc: 'Starting junk is more likely to be the same color.',
    type: 'passive' as const,
    unlockRank: 10,
    costPerLevel: 1,
    maxLevel: 4,
    effectPerLevel: 0.10, // +10% same-color chance per level
    formatEffect: (lvl: number) => `+${lvl * 10}% Same Color`,
    maxLevelBonus: undefined
  },

  GOOP_SWAP: {
    id: 'GOOP_SWAP',
    name: 'Goop Swap',
    desc: 'Swap falling goop with stored goop faster.',
    type: 'passive' as const,
    unlockRank: 12,
    costPerLevel: 1,
    maxLevel: 4,
    // Base: 1.5s, -0.25s per level, min 0.5s
    effectPerLevel: 0.25, // seconds reduced per level
    formatEffect: (lvl: number) => `${(1.5 - lvl * 0.25).toFixed(2)}s Swap Time`,
    maxLevelBonus: undefined
  },

  GOOP_DUMP: {
    id: 'GOOP_DUMP',
    name: 'Goop Dump',
    desc: 'When activated, drops same-color junk across the entire board.',
    type: 'active' as const,
    unlockRank: 15,
    costPerLevel: 1,
    maxLevel: 1,
    chargeCost: 12, // Legacy - will be replaced by cooldown system
    effectPerLevel: 1,
    formatEffect: () => 'Drops matching junk',
    maxLevelBonus: undefined
  },

  SEALING_BONUS: {
    id: 'SEALING_BONUS',
    name: 'Sealing Bonus',
    desc: 'Sealing cracks reduces active cooldowns more.',
    type: 'passive' as const,
    unlockRank: 18,
    costPerLevel: 1,
    maxLevel: 4,
    // Base: 10% cooldown reduction per sealed crack. +5% per level.
    effectPerLevel: 0.05, // +5% bonus per level
    formatEffect: (lvl: number) => `${10 + lvl * 5}% Cooldown per Seal`,
    maxLevelBonus: undefined
  },

  // === MIXER BAND (Ranks 20-29) ===

  ACTIVE_EXPANSION_SLOT: {
    id: 'ACTIVE_EXPANSION_SLOT',
    name: 'Active Expansion Slot',
    desc: 'Allows equipping a second active ability simultaneously.',
    type: 'feature' as const,
    unlockRank: 20,
    costPerLevel: 1,
    maxLevel: 1,
    effectPerLevel: 1,
    formatEffect: () => '2 Active Slots',
    maxLevelBonus: undefined
  },

  GOOP_HOLD_VIEWER: {
    id: 'GOOP_HOLD_VIEWER',
    name: 'Goop Hold Viewer',
    desc: 'Shows the goop currently in holding.',
    type: 'feature' as const,
    unlockRank: 22,
    costPerLevel: 1,
    maxLevel: 1,
    effectPerLevel: 1,
    formatEffect: () => 'View Held Goop',
    maxLevelBonus: undefined
  },

  GOOP_COLORIZER: {
    id: 'GOOP_COLORIZER',
    name: 'Goop Colorizer',
    desc: 'When activated, next 5 goop are same color as current falling goop.',
    type: 'active' as const,
    unlockRank: 25,
    costPerLevel: 1,
    maxLevel: 1,
    chargeCost: 10, // Will be replaced by cooldown system
    effectPerLevel: 1,
    formatEffect: () => 'Next 5 goop match',
    maxLevelBonus: undefined
  },

  GOOP_WINDOW: {
    id: 'GOOP_WINDOW',
    name: 'Goop Window',
    desc: 'Shows you the next goop piece.',
    type: 'feature' as const,
    unlockRank: 28,
    costPerLevel: 1,
    maxLevel: 1,
    effectPerLevel: 1,
    formatEffect: () => 'Preview Next Goop',
    maxLevelBonus: undefined
  },

  // === CRACKED BAND (Ranks 30-39) ===

  SLOW_CRACKS: {
    id: 'SLOW_CRACKS',
    name: 'Slow Cracks',
    desc: 'Cracks grow slower over time.',
    type: 'passive' as const,
    unlockRank: 30,
    costPerLevel: 1,
    maxLevel: 4,
    // Offset to growth chance: -5%, -10%, -15%, -20%
    effectPerLevel: 0.05, // -5% growth chance offset per level
    formatEffect: (lvl: number) => `-${lvl * 5}% Growth Chance`,
    maxLevelBonus: undefined
  },

  CRACK_MATCHER: {
    id: 'CRACK_MATCHER',
    name: 'Crack Matcher',
    desc: 'Falling goop color biased toward the lowest crack.',
    type: 'passive' as const,
    unlockRank: 32,
    costPerLevel: 1,
    maxLevel: 4,
    effectPerLevel: 0.25, // +25% color bias per level
    formatEffect: (lvl: number) => `${lvl * 25}% Match Chance`,
    maxLevelBonus: undefined
  },

  CRACK_DOWN: {
    id: 'CRACK_DOWN',
    name: 'Crack Down',
    desc: 'When activated, new cracks form on the bottom row for a while.',
    type: 'active' as const,
    unlockRank: 35,
    costPerLevel: 1,
    maxLevel: 1,
    chargeCost: 10, // Will be replaced by cooldown system
    effectPerLevel: 1,
    formatEffect: () => 'Cracks spawn low',
    maxLevelBonus: undefined
  },

  ACTIVE_EXPANSION_SLOT_2: {
    id: 'ACTIVE_EXPANSION_SLOT_2',
    name: 'Active Expansion Slot',
    desc: 'Allows equipping a third active ability simultaneously.',
    type: 'feature' as const,
    unlockRank: 38,
    costPerLevel: 1,
    maxLevel: 1,
    effectPerLevel: 1,
    formatEffect: () => '3 Active Slots',
    maxLevelBonus: undefined
  }
};
```

Also update the helper functions if needed (getPassiveUpgrades, getActiveUpgrades) to handle the new 'feature' type. Add:

```typescript
export const getFeatureUpgrades = () =>
  Object.values(UPGRADES).filter(u => u.type === 'feature');
```

Keep the backwards compatibility aliases at the end:
```typescript
export const UPGRADE_CONFIG = UPGRADES;
export const SYSTEM_UPGRADE_CONFIG = UPGRADES;
```
  </action>
  <verify>
1. TypeScript compiles: `npx tsc --noEmit`
2. Tests pass: `npm run test:run`
  </verify>
  <done>
- UPGRADES object contains all 17 v1.2 upgrades
- Each upgrade has correct: id, name, desc, type, unlockRank, costPerLevel, maxLevel, effectPerLevel, formatEffect
- Helper function getFeatureUpgrades exists
- All existing tests still pass
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test:run` passes (all 110 tests)
- [ ] UPGRADES object has exactly 17 entries
- [ ] Types include 'feature' as UpgradeType
</verification>

<success_criteria>
- UpgradeType includes 'passive', 'active', 'feature'
- UPGRADES contains all 17 v1.2 upgrades with correct values
- All tests pass
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-data-architecture/14-01-SUMMARY.md`
</output>
